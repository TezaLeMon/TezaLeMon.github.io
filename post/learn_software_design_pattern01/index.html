<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.90.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>设计模式学习笔记[01] 面向对象&amp;设计原则 &middot; Teza小站</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://TezaLeMon.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://TezaLeMon.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://TezaLeMon.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://TezaLeMon.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">

<link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.1/styles/atom-one-dark.min.css" rel="stylesheet">

<style>
  pre {
     
    white-space: pre;
    word-wrap: normal;
  }

  svg {
    display: block;
    margin: auto;
  }
</style>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../../apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="../../favicon.png">

  
  
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>


<body class="theme-base-0c ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://TezaLeMon.github.io/"><h1>Teza小站</h1></a>
      <p class="lead">
       无名小站，始于2020-7-14，记录某大学仔学习历程。 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://TezaLeMon.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>Copyright (c) 2020, Guanda Wei</p>
  </div>
</aside>

  <main class="content container">
    <div class="post">
  <h1>设计模式学习笔记[01] 面向对象&amp;设计原则</h1>
  <time datetime=2022-08-01T14:39:29&#43;0800 class="post-date">Mon, Aug 1, 2022</time>
  <p>本笔记内容源于王争的《设计模式之美》课程。</p>
<h1 id="零导读">零、导读</h1>
<h2 id="评价代码质量">评价代码质量</h2>
<p>实际上，咱们平时嘴中常说的“好”和“烂”，是对代码质量的一种描述。“好”笼统地表示代码质量高，“烂”笼统地表示代码质量低。对于代码质量的描述，除了“好”“烂”这样比较简单粗暴的描述方式之外，我们也经常会听到很多其他的描述方式。这些描述方法语义更丰富、更专业、更细化。</p>
<blockquote>
<p>灵活性（flexibility）、可扩展性（extensibility）、可维护性（maintainability）、可读性（readability）、可理解性（understandability）、易修改性（changeability）、可复用（reusability）、可测试性（testability）、模块化（modularity）、高内聚低耦合（high cohesion loose coupling）、高效（high effciency）、高性能（high performance）、安全性（security）、兼容性（compatibility）、易用性（usability）、整洁（clean）、清晰（clarity）、简单（simple）、直接（straightforward）、少即是多（less code is more）、文档详尽（well-documented）、分层清晰（well-layered）、正确性（correctness、bug free）、健壮性（robustness）、鲁棒性（robustness）、可用性（reliability）、可伸缩性（scalability）、稳定性（stability）、优雅（elegant）、好（good）、坏（bad）……</p>
</blockquote>
<p>实际上，我们很难通过其中的某个或者某几个词汇来全面地评价代码质量。因为这些词汇都是从不同维度来说的。</p>
<h2 id="最常用的几个评价标准">最常用的几个评价标准</h2>
<h3 id="可维护性maintainability">可维护性（maintainability）</h3>
<p>落实到编码开发，所谓的“维护”无外乎就是修改bug、修改老的代码、添加新的代码之类的工作。所谓“代码易维护”就是指，在不破坏原有代码设计、不引入新的bug的情况下，能够快速地修改或者添加代码。所谓“代码不易维护”就是指，修改或者添加代码需要冒着极大的引入新bug的风险，并且需要花费很长的时间才能完成。</p>
<p>实际上，可维护性也是一个很难量化、偏向对代码整体的评价标准，它有点类似之前提到的“好”“坏”“优雅”之类的笼统评价。代码的可维护性是由很多因素协同作用的结果。代码的可读性好、简洁、可扩展性好，就会使得代码易维护；相反，就会使得代码不易维护。更细化地讲，如果代码分层清晰、模块化好、高内聚低耦合、遵从基于接口而非实现编程的设计原则等等，那就可能意味着代码易维护。除此之外，代码的易维护性还跟项目代码量的多少、业务的复杂程度、利用到的技术的复杂程度、文档是否全面、团队成员的开发水平等诸多因素有关。</p>
<h3 id="可读性readability">可读性（readability）</h3>
<p>软件设计大师Martin Fowler曾经说过：“Any fool can write code that a computer can understand. Good programmers write code that humans can understand.”翻译成中文就是：“任何傻瓜都会编写计算机能理解的代码。好的程序员能够编写人能够理解的代码。”Google内部甚至专门有个认证就叫作Readability。只有拿到这个认证的工程师，才有资格在code review的时候，批准别人提交代码。可见代码的可读性有多重要，毕竟，代码被阅读的次数远远超过被编写和执行的次数。</p>
<p>代码的可读性应该是评价代码质量最重要的指标之一。我们在编写代码的时候，时刻要考虑到代码是否易读、易理解。除此之外，代码的可读性在非常大程度上会影响代码的可维护性。毕竟，不管是修改bug，还是修改添加功能代码，我们首先要做的事情就是读懂代码。代码读不大懂，就很有可能因为考虑不周全，而引入新的bug。</p>
<p>既评价一段代码的可读性需要看代码是否符合编码规范、命名是否达意、注释是否详尽、函数是否长短合适、模块划分是否清晰、是否符合高内聚低耦合等等。你应该也能感觉到，从正面上，我们很难给出一个覆盖所有评价指标的列表。这也是我们无法量化可读性的原因。</p>
<h3 id="可扩展性extensibility">可扩展性（extensibility）</h3>
<p>代码的可扩展性表示，我们在不修改或少量修改原有代码的情况下，通过扩展的方式添加新的功能代码。说直白点就是，代码预留了一些功能扩展点，你可以把新功能代码，直接插到扩展点上，而不需要因为要添加一个功能而大动干戈，改动大量的原始代码。</p>
<h3 id="灵活性flexibility">灵活性（flexibility）</h3>
<p>实际上，灵活性是一个挺抽象的评价标准，要给灵活性下个定义也是挺难的。不过，我们可以想一下，什么情况下我们才会说代码写得好灵活呢？这里罗列了几个场景：</p>
<ul>
<li>当我们添加一个新的功能代码的时候，原有的代码已经预留好了扩展点，我们不需要修改原有的代码，只要在扩展点上添加新的代码即可。这个时候，我们除了可以说代码易扩展，还可以说代码写得好灵活。</li>
</ul>
<ul>
<li>当我们要实现一个功能的时候，发现原有代码中，已经抽象出了很多底层可以复用的模块、类等代码，我们可以拿来直接使用。这个时候，我们除了可以说代码易复用之外，还可以说代码写得好灵活。</li>
<li>当我们使用某组接口的时候，如果这组接口可以应对各种使用场景，满足各种不同的需求，我们除了可以说接口易用之外，还可以说这个接口设计得好灵活或者代码写得好灵活。</li>
</ul>
<h3 id="简洁性simplicity">简洁性（simplicity）</h3>
<p>有一条非常著名的设计原则，你一定听过，那就是KISS原则：“Keep It Simple，Stupid”。这个原则说的意思就是，尽量保持代码简单。代码简单、逻辑清晰，也就意味着易读、易维护。我们在编写代码的时候，往往也会把简单、清晰放到首位。</p>
<h3 id="可复用性reusability">可复用性（reusability）</h3>
<p>代码的可复用性可以简单地理解为，尽量减少重复代码的编写，复用已有的代码。</p>
<p>比如，当讲到面向对象特性的时候，我们会讲到继承、多态存在的目的之一，就是为了提高代码的可复用性；当讲到设计原则的时候，我们会讲到单一职责原则也跟代码的可复用性相关；当讲到重构技巧的时候，我们会讲到解耦、高内聚、模块化等都能提高代码的可复用性。可见，可复用性也是一个非常重要的代码评价标准，是很多设计原则、思想、模式等所要达到的最终效果。</p>
<p>实际上，代码可复用性跟DRY（Don’t Repeat Yourself）这条设计原则的关系挺紧密的。</p>
<h3 id="可测试性testability">可测试性（testability）</h3>
<p>相对于前面六个评价标准，代码的可测试性是一个相对较少被提及，但又非常重要的代码质量评价标准。代码可测试性的好坏，能从侧面上非常准确地反应代码质量的好坏。代码的可测试性差，比较难写单元测试，那基本上就能说明代码设计得有问题。</p>
<h1 id="一面向对象">一、面向对象</h1>
<p>面向对象编程的四大特性分别是：封装、抽象、继承、多态。</p>
<h2 id="封装encapsulation">封装（Encapsulation）</h2>
<p>封装也叫作信息隐藏或者数据访问保护。类通过暴露有限的访问接口，授权外部仅能通过类提供的方式（或者叫函数）来访问内部信息或者数据。</p>
<p>如果对类中属性的访问不做限制，那任何代码都可以访问、修改类中的属性，虽然这样看起来更加灵活，但从另一方面来说，过度灵活也意味着不可控，属性可以随意被以各种奇葩的方式修改，而且修改逻辑可能散落在代码中的各个角落，势必影响代码的可读性、可维护性。</p>
<p>除此之外，类仅仅通过有限的方法暴露必要的操作，也能提高类的易用性。如果我们把类属性都暴露给类的调用者，调用者想要正确地操作这些属性，就势必要对业务细节有足够的了解。而这对于调用者来说也是一种负担。相反，如果我们将属性封装起来，暴露少许的几个必要的方法给调用者使用，调用者就不需要了解太多背后的业务细节，用错的概率就减少很多。这就好比，如果一个冰箱有很多按钮，你就要研究很长时间，还不一定能操作正确。相反，如果只有几个必要的按钮，比如开、停、调节温度，你一眼就能知道该如何来操作，而且操作出错的概率也会降低很多。</p>
<h2 id="抽象abstraction">抽象（Abstraction）</h2>
<p>抽象讲的是如何隐藏方法的具体实现，让调用者只需要关心方法提供了哪些功能，并不需要知道这些功能是如何实现的。在面向对象编程中，我们常借助编程语言提供的接口类（比如Java中的interface关键字语法）或者抽象类（比如Java中的abstract关键字语法）这两种语法机制，来实现抽象这一特性。</p>
<p>抽象这个概念是一个非常通用的设计思想，并不单单用在面向对象编程中，也可以用来指导架构设计等。而且这个特性也并不需要编程语言提供特殊的语法机制来支持，只需要提供“函数”这一非常基础的语法机制，就可以实现抽象特性、所以，它没有很强的“特异性”，有时候并不被看作面向对象编程的特性之一。</p>
<p>实际上，如果上升一个思考层面的话，抽象及其前面讲到的封装都是人类处理复杂性的有效手段。在面对复杂系统的时候，人脑能承受的信息复杂程度是有限的，所以我们必须忽略掉一些非关键性的实现细节。而抽象作为一种只关注功能点不关注实现的设计思路，正好帮我们的大脑过滤掉许多非必要的信息。</p>
<p>除此之外，抽象作为一个非常宽泛的设计思想，在代码设计中，起到非常重要的指导作用。很多设计原则都体现了抽象这种设计思想，比如基于接口而非实现编程、开闭原则（对扩展开放、对修改关闭）、代码解耦（降低代码的耦合性）等。</p>
<h2 id="继承inheritance">继承（Inheritance）</h2>
<p>继承最大的一个好处就是代码复用。假如两个类有一些相同的属性和方法，我们就可以将这些相同的部分，抽取到父类中，让两个子类继承父类。这样，两个子类就可以重用父类中的代码，避免代码重复写多遍。不过，这一点也并不是继承所独有的，我们也可以通过其他方式来解决这个代码复用的问题，比如利用组合关系而不是继承关系。</p>
<h2 id="多态polymorphism">多态（Polymorphism）</h2>
<p>多态是指，子类可以替换父类，在实际的代码运行过程中，调用子类的方法实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DynamicArray</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_CAPACITY <span style="color:#f92672">=</span> 10<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">int</span> size <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">int</span> capacity <span style="color:#f92672">=</span> DEFAULT_CAPACITY<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">protected</span> Integer<span style="color:#f92672">[]</span> elements <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Integer<span style="color:#f92672">[</span>DEFAULT_CAPACITY<span style="color:#f92672">];</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">;</span> <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">public</span> Integer <span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> index<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> elements<span style="color:#f92672">[</span>index<span style="color:#f92672">];}</span>
  <span style="color:#75715e">//...省略n多方法...
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Integer e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ensureCapacity<span style="color:#f92672">();</span>
    elements<span style="color:#f92672">[</span>size<span style="color:#f92672">++]</span> <span style="color:#f92672">=</span> e<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ensureCapacity</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...如果数组满了就扩容...代码省略...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SortedDynamicArray</span> <span style="color:#66d9ef">extends</span> DynamicArray <span style="color:#f92672">{</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Integer e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ensureCapacity<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">int</span> i<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">=</span> size<span style="color:#f92672">-</span>1<span style="color:#f92672">;</span> i<span style="color:#f92672">&gt;=</span>0<span style="color:#f92672">;</span> <span style="color:#f92672">--</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//保证数组中的数据有序
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>elements<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">&gt;</span> e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        elements<span style="color:#f92672">[</span>i<span style="color:#f92672">+</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> elements<span style="color:#f92672">[</span>i<span style="color:#f92672">];</span>
      <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    elements<span style="color:#f92672">[</span>i<span style="color:#f92672">+</span>1<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> e<span style="color:#f92672">;</span>
    <span style="color:#f92672">++</span>size<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Example</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test</span><span style="color:#f92672">(</span>DynamicArray dynamicArray<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    dynamicArray<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>5<span style="color:#f92672">);</span>
    dynamicArray<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
    dynamicArray<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>3<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> dynamicArray<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">();</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>dynamicArray<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>i<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String args<span style="color:#f92672">[])</span> <span style="color:#f92672">{</span>
    DynamicArray dynamicArray <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SortedDynamicArray<span style="color:#f92672">();</span>
    test<span style="color:#f92672">(</span>dynamicArray<span style="color:#f92672">);</span> <span style="color:#75715e">// 打印结果：1、3、5
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>多态这种特性也需要编程语言提供特殊的语法机制来实现。在上面的例子中，用到了三个语法机制来实现多态：</p>
<ul>
<li>第一个语法机制是编程语言要支持父类对象可以引用子类对象，也就是可以将SortedDynamicArray传递给DynamicArray。</li>
<li>第二个语法机制是编程语言要支持继承，也就是SortedDynamicArray继承了DynamicArray，才能将SortedDyamicArray传递给DynamicArray。</li>
<li>第三个语法机制是编程语言要支持子类可以重写（override）父类中的方法，也就是SortedDyamicArray重写了DynamicArray中的add()方法。</li>
</ul>
<p>除了“继承加方法重写”的实现方式，还可以利用接口类实现：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Iterator</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasNext</span><span style="color:#f92672">();</span>
  String <span style="color:#a6e22e">next</span><span style="color:#f92672">();</span>
  String <span style="color:#a6e22e">remove</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Array</span> <span style="color:#66d9ef">implements</span> Iterator <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> String<span style="color:#f92672">[]</span> data<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasNext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">next</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">remove</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...省略其他方法...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LinkedList</span> <span style="color:#66d9ef">implements</span> Iterator <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> LinkedListNode head<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">hasNext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">next</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">remove</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">...</span> <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...省略其他方法... 
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Demo</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">print</span><span style="color:#f92672">(</span>Iterator iterator<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">hasNext</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>iterator<span style="color:#f92672">.</span><span style="color:#a6e22e">next</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Iterator arrayIterator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array<span style="color:#f92672">();</span>
    print<span style="color:#f92672">(</span>arrayIterator<span style="color:#f92672">);</span>
    
    Iterator linkedListIterator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> LinkedList<span style="color:#f92672">();</span>
    print<span style="color:#f92672">(</span>linkedListIterator<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>也可以用duck-typing实现多态，不过duck-typing只有一些动态语言才支持，比如Python、JavaScript等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Logger</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">record</span>(self):
        print(<span style="color:#960050;background-color:#1e0010">“</span>I write a log into file<span style="color:#f92672">.</span><span style="color:#960050;background-color:#1e0010">”</span>)
        
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DB</span>:
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">record</span>(self):
        print(<span style="color:#960050;background-color:#1e0010">“</span>I insert data into db<span style="color:#f92672">.</span> <span style="color:#960050;background-color:#1e0010">”</span>)
        
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>(recorder):
    recorder<span style="color:#f92672">.</span>record()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">demo</span>():
    logger <span style="color:#f92672">=</span> Logger()
    db <span style="color:#f92672">=</span> DB()
    test(logger)
    test(db)
</code></pre></div><p>Logger和DB两个类没有任何关系，既不是继承关系，也不是接口和实现的关系，但是只要它们都有定义了record()方法，就可以被传递到test()方法中，在实际运行的时候，执行对应的record()方法。也就是说，只要两个类具有相同的方法，就可以实现多态，并不要求两个类之间有任何关系，这就是所谓的duck-typing，是一些动态语言所特有的语法机制。</p>
<h2 id="与面向过程比较">与面向过程比较</h2>
<p>面向对象风格与面向过程风格相比有三个优点：</p>
<ol>
<li>OOP更加能够应对大规模复杂程序的开发</li>
</ol>
<p>对于简单程序的开发来说，不管是用面向过程编程风格，还是用面向对象编程风格，差别确实不会很大，甚至有的时候，面向过程的编程风格反倒更有优势。因为需求足够简单，整个程序的处理流程只有一条主线，很容易被划分成顺序执行的几个步骤，然后逐句翻译成代码，这就非常适合采用面向过程这种面条式的编程风格来实现。</p>
<p>但对于大规模复杂程序的开发来说，整个程序的处理流程错综复杂，并非只有一条主线。如果把整个程序的处理流程画出来的话，会是一个网状结构。如果我们再用面向过程编程这种流程化、线性的思维方式，去翻译这个网状结构，去思考如何把程序拆解为一组顺序执行的方法，就会比较吃力。这个时候，面向对象的编程风格的优势就比较明显了。</p>
<p>面向对象编程是以类为思考对象。在进行面向对象编程的时候，我们并不是一上来就去思考，如何将复杂的流程拆解为一个一个方法，而是采用曲线救国的策略，先去思考如何给业务建模，如何将需求翻译为类，如何给类之间建立交互关系，而完成这些工作完全不需要考虑错综复杂的处理流程。当我们有了类的设计之后，然后再像搭积木一样，按照处理流程，将类组装起来形成整个程序。这种开发模式、思考问题的方式，能让我们在应对复杂程序开发的时候，思路更加清晰。</p>
<p>除此之外，面向对象编程还提供了一种更加清晰的、更加模块化的代码组织方式。比如，我们开发一个电商交易系统，业务逻辑复杂，代码量很大，可能要定义数百个函数、数百个数据结构，那如何分门别类地组织这些函数和数据结构，才能不至于看起来比较凌乱呢？类就是一种非常好的组织这些函数和数据结构的方式，是一种将代码模块化的有效手段。</p>
<ol start="2">
<li>OOP风格的代码更易复用、易扩展、易维护</li>
</ol>
<p>面向过程编程是一种非常简单的编程风格，并没有像面向对象编程那样提供丰富的特性。而面向对象编程提供的封装、抽象、继承、多态这些特性，能极大地满足复杂的编程需求，能方便我们写出更易复用、易扩展、易维护的代码。</p>
<ol start="3">
<li>OOP语言更加人性化、更加高级、更加智能</li>
</ol>
<hr>
<p>但面向对象和面向过程两种编程风格，也并不是非黑即白、完全对立的。在用面向对象编程语言开发的软件中，面向过程风格的代码并不少见，甚至在一些标准的开发库（比如JDK、Apache Commons、Google Guava）中，也有很多面向过程风格的代码。</p>
<p>不管使用面向过程还是面向对象哪种风格来写代码，我们最终的目的还是写出易维护、易读、易复用、易扩展的高质量代码。只要我们能避免面向过程编程风格的一些弊端，控制好它的副作用，在掌控范围内为我们所用，我们就大可不用避讳在面向对象编程中写面向过程风格的代码。</p>
<h2 id="接口-vs-抽象类">接口 vs 抽象类</h2>
<h3 id="抽象类-abstract">抽象类 abstract</h3>
<p>下面这段代码是一个比较典型的抽象类的使用场景（模板设计模式）。Logger是一个记录日志的抽象类，FileLogger和MessageQueueLogger继承Logger，分别实现两种不同的日志记录方式：记录日志到文件中和记录日志到消息队列中。FileLogger和MessageQueueLogger两个子类复用了父类Logger中的name、enabled、minPermittedLevel属性和log()方法，但因为这两个子类写日志的方式不同，它们又各自重写了父类中的doLog()方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 抽象类
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Logger</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> enabled<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Level minPermittedLevel<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Logger</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> enabled<span style="color:#f92672">,</span> Level minPermittedLevel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> name<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">enabled</span> <span style="color:#f92672">=</span> enabled<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">minPermittedLevel</span> <span style="color:#f92672">=</span> minPermittedLevel<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">log</span><span style="color:#f92672">(</span>Level level<span style="color:#f92672">,</span> String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">boolean</span> loggable <span style="color:#f92672">=</span> enabled <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>minPermittedLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">intValue</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;=</span> level<span style="color:#f92672">.</span><span style="color:#a6e22e">intValue</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>loggable<span style="color:#f92672">)</span> <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    doLog<span style="color:#f92672">(</span>level<span style="color:#f92672">,</span> message<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doLog</span><span style="color:#f92672">(</span>Level level<span style="color:#f92672">,</span> String message<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// 抽象类的子类：输出日志到文件
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FileLogger</span> <span style="color:#66d9ef">extends</span> Logger <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> Writer fileWriter<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">FileLogger</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> enabled<span style="color:#f92672">,</span>
    Level minPermittedLevel<span style="color:#f92672">,</span> String filepath<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> enabled<span style="color:#f92672">,</span> minPermittedLevel<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">fileWriter</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FileWriter<span style="color:#f92672">(</span>filepath<span style="color:#f92672">);</span> 
  <span style="color:#f92672">}</span>
  
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doLog</span><span style="color:#f92672">(</span>Level level<span style="color:#f92672">,</span> String mesage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 格式化level和message,输出到日志文件
</span><span style="color:#75715e"></span>    fileWriter<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(...);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// 抽象类的子类: 输出日志到消息中间件(比如kafka)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageQueueLogger</span> <span style="color:#66d9ef">extends</span> Logger <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> MessageQueueClient msgQueueClient<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MessageQueueLogger</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> enabled<span style="color:#f92672">,</span>
    Level minPermittedLevel<span style="color:#f92672">,</span> MessageQueueClient msgQueueClient<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> enabled<span style="color:#f92672">,</span> minPermittedLevel<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">msgQueueClient</span> <span style="color:#f92672">=</span> msgQueueClient<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doLog</span><span style="color:#f92672">(</span>Level level<span style="color:#f92672">,</span> String mesage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 格式化level和message,输出到消息中间件
</span><span style="color:#75715e"></span>    msgQueueClient<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(...);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>抽象类的特性：</p>
<ul>
<li>抽象类不允许被实例化，只能被继承。也就是说，你不能new一个抽象类的对象出来（Logger logger = new Logger(&hellip;);会报编译错误）。</li>
<li>抽象类可以包含属性和方法。方法既可以包含代码实现（比如Logger中的log()方法），也可以不包含代码实现（比如Logger中的doLog()方法）。不包含代码实现的方法叫作抽象方法。</li>
<li>子类继承抽象类，必须实现抽象类中的所有抽象方法。对应到例子代码中就是，所有继承Logger抽象类的子类，都必须重写doLog()方法。</li>
</ul>
<h3 id="接口-interface">接口 interface</h3>
<p>下面这段代码是一个比较典型的接口的使用场景。我们通过Java中的interface关键字定义了一个Filter接口。AuthencationFilter和RateLimitFilter是接口的两个实现类，分别实现了对RPC请求鉴权和限流的过滤功能。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Filter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>RpcRequest req<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RpcException<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// 接口实现类：鉴权过滤器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthencationFilter</span> <span style="color:#66d9ef">implements</span> Filter <span style="color:#f92672">{</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>RpcRequest req<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RpcException <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...鉴权逻辑..
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// 接口实现类：限流过滤器
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RateLimitFilter</span> <span style="color:#66d9ef">implements</span> Filter <span style="color:#f92672">{</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>RpcRequest req<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> RpcException <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...限流逻辑...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// 过滤器使用Demo
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// filters.add(new AuthencationFilter());
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// filters.add(new RateLimitFilter());
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>Filter<span style="color:#f92672">&gt;</span> filters <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">handleRpcRequest</span><span style="color:#f92672">(</span>RpcRequest req<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Filter filter <span style="color:#f92672">:</span> filters<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        filter<span style="color:#f92672">.</span><span style="color:#a6e22e">doFilter</span><span style="color:#f92672">(</span>req<span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>RpcException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ...处理过滤结果...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// ...省略其他处理逻辑...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>接口的特性：</p>
<ul>
<li>接口不能包含属性（也就是成员变量）。</li>
<li>接口只能声明方法，方法不能包含代码实现。</li>
<li>类实现接口的时候，必须实现接口中声明的所有方法。</li>
</ul>
<h3 id="比较-abstract-class-vs-interface">比较 abstract class VS interface</h3>
<p>从语法特性上对比，这两者有比较大的区别，比如抽象类中可以定义属性、方法的实现，而接口中不能定义属性，方法也不能包含代码实现等等。</p>
<p>从设计的角度，抽象类实际上就是类，只不过是一种特殊的类，这种类不能被实例化为对象，只能被子类继承。我们知道，继承关系是一种is-a的关系，那抽象类既然属于类，也表示一种is-a的关系。相对于抽象类的is-a关系来说，接口表示一种has-a关系，表示具有某些功能。对于接口，有一个更加形象的叫法，那就是协议（contract）。</p>
<h2 id="基于接口而非实现编程"><strong>基于接口而非实现编程</strong></h2>
<p>“基于接口而非实现编程”这条原则的英文描述是：“Program to an interface, not an implementation”。我们理解这条原则的时候，千万不要一开始就与具体的编程语言挂钩，局限在编程语言的“接口”语法中（比如Java中的interface接口语法）。这条原则最早出现于1994年GoF的《设计模式》这本书，它先于很多编程语言而诞生（比如Java语言），是一条比较抽象、泛化的设计思想。</p>
<p>实际上，理解这条原则的关键，就是理解其中的“接口”两个字。还记得我们上一节课讲的“接口”的定义吗？从本质上来看，“接口”就是一组“协议”或者“约定”，是功能提供者提供给使用者的一个“功能列表”。“接口”在不同的应用场景下会有不同的解读，比如服务端与客户端之间的“接口”，类库提供的“接口”，甚至是一组通信的协议都可以叫作“接口”。刚刚对“接口”的理解，都比较偏上层、偏抽象，与实际的写代码离得有点远。如果落实到具体的编码，“基于接口而非实现编程”这条原则中的“接口”，可以理解为编程语言中的接口或者抽象类。</p>
<p>前面我们提到，这条原则能非常有效地提高代码质量，之所以这么说，那是因为，应用这条原则，可以将接口和实现相分离，封装不稳定的实现，暴露稳定的接口。上游系统面向接口而非实现编程，不依赖不稳定的实现细节，这样当实现发生变化的时候，上游系统的代码基本上不需要做改动，以此来降低耦合性，提高扩展性。</p>
<p>实际上，“基于接口而非实现编程”这条原则的另一个表述方式，是“基于抽象而非实现编程”。后者的表述方式其实更能体现这条原则的设计初衷。在软件开发中，最大的挑战之一就是需求的不断变化，这也是考验代码设计好坏的一个标准。**越抽象、越顶层、越脱离具体某一实现的设计，越能提高代码的灵活性，越能应对未来的需求变化。好的代码设计，不仅能应对当下的需求，而且在将来需求发生变化的时候，仍然能够在不破坏原有代码设计的情况下灵活应对。**而抽象就是提高代码扩展性、灵活性、可维护性最有效的手段之一。</p>
<h2 id="多用组合少用继承">多用组合少用继承？</h2>
<p>继承是面向对象的四大特性之一，用来表示类之间的is-a关系，可以解决代码复用的问题。虽然继承有诸多作用，但继承层次过深、过复杂，也会影响到代码的可维护性。</p>
<p>假设我们要设计一个关于鸟的类。我们将“鸟类”这样一个抽象的事物概念，定义为一个抽象类AbstractBird。所有更细分的鸟，比如麻雀、鸽子、乌鸦等，都继承这个抽象类。</p>
<p>我们知道，大部分鸟都会飞，那我们可不可以在AbstractBird抽象类中，定义一个fly()方法呢？答案是否定的。尽管大部分鸟都会飞，但也有特例，比如鸵鸟就不会飞。鸵鸟继承具有fly()方法的父类，那鸵鸟就具有“飞”这样的行为，这显然不符合我们对现实世界中事物的认识。</p>
<p>你可能又会说，那我们再通过AbstractBird类派生出两个更加细分的抽象类：会飞的鸟类AbstractFlyableBird和不会飞的鸟类AbstractUnFlyableBird，让麻雀、乌鸦这些会飞的鸟都继承AbstractFlyableBird，让鸵鸟、企鹅这些不会飞的鸟，都继承AbstractUnFlyableBird类，不就可以了吗？</p>
<p>整体上来讲，目前的继承关系还比较简单，层次比较浅，也算是一种可以接受的设计思路。我们再继续加点难度。在刚刚这个场景中，我们只关注“鸟会不会飞”，但如果我们还关注“鸟会不会叫”，那这个时候，我们又该如何设计类之间的继承关系呢？</p>
<p>是否会飞？是否会叫？两个行为搭配起来会产生四种情况：会飞会叫、不会飞会叫、会飞不会叫、不会飞不会叫。如果我们继续沿用刚才的设计思路，那就需要再定义四个抽象类（AbstractFlyableTweetableBird、AbstractFlyableUnTweetableBird、AbstractUnFlyableTweetableBird、AbstractUnFlyableUnTweetableBird）。</p>
<p>如果我们还需要考虑“是否会下蛋”这样一个行为，那估计就要组合爆炸了。类的继承层次会越来越深、继承关系会越来越复杂。而这种层次很深、很复杂的继承关系，一方面，会导致代码的可读性变差。因为我们要搞清楚某个类具有哪些方法、属性，必须阅读父类的代码、父类的父类的代码……一直追溯到最顶层父类的代码。另一方面，这也破坏了类的封装特性，将父类的实现细节暴露给了子类。子类的实现依赖父类的实现，两者高度耦合，一旦父类代码修改，就会影响所有子类的逻辑。</p>
<p>实际上，我们可以利用组合（composition）、接口、委托（delegation）三个技术手段，一块儿来解决刚刚继承存在的问题。</p>
<p>接口表示具有某种行为特性。针对“会飞”这样一个行为特性，我们可以定义一个Flyable接口，只让会飞的鸟去实现这个接口。对于会叫、会下蛋这些行为特性，我们可以类似地定义Tweetable接口、EggLayable接口。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Flyable</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fly</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Tweetable</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tweet</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">EggLayable</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">layEgg</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Ostrich</span> <span style="color:#66d9ef">implements</span> Tweetable<span style="color:#f92672">,</span> EggLayable <span style="color:#f92672">{</span><span style="color:#75715e">//鸵鸟
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//... 省略其他属性和方法...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tweet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">layEgg</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Sparrow</span> impelents Flyable<span style="color:#f92672">,</span> Tweetable<span style="color:#f92672">,</span> EggLayable <span style="color:#f92672">{</span><span style="color:#75715e">//麻雀
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//... 省略其他属性和方法...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fly</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tweet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">layEgg</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>不过，我们知道，接口只声明方法，不定义实现。也就是说，每个会下蛋的鸟都要实现一遍layEgg()方法，并且实现逻辑是一样的，这就会导致代码重复的问题。那这个问题又该如何解决呢？</p>
<p>我们可以针对三个接口再定义三个实现类，它们分别是：实现了fly()方法的FlyAbility类、实现了tweet()方法的TweetAbility类、实现了layEgg()方法的EggLayAbility类。然后，通过组合和委托技术来消除代码重复。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Flyable</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fly</span><span style="color:#f92672">()</span><span style="color:#960050;background-color:#1e0010">；</span>
<span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FlyAbility</span> <span style="color:#66d9ef">implements</span> Flyable <span style="color:#f92672">{</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fly</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
<span style="color:#75715e">//省略Tweetable/TweetAbility/EggLayable/EggLayAbility
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Ostrich</span> <span style="color:#66d9ef">implements</span> Tweetable<span style="color:#f92672">,</span> EggLayable <span style="color:#f92672">{</span><span style="color:#75715e">//鸵鸟
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> TweetAbility tweetAbility <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TweetAbility<span style="color:#f92672">();</span> <span style="color:#75715e">//组合
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> EggLayAbility eggLayAbility <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EggLayAbility<span style="color:#f92672">();</span> <span style="color:#75715e">//组合
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//... 省略其他属性和方法...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tweet</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    tweetAbility<span style="color:#f92672">.</span><span style="color:#a6e22e">tweet</span><span style="color:#f92672">();</span> <span style="color:#75715e">// 委托
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">layEgg</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    eggLayAbility<span style="color:#f92672">.</span><span style="color:#a6e22e">layEgg</span><span style="color:#f92672">();</span> <span style="color:#75715e">// 委托
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>我们知道继承主要有三个作用：表示is-a关系，支持多态特性，代码复用。而这三个作用都可以通过其他技术手段来达成。比如is-a关系，我们可以通过组合和接口的has-a关系来替代；多态特性我们可以利用接口来实现；代码复用我们可以通过组合和委托来实现。所以，从理论上讲，通过组合、接口、委托三个技术手段，我们完全可以替换掉继承，在项目中不用或者少用继承关系，特别是一些复杂的继承关系。</p>
<hr>
<p>尽管我们鼓励多用组合少用继承，但组合也并不是完美的，继承也并非一无是处。从上面的例子来看，继承改写成组合意味着要做更细粒度的类的拆分。这也就意味着，我们要定义更多的类和接口。类和接口的增多也就或多或少地增加代码的复杂程度和维护成本。</p>
<p>如果类之间的继承结构稳定（不会轻易改变），继承层次比较浅（比如，最多有两层继承关系），继承关系不复杂，我们就可以大胆地使用继承。反之，系统越不稳定，继承层次很深，继承关系复杂，我们就尽量使用组合来替代继承。</p>
<p>除此之外，还有一些设计模式会固定使用继承或者组合。比如，装饰者模式（decorator pattern）、策略模式（strategy pattern）、组合模式（composite pattern）等都使用了组合关系，而模板模式（template pattern）使用了继承关系。</p>
<h2 id="基于贫血模型的传统开发模式">基于贫血模型的传统开发模式</h2>
<p>MVC三层架构中的M表示Model，V表示View，C表示Controller。它将整个项目分为三层：展示层、逻辑层、数据层。MVC三层开发架构是一个比较笼统的分层方式，落实到具体的开发层面，很多项目也并不会100%遵从MVC固定的分层方式，而是会根据具体的项目需求，做适当的调整。</p>
<p>比如，现在很多Web或者App项目都是前后端分离的，后端负责暴露接口给前端调用。这种情况下，我们一般就将后端项目分为Repository层、Service层、Controller层。其中，Repository层负责数据访问，Service层负责业务逻辑，Controller层负责暴露接口。</p>
<p>下面是贫血模型的一个简单例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">////////// Controller+VO(View Object) //////////
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> UserService userService<span style="color:#f92672">;</span> <span style="color:#75715e">//通过构造函数或者IOC框架注入
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> UserVo <span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span>Long userId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    UserBo userBo <span style="color:#f92672">=</span> userService<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span>userId<span style="color:#f92672">);</span>
    UserVo userVo <span style="color:#f92672">=</span> <span style="color:#f92672">[...</span><span style="color:#a6e22e">convert</span> userBo to userVo<span style="color:#f92672">...];</span>
    <span style="color:#66d9ef">return</span> userVo<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserVo</span> <span style="color:#f92672">{</span><span style="color:#75715e">//省略其他属性、get/set/construct方法
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> Long id<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String cellphone<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">////////// Service+BO(Business Object) //////////
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserService</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> UserRepository userRepository<span style="color:#f92672">;</span> <span style="color:#75715e">//通过构造函数或者IOC框架注入
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> UserBo <span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span>Long userId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    UserEntity userEntity <span style="color:#f92672">=</span> userRepository<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span>userId<span style="color:#f92672">);</span>
    UserBo userBo <span style="color:#f92672">=</span> <span style="color:#f92672">[...</span><span style="color:#a6e22e">convert</span> userEntity to userBo<span style="color:#f92672">...];</span>
    <span style="color:#66d9ef">return</span> userBo<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserBo</span> <span style="color:#f92672">{</span><span style="color:#75715e">//省略其他属性、get/set/construct方法
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> Long id<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String cellphone<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">////////// Repository+Entity //////////
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserRepository</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> UserEntity <span style="color:#a6e22e">getUserById</span><span style="color:#f92672">(</span>Long userId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserEntity</span> <span style="color:#f92672">{</span><span style="color:#75715e">//省略其他属性、get/set/construct方法
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> Long id<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String cellphone<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>UserEntity和UserRepository组成了数据访问层，UserBo和UserService组成了业务逻辑层，UserVo和UserController在这里属于接口层。</p>
<p>从代码中，我们可以发现，UserBo是一个纯粹的数据结构，只包含数据，不包含任何业务逻辑。业务逻辑集中在UserService中。我们通过UserService来操作UserBo。换句话说，Service层的数据和业务逻辑，被分割为BO和Service两个类中。像UserBo这样，只包含数据，不包含业务逻辑的类，就叫作<strong>贫血模型</strong>（Anemic Domain Model）。同理，UserEntity、UserVo都是基于贫血模型设计的。这种贫血模型将数据与操作分离，破坏了面向对象的封装特性，是一种典型的面向过程的编程风格。</p>
<h3 id="基于充血模型的ddd开发模式">基于充血模型的DDD开发模式</h3>
<p>在贫血模型中，数据和业务逻辑被分割到不同的类中。<strong>充血模型</strong>（Rich Domain Model）正好相反，数据和对应的业务逻辑被封装到同一个类中。因此，这种充血模型满足面向对象的封装特性，是典型的面向对象编程风格。</p>
<p>领域驱动设计，即DDD，主要是用来指导如何解耦业务系统，划分业务模块，定义业务领域模型及其交互。</p>
<p>在基于贫血模型的传统开发模式中，Service层包含Service类和BO类两部分，BO是贫血模型，只包含数据，不包含具体的业务逻辑。业务逻辑集中在Service类中。在基于充血模型的DDD开发模式中，Service层包含Service类和Domain类两部分。Domain就相当于贫血模型中的BO。不过，Domain与BO的区别在于它是基于充血模型开发的，既包含数据，也包含业务逻辑。而Service类变得非常单薄。总结一下的话就是，基于贫血模型的传统的开发模式，重Service轻BO；基于充血模型的DDD开发模式，轻Service重Domain。</p>
<h2 id="实战例子接口鉴权的面向对象分析设计编程">实战例子：接口鉴权的面向对象分析&amp;设计&amp;编程</h2>
<p>假设，你正在参与开发一个微服务。微服务通过HTTP协议暴露接口给其他系统调用，说直白点就是，其他系统通过URL来调用微服务的接口。有一天，你的leader找到你说，“为了保证接口调用的安全性，我们希望设计实现一个接口调用鉴权功能，只有经过认证之后的系统才能调用我们的接口，没有认证过的系统调用我们的接口会被拒绝。我希望由你来负责这个任务的开发，争取尽快上线。”</p>
<h3 id="面向对象分析">面向对象分析</h3>
<h4 id="需求分析">需求分析</h4>
<ol>
<li>第一轮基础分析</li>
</ol>
<p>对于如何做鉴权这样一个问题，最简单的解决方案就是，通过用户名加密码来做认证。我们给每个允许访问我们服务的调用方，派发一个应用名（或者叫应用ID、AppID）和一个对应的密码（或者叫秘钥）。调用方每次进行接口请求的时候，都携带自己的AppID和密码。微服务在接收到接口调用请求之后，会解析出AppID和密码，跟存储在微服务端的AppID和密码进行比对。如果一致，说明认证成功，则允许接口调用请求；否则，就拒绝接口调用请求。</p>
<ol start="2">
<li>第二轮分析优化</li>
</ol>
<p>不过，这样的验证方式，每次都要明文传输密码。密码很容易被截获，是不安全的。那如果我们借助加密算法（比如SHA），对密码进行加密之后，再传递到微服务端验证，是不是就可以了呢？实际上，这样也是不安全的，因为加密之后的密码及AppID，照样可以被未认证系统（或者说黑客）截获，未认证系统可以携带这个加密之后的密码以及对应的AppID，伪装成已认证系统来访问我们的接口。这就是典型的“重放攻击”。</p>
<p>提出问题，然后再解决问题，是一个非常好的迭代优化方法。对于刚刚这个问题，我们可以借助OAuth的验证思路来解决。调用方将请求接口的URL跟AppID、密码拼接在一起，然后进行加密，生成一个token。调用方在进行接口请求的的时候，将这个token及AppID，随URL一块传递给微服务端。微服务端接收到这些数据之后，根据AppID从数据库中取出对应的密码，并通过同样的token生成算法，生成另外一个token。用这个新生成的token跟调用方传递过来的token对比。如果一致，则允许接口调用请求；否则，就拒绝接口调用请求。</p>
<ol start="3">
<li>第三轮分析优化</li>
</ol>
<p>不过，这样的设计仍然存在重放攻击的风险，还是不够安全。每个URL拼接上AppID、密码生成的token都是固定的。未认证系统截获URL、token和AppID之后，还是可以通过重放攻击的方式，伪装成认证系统，调用这个URL对应的接口。</p>
<p>为了解决这个问题，我们可以进一步优化token生成算法，引入一个随机变量，让每次接口请求生成的token都不一样。我们可以选择时间戳作为随机变量。原来的token是对URL、AppID、密码三者进行加密生成的，现在我们将URL、AppID、密码、时间戳四者进行加密来生成token。调用方在进行接口请求的时候，将token、AppID、时间戳，随URL一并传递给微服务端。</p>
<p>微服务端在收到这些数据之后，会验证当前时间戳跟传递过来的时间戳，是否在一定的时间窗口内（比如一分钟）。如果超过一分钟，则判定token过期，拒绝接口请求。如果没有超过一分钟，则说明token没有过期，就再通过同样的token生成算法，在服务端生成新的token，与调用方传递过来的token比对，看是否一致。如果一致，则允许接口调用请求；否则，就拒绝接口调用请求。</p>
<ol start="4">
<li>第四轮分析优化</li>
</ol>
<p>不过，你可能会说，这样还是不够安全啊。未认证系统还是可以在这一分钟的token失效窗口内，通过截获请求、重放请求，来调用我们的接口啊！</p>
<p>你说得没错。不过，攻与防之间，本来就没有绝对的安全。我们能做的就是，尽量提高攻击的成本。这个方案虽然还有漏洞，但是实现起来足够简单，而且不会过度影响接口本身的性能（比如响应时间）。所以，权衡安全性、开发成本、对系统性能的影响，这个方案算是比较折中、比较合理的了。</p>
<p>实际上，还有一个细节我们没有考虑到，那就是，如何在微服务端存储每个授权调用方的AppID和密码。当然，这个问题并不难。最容易想到的方案就是存储到数据库里，比如MySQL。不过，开发像鉴权这样的非业务功能，最好不要与具体的第三方系统有过度的耦合。</p>
<p>针对AppID和密码的存储，我们最好能灵活地支持各种不同的存储方式，比如ZooKeeper、本地配置文件、自研配置中心、MySQL、Redis等。我们不一定针对每种存储方式都去做代码实现，但起码要留有扩展点，保证系统有足够的灵活性和扩展性，能够在我们切换存储方式的时候，尽可能地减少代码的改动。</p>
<ol start="5">
<li>最终确定需求</li>
</ol>
<p>到此，需求已经足够细化和具体了。现在，我们按照鉴权的流程，对需求再重新描述一下。如果你熟悉UML，也可以用时序图、流程图来描述。不过，用什么描述不是重点，描述清楚才是最重要的。考虑到在接下来的面向对象设计环节中，我会基于文字版本的需求描述，来进行类、属性、方法、交互等的设计，所以，这里我给出的最终需求描述是文字版本的。</p>
<ul>
<li>
<p>调用方进行接口请求的时候，将URL、AppID、密码、时间戳拼接在一起，通过加密算法生成token，并且将token、AppID、时间戳拼接在URL中，一并发送到微服务端。</p>
</li>
<li>
<p>微服务端在接收到调用方的接口请求之后，从请求中拆解出token、AppID、时间戳。</p>
</li>
<li>
<p>微服务端首先检查传递过来的时间戳跟当前时间，是否在token失效时间窗口内。如果已经超过失效时间，那就算接口调用鉴权失败，拒绝接口调用请求。</p>
</li>
<li>
<p>如果token验证没有过期失效，微服务端再从自己的存储中，取出AppID对应的密码，通过同样的token生成算法，生成另外一个token，与调用方传递过来的token进行匹配；如果一致，则鉴权成功，允许接口调用，否则就拒绝接口调用。</p>
</li>
</ul>
<p>这就是我们需求分析的整个思考过程，从最粗糙、最模糊的需求开始，通过“提出问题-解决问题”的方式，循序渐进地进行优化，最后得到一个足够清晰、可落地的需求描述。</p>
<h3 id="面向对象设计">面向对象设计</h3>
<h4 id="1-划分职责进而识别出有哪些类">1. 划分职责进而识别出有哪些类</h4>
<p>首先，我们要做的是逐句阅读上面的需求描述，拆解成小的功能点，一条一条罗列下来。注意，拆解出来的每个功能点要尽可能的小。每个功能点只负责做一件很小的事情（专业叫法是“单一职责”，后面章节中我们会讲到）。下面是我逐句拆解上述需求描述之后，得到的功能点列表：</p>
<ol>
<li>把URL、AppID、密码、时间戳拼接为一个字符串；</li>
<li>对字符串通过加密算法加密生成token；</li>
<li>将token、AppID、时间戳拼接到URL中，形成新的URL；</li>
<li>解析URL，得到token、AppID、时间戳等信息；</li>
<li>从存储中取出AppID和对应的密码；</li>
<li>根据时间戳判断token是否过期失效；</li>
<li>验证两个token是否匹配；</li>
</ol>
<p>从上面的功能列表中，我们发现，1、2、6、7都是跟token有关，负责token的生成、验证；3、4都是在处理URL，负责URL的拼接、解析；5是操作AppID和密码，负责从存储中读取AppID和密码。所以，我们可以粗略地得到三个核心的类：AuthToken、Url、CredentialStorage。AuthToken负责实现1、2、6、7这四个操作；Url负责3、4两个操作；CredentialStorage负责5这个操作。</p>
<p>当然，这是一个初步的类的划分，其他一些不重要的、边边角角的类，我们可能暂时没法一下子想全，但这也没关系，面向对象分析、设计、编程本来就是一个循环迭代、不断优化的过程。根据需求，我们先给出一个粗糙版本的设计方案，然后基于这样一个基础，再去迭代优化，会更加容易一些，思路也会更加清晰一些。</p>
<h3 id="2-定义类及其属性和方法">2. 定义类及其属性和方法</h3>
<p><strong>AuthToken类相关的功能点有四个：</strong></p>
<ul>
<li>把URL、AppID、密码、时间戳拼接为一个字符串；</li>
<li>对字符串通过加密算法加密生成token；</li>
<li>根据时间戳判断token是否过期失效；</li>
<li>验证两个token是否匹配。</li>
</ul>
<p>对于方法的识别，很多面向对象相关的书籍，一般都是这么讲的，识别出需求描述中的动词，作为候选的方法，再进一步过滤筛选。类比一下方法的识别，我们可以把功能点中涉及的名词，作为候选属性，然后同样进行过滤筛选。</p>
<p>我们可以借用这个思路，根据功能点描述，识别出来AuthToken类的属性和方法，如下所示：</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20220805/20220805153104.png" alt="img"></p>
<p>从上面的类图中，我们可以发现这样三个小细节。</p>
<ul>
<li>第一个细节：并不是所有出现的名词都被定义为类的属性，比如URL、AppID、密码、时间戳这几个名词，我们把它作为了方法的参数。</li>
<li>第二个细节：我们还需要挖掘一些没有出现在功能点描述中属性，比如createTime，expireTimeInterval，它们用在isExpired()函数中，用来判定token是否过期。</li>
<li>第三个细节：我们还给AuthToken类添加了一个功能点描述中没有提到的方法getToken()。</li>
</ul>
<p>第一个细节告诉我们，从业务模型上来说，不应该属于这个类的属性和方法，不应该被放到这个类里。比如URL、AppID这些信息，从业务模型上来说，不应该属于AuthToken，所以我们不应该放到这个类中。</p>
<p>第二、第三个细节告诉我们，在设计类具有哪些属性和方法的时候，不能单纯地依赖当下的需求，还要分析这个类从业务模型上来讲，理应具有哪些属性和方法。这样可以一方面保证类定义的完整性，另一方面不仅为当下的需求还为未来的需求做些准备。</p>
<p><strong>Url类相关的功能点有两个：</strong></p>
<ul>
<li>将token、AppID、时间戳拼接到URL中，形成新的URL；</li>
<li>解析URL，得到token、AppID、时间戳等信息。</li>
</ul>
<p>虽然需求描述中，我们都是以URL来代指接口请求，但是，接口请求并不一定是以URL的形式来表达，还有可能是Dubbo、RPC等其他形式。为了让这个类更加通用，命名更加贴切，我们接下来把它命名为ApiRequest。下面是我根据功能点描述设计的ApiRequest类。</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20220805/20220805153700.png" alt="img"></p>
<p><strong>CredentialStorage类相关的功能点有一个：</strong></p>
<ul>
<li>从存储中取出AppID和对应的密码。</li>
</ul>
<p>CredentialStorage类非常简单，类图如下所示。为了做到抽象封装具体的存储方式，我们将CredentialStorage设计成了接口，基于接口而非具体的实现编程。</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20220805/20220805153732.png" alt="img"></p>
<h3 id="3-定义类与类之间的交互关系">3. 定义类与类之间的交互关系</h3>
<p>UML统一建模语言中定义了六种类之间的关系。它们分别是：泛化、实现、关联、聚合、组合、依赖。</p>
<p>因为目前只有三个核心的类，所以只用到了实现关系，也即CredentialStorage和MysqlCredentialStorage之间的关系。接下来讲到组装类的时候，我们还会用到依赖关系、组合关系，但是泛化关系暂时没有用到。</p>
<h3 id="4-将类组装起来并提供执行入口">4. 将类组装起来并提供执行入口</h3>
<p>类定义好了，类之间必要的交互关系也设计好了，接下来我们要将所有的类组装在一起，提供一个执行入口。这个入口可能是一个main()函数，也可能是一组给外部用的API接口。通过这个入口，我们能触发整个代码跑起来。</p>
<p>接口鉴权并不是一个独立运行的系统，而是一个集成在系统上运行的组件，所以，我们封装所有的实现细节，设计了一个最顶层的ApiAuthenticator接口类，暴露一组给外部调用者使用的API接口，作为触发执行鉴权逻辑的入口。具体的类的设计如下所示：</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20220808/20220808151602.png" alt="img"></p>
<h1 id="二设计原则">二、设计原则</h1>
<h2 id="单一职责原则srp">单一职责原则（SRP）</h2>
<p>单一职责原则的英文是Single Responsibility Principle，缩写为SRP。这个原则的英文描述是这样的：A class or module should have a single responsibility。如果我们把它翻译成中文，那就是：一个类或者模块只负责完成一个职责（或者功能）。</p>
<h3 id="判断类的职责是否足够单一">判断类的职责是否足够单一？</h3>
<p>在真实的软件开发中，对于一个类是否职责单一的判定，是很难拿捏的。</p>
<p>举个例子，在一个社交产品中，我们用下面的UserInfo类来记录用户的信息。你觉得，UserInfo类的设计是否满足单一职责原则呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserInfo</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> userId<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String username<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String email<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String telephone<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> createTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> lastLoginTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String avatarUrl<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String provinceOfAddress<span style="color:#f92672">;</span> <span style="color:#75715e">// 省
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> String cityOfAddress<span style="color:#f92672">;</span> <span style="color:#75715e">// 市
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> String regionOfAddress<span style="color:#f92672">;</span> <span style="color:#75715e">// 区 
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> String detailedAddress<span style="color:#f92672">;</span> <span style="color:#75715e">// 详细地址
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// ...省略其他属性和方法...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>对于这个问题，有两种不同的观点。一种观点是，UserInfo类包含的都是跟用户相关的信息，所有的属性和方法都隶属于用户这样一个业务模型，满足单一职责原则；另一种观点是，地址信息在UserInfo类中，所占的比重比较高，可以继续拆分成独立的UserAddress类，UserInfo只保留除Address之外的其他信息，拆分之后的两个类的职责更加单一。</p>
<p>哪种观点更对呢？实际上，要从中做出选择，我们不能脱离具体的应用场景。如果在这个社交产品中，用户的地址信息跟其他信息一样，只是单纯地用来展示，那UserInfo现在的设计就是合理的。但是，如果这个社交产品发展得比较好，之后又在产品中添加了电商的模块，用户的地址信息还会用在电商物流中，那我们最好将地址信息从UserInfo中拆分出来，独立成用户物流信息（或者叫地址信息、收货信息等）。</p>
<p>我们再进一步延伸一下。如果做这个社交产品的公司发展得越来越好，公司内部又开发出了很多其他产品（可以理解为其他App）。公司希望支持统一账号系统，也就是用户一个账号可以在公司内部的所有产品中登录。这个时候，我们就需要继续对UserInfo进行拆分，将跟身份认证相关的信息（比如，email、telephone等）抽取成独立的类。</p>
<p>从刚刚这个例子，我们可以总结出，不同的应用场景、不同阶段的需求背景下，对同一个类的职责是否单一的判定，可能都是不一样的。在某种应用场景或者当下的需求背景下，一个类的设计可能已经满足单一职责原则了，但如果换个应用场景或着在未来的某个需求背景下，可能就不满足了，需要继续拆分成粒度更细的类。</p>
<p>综上所述，评价一个类的职责是否足够单一，我们并没有一个非常明确的、可以量化的标准，可以说，这是件非常主观、仁者见仁智者见智的事情。实际上，在真正的软件开发中，我们也没必要过于未雨绸缪，过度设计。所以，<strong>我们可以先写一个粗粒度的类，满足业务需求。随着业务的发展，如果粗粒度的类越来越庞大，代码越来越多，这个时候，我们就可以将这个粗粒度的类，拆分成几个更细粒度的类。这就是所谓的持续重构。</strong></p>
<h3 id="类的职责设计得越单一越好">类的职责设计得越单一越好？</h3>
<p>为了满足单一职责原则，是不是把类拆得越细就越好呢？答案是否定的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Protocol format: identifier-string;{gson string}
</span><span style="color:#75715e"> * For example: UEUEUE;{&#34;a&#34;:&#34;A&#34;,&#34;b&#34;:&#34;B&#34;}
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Serialization</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String IDENTIFIER_STRING <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UEUEUE;&#34;</span><span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Gson gson<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Serialization</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">gson</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Gson<span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">serialize</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    StringBuilder textBuilder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">();</span>
    textBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>IDENTIFIER_STRING<span style="color:#f92672">);</span>
    textBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>gson<span style="color:#f92672">.</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span>object<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">return</span> textBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">deserialize</span><span style="color:#f92672">(</span>String text<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>text<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>IDENTIFIER_STRING<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">emptyMap</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    String gsonStr <span style="color:#f92672">=</span> text<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>IDENTIFIER_STRING<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">return</span> gson<span style="color:#f92672">.</span><span style="color:#a6e22e">fromJson</span><span style="color:#f92672">(</span>gsonStr<span style="color:#f92672">,</span> Map<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>如果我们想让类的职责更加单一，我们对Serialization类进一步拆分，拆分成一个只负责序列化工作的Serializer类和另一个只负责反序列化工作的Deserializer类。拆分后的具体代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Serializer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String IDENTIFIER_STRING <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UEUEUE;&#34;</span><span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Gson gson<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Serializer</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">gson</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Gson<span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">serialize</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    StringBuilder textBuilder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringBuilder<span style="color:#f92672">();</span>
    textBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>IDENTIFIER_STRING<span style="color:#f92672">);</span>
    textBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">append</span><span style="color:#f92672">(</span>gson<span style="color:#f92672">.</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span>object<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">return</span> textBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Deserializer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String IDENTIFIER_STRING <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UEUEUE;&#34;</span><span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Gson gson<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Deserializer</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">gson</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Gson<span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">deserialize</span><span style="color:#f92672">(</span>String text<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>text<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span>IDENTIFIER_STRING<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">emptyMap</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    String gsonStr <span style="color:#f92672">=</span> text<span style="color:#f92672">.</span><span style="color:#a6e22e">substring</span><span style="color:#f92672">(</span>IDENTIFIER_STRING<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">return</span> gson<span style="color:#f92672">.</span><span style="color:#a6e22e">fromJson</span><span style="color:#f92672">(</span>gsonStr<span style="color:#f92672">,</span> Map<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>虽然经过拆分之后，Serializer类和Deserializer类的职责更加单一了，但也随之带来了新的问题。如果我们修改了协议的格式，数据标识从“UEUEUE”改为“DFDFDF”，或者序列化方式从JSON改为了XML，那Serializer类和Deserializer类都需要做相应的修改，代码的内聚性显然没有原来Serialization高了。而且，如果我们仅仅对Serializer类做了协议修改，而忘记了修改Deserializer类的代码，那就会导致序列化、反序列化不匹配，程序运行出错，也就是说，拆分之后，代码的可维护性变差了。</p>
<h2 id="开闭原则ocp">开闭原则（OCP）</h2>
<p>开闭原则的英文全称是Open Closed Principle，简写为OCP。它的英文描述是：software entities (modules, classes, functions, etc.) should be open for extension , but closed for modification。我们把它翻译成中文就是：软件实体（模块、类、方法等）应该“对扩展开放、对修改关闭”。</p>
<p>这个描述比较简略，如果我们详细表述一下，那就是，添加一个新的功能应该是，在已有代码基础上扩展代码（新增模块、类、方法等），而非修改已有代码（修改模块、类、方法等）。</p>
<h3 id="理解对扩展开放修改关闭">理解“对扩展开放、修改关闭”</h3>
<p>这是一段API接口监控告警的代码。</p>
<p>其中，AlertRule存储告警规则，可以自由设置。Notification是告警通知类，支持邮件、短信、手机等多种通知渠道。NotificationEmergencyLevel表示通知的紧急程度，包括SEVERE（严重）、URGENCY（紧急）、NORMAL（普通）、TRIVIAL（无关紧要），不同的紧急程度对应不同的发送渠道。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Alert</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> AlertRule rule<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Notification notification<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Alert</span><span style="color:#f92672">(</span>AlertRule rule<span style="color:#f92672">,</span> Notification notification<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rule</span> <span style="color:#f92672">=</span> rule<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">notification</span> <span style="color:#f92672">=</span> notification<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>String api<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> requestCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> errorCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationOfSeconds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> tps <span style="color:#f92672">=</span> requestCount <span style="color:#f92672">/</span> durationOfSeconds<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tps <span style="color:#f92672">&gt;</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getMatchedRule</span><span style="color:#f92672">(</span>api<span style="color:#f92672">).</span><span style="color:#a6e22e">getMaxTps</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      notification<span style="color:#f92672">.</span><span style="color:#a6e22e">notify</span><span style="color:#f92672">(</span>NotificationEmergencyLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">URGENCY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>errorCount <span style="color:#f92672">&gt;</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getMatchedRule</span><span style="color:#f92672">(</span>api<span style="color:#f92672">).</span><span style="color:#a6e22e">getMaxErrorCount</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      notification<span style="color:#f92672">.</span><span style="color:#a6e22e">notify</span><span style="color:#f92672">(</span>NotificationEmergencyLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">SEVERE</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上面这段代码非常简单，业务逻辑主要集中在check()函数中。当接口的TPS超过某个预先设置的最大值时，以及当接口请求出错数大于某个最大允许值时，就会触发告警，通知接口的相关负责人或者团队。</p>
<p>现在，如果我们需要添加一个功能，当每秒钟接口超时请求个数，超过某个预先设置的最大阈值时，我们也要触发告警发送通知。这个时候，我们该如何改动代码呢？主要的改动有两处：第一处是修改check()函数的入参，添加一个新的统计数据timeoutCount，表示超时接口请求数；第二处是在check()函数中添加新的告警逻辑。具体的代码改动如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Alert</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// ...省略AlertRule/Notification属性和构造函数...
</span><span style="color:#75715e"></span>  
  <span style="color:#75715e">// 改动一：添加参数timeoutCount
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>String api<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> requestCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> errorCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> timeoutCount<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationOfSeconds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> tps <span style="color:#f92672">=</span> requestCount <span style="color:#f92672">/</span> durationOfSeconds<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tps <span style="color:#f92672">&gt;</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getMatchedRule</span><span style="color:#f92672">(</span>api<span style="color:#f92672">).</span><span style="color:#a6e22e">getMaxTps</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      notification<span style="color:#f92672">.</span><span style="color:#a6e22e">notify</span><span style="color:#f92672">(</span>NotificationEmergencyLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">URGENCY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>errorCount <span style="color:#f92672">&gt;</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getMatchedRule</span><span style="color:#f92672">(</span>api<span style="color:#f92672">).</span><span style="color:#a6e22e">getMaxErrorCount</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      notification<span style="color:#f92672">.</span><span style="color:#a6e22e">notify</span><span style="color:#f92672">(</span>NotificationEmergencyLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">SEVERE</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// 改动二：添加接口超时处理逻辑
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">long</span> timeoutTps <span style="color:#f92672">=</span> timeoutCount <span style="color:#f92672">/</span> durationOfSeconds<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>timeoutTps <span style="color:#f92672">&gt;</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getMatchedRule</span><span style="color:#f92672">(</span>api<span style="color:#f92672">).</span><span style="color:#a6e22e">getMaxTimeoutTps</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      notification<span style="color:#f92672">.</span><span style="color:#a6e22e">notify</span><span style="color:#f92672">(</span>NotificationEmergencyLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">URGENCY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这样的代码修改实际上存在挺多问题的。一方面，我们对接口进行了修改，这就意味着调用这个接口的代码都要做相应的修改。另一方面，修改了check()函数，相应的单元测试都需要修改（关于单元测试的内容我们在重构那部分会详细介绍）。</p>
<p>上面的代码改动是基于“修改”的方式来实现新功能的。如果我们遵循开闭原则，也就是“对扩展开放、对修改关闭”。那如何通过“扩展”的方式，来实现同样的功能呢？</p>
<p>我们先重构一下之前的Alert代码，让它的扩展性更好一些。重构的内容主要包含两部分：</p>
<ul>
<li>第一部分是将check()函数的多个入参封装成ApiStatInfo类；</li>
<li>第二部分是引入handler的概念，将if判断逻辑分散在各个handler中。</li>
</ul>
<p>具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Alert</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>AlertHandler<span style="color:#f92672">&gt;</span> alertHandlers <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addAlertHandler</span><span style="color:#f92672">(</span>AlertHandler alertHandler<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">alertHandlers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>alertHandler<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>ApiStatInfo apiStatInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>AlertHandler handler <span style="color:#f92672">:</span> alertHandlers<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      handler<span style="color:#f92672">.</span><span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>apiStatInfo<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApiStatInfo</span> <span style="color:#f92672">{</span><span style="color:#75715e">//省略constructor/getter/setter方法
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> String api<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> requestCount<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> errorCount<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> durationOfSeconds<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AlertHandler</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">protected</span> AlertRule rule<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">protected</span> Notification notification<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AlertHandler</span><span style="color:#f92672">(</span>AlertRule rule<span style="color:#f92672">,</span> Notification notification<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rule</span> <span style="color:#f92672">=</span> rule<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">notification</span> <span style="color:#f92672">=</span> notification<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>ApiStatInfo apiStatInfo<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TpsAlertHandler</span> <span style="color:#66d9ef">extends</span> AlertHandler <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">TpsAlertHandler</span><span style="color:#f92672">(</span>AlertRule rule<span style="color:#f92672">,</span> Notification notification<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> notification<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>ApiStatInfo apiStatInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> tps <span style="color:#f92672">=</span> apiStatInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestCount</span><span style="color:#f92672">()/</span> apiStatInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getDurationOfSeconds</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tps <span style="color:#f92672">&gt;</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getMatchedRule</span><span style="color:#f92672">(</span>apiStatInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getApi</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">getMaxTps</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      notification<span style="color:#f92672">.</span><span style="color:#a6e22e">notify</span><span style="color:#f92672">(</span>NotificationEmergencyLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">URGENCY</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ErrorAlertHandler</span> <span style="color:#66d9ef">extends</span> AlertHandler <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ErrorAlertHandler</span><span style="color:#f92672">(</span>AlertRule rule<span style="color:#f92672">,</span> Notification notification<span style="color:#f92672">){</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>rule<span style="color:#f92672">,</span> notification<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>ApiStatInfo apiStatInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>apiStatInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getErrorCount</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> rule<span style="color:#f92672">.</span><span style="color:#a6e22e">getMatchedRule</span><span style="color:#f92672">(</span>apiStatInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getApi</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">getMaxErrorCount</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      notification<span style="color:#f92672">.</span><span style="color:#a6e22e">notify</span><span style="color:#f92672">(</span>NotificationEmergencyLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">SEVERE</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上面的代码是对Alert的重构，我们再来看下，重构之后的Alert该如何使用呢？具体的使用代码我也写在这里了。</p>
<p>其中，ApplicationContext是一个单例类，负责Alert的创建、组装（alertRule和notification的依赖注入）、初始化（添加handlers）工作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationContext</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> AlertRule alertRule<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Notification notification<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Alert alert<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initializeBeans</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    alertRule <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AlertRule<span style="color:#f92672">(</span><span style="color:#75715e">/*.省略参数.*/</span><span style="color:#f92672">);</span> <span style="color:#75715e">//省略一些初始化代码
</span><span style="color:#75715e"></span>    notification <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Notification<span style="color:#f92672">(</span><span style="color:#75715e">/*.省略参数.*/</span><span style="color:#f92672">);</span> <span style="color:#75715e">//省略一些初始化代码
</span><span style="color:#75715e"></span>    alert <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Alert<span style="color:#f92672">();</span>
    alert<span style="color:#f92672">.</span><span style="color:#a6e22e">addAlertHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TpsAlertHandler<span style="color:#f92672">(</span>alertRule<span style="color:#f92672">,</span> notification<span style="color:#f92672">));</span>
    alert<span style="color:#f92672">.</span><span style="color:#a6e22e">addAlertHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ErrorAlertHandler<span style="color:#f92672">(</span>alertRule<span style="color:#f92672">,</span> notification<span style="color:#f92672">));</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">public</span> Alert <span style="color:#a6e22e">getAlert</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> alert<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>

  <span style="color:#75715e">// 饿汉式单例
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ApplicationContext instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ApplicationContext<span style="color:#f92672">();</span>
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">ApplicationContext</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    initializeBeans<span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ApplicationContext <span style="color:#a6e22e">getInstance</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> instance<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Demo</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ApiStatInfo apiStatInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ApiStatInfo<span style="color:#f92672">();</span>
    <span style="color:#75715e">// ...省略设置apiStatInfo数据值的代码
</span><span style="color:#75715e"></span>    ApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAlert</span><span style="color:#f92672">().</span><span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>apiStatInfo<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>现在再来看下，基于重构之后的代码，如果再添加上面讲到的那个新功能，该如何改动代码？主要的改动有四处：</p>
<ul>
<li>第一处改动是：在ApiStatInfo类中添加新的属性timeoutCount。</li>
<li>第二处改动是：添加新的TimeoutAlertHander类。</li>
<li>第三处改动是：在ApplicationContext类的initializeBeans()方法中，往alert对象中注册新的timeoutAlertHandler。</li>
<li>第四处改动是：在使用Alert类的时候，需要给check()函数的入参apiStatInfo对象设置timeoutCount的值。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Alert</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// 代码未改动... }
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApiStatInfo</span> <span style="color:#f92672">{</span><span style="color:#75715e">//省略constructor/getter/setter方法
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> String api<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> requestCount<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> errorCount<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> durationOfSeconds<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> timeoutCount<span style="color:#f92672">;</span> <span style="color:#75715e">// 改动一：添加新字段
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AlertHandler</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//代码未改动... }
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TpsAlertHandler</span> <span style="color:#66d9ef">extends</span> AlertHandler <span style="color:#f92672">{</span><span style="color:#75715e">//代码未改动...}
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ErrorAlertHandler</span> <span style="color:#66d9ef">extends</span> AlertHandler <span style="color:#f92672">{</span><span style="color:#75715e">//代码未改动...}
</span><span style="color:#75715e">// 改动二：添加新的handler
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TimeoutAlertHandler</span> <span style="color:#66d9ef">extends</span> AlertHandler <span style="color:#f92672">{</span><span style="color:#75715e">//省略代码...}
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ApplicationContext</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> AlertRule alertRule<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Notification notification<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Alert alert<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">initializeBeans</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    alertRule <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AlertRule<span style="color:#f92672">(</span><span style="color:#75715e">/*.省略参数.*/</span><span style="color:#f92672">);</span> <span style="color:#75715e">//省略一些初始化代码
</span><span style="color:#75715e"></span>    notification <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Notification<span style="color:#f92672">(</span><span style="color:#75715e">/*.省略参数.*/</span><span style="color:#f92672">);</span> <span style="color:#75715e">//省略一些初始化代码
</span><span style="color:#75715e"></span>    alert <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Alert<span style="color:#f92672">();</span>
    alert<span style="color:#f92672">.</span><span style="color:#a6e22e">addAlertHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TpsAlertHandler<span style="color:#f92672">(</span>alertRule<span style="color:#f92672">,</span> notification<span style="color:#f92672">));</span>
    alert<span style="color:#f92672">.</span><span style="color:#a6e22e">addAlertHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ErrorAlertHandler<span style="color:#f92672">(</span>alertRule<span style="color:#f92672">,</span> notification<span style="color:#f92672">));</span>
    <span style="color:#75715e">// 改动三：注册handler
</span><span style="color:#75715e"></span>    alert<span style="color:#f92672">.</span><span style="color:#a6e22e">addAlertHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TimeoutAlertHandler<span style="color:#f92672">(</span>alertRule<span style="color:#f92672">,</span> notification<span style="color:#f92672">));</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...省略其他未改动代码...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Demo</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ApiStatInfo apiStatInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ApiStatInfo<span style="color:#f92672">();</span>
    <span style="color:#75715e">// ...省略apiStatInfo的set字段代码
</span><span style="color:#75715e"></span>    apiStatInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">setTimeoutCount</span><span style="color:#f92672">(</span>289<span style="color:#f92672">);</span> <span style="color:#75715e">// 改动四：设置tiemoutCount值
</span><span style="color:#75715e"></span>    ApplicationContext<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getAlert</span><span style="color:#f92672">().</span><span style="color:#a6e22e">check</span><span style="color:#f92672">(</span>apiStatInfo<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="修改代码就意味着违背开闭原则">修改代码就意味着违背开闭原则？</h3>
<p>上面的例子涉及了四处改动：</p>
<ul>
<li>第一处改动是：在ApiStatInfo类中添加新的属性timeoutCount。</li>
<li>第二处改动是：添加新的TimeoutAlertHander类。</li>
<li>第三处改动是：在ApplicationContext类的initializeBeans()方法中，往alert对象中注册新的timeoutAlertHandler。</li>
<li>第四处改动是：在使用Alert类的时候，需要给check()函数的入参apiStatInfo对象设置timeoutCount的值。</li>
</ul>
<p><strong>我们先来分析一下改动一：往ApiStatInfo类中添加新的属性timeoutCount。</strong></p>
<p>实际上，我们不仅往ApiStatInfo类中添加了属性，还添加了对应的getter/setter方法。那这个问题就转化为：给类中添加新的属性和方法，算作“修改”还是“扩展”？</p>
<p>我们再一块回忆一下开闭原则的定义：软件实体（模块、类、方法等）应该“对扩展开放、对修改关闭”。从定义中，我们可以看出，开闭原则可以应用在不同粒度的代码中，可以是模块，也可以类，还可以是方法（及其属性）。同样一个代码改动，在粗代码粒度下，被认定为“修改”，在细代码粒度下，又可以被认定为“扩展”。比如，改动一，添加属性和方法相当于修改类，在类这个层面，这个代码改动可以被认定为“修改”；但这个代码改动并没有修改已有的属性和方法，在方法（及其属性）这一层面，它又可以被认定为“扩展”。</p>
<p>实际上，我们也没必要纠结某个代码改动是“修改”还是“扩展”，更没必要太纠结它是否违反“开闭原则”。我们回到这条原则的设计初衷：只要它没有破坏原有的代码的正常运行，没有破坏原有的单元测试，我们就可以说，这是一个合格的代码改动。</p>
<p><strong>我们再来分析一下改动三和改动四：在ApplicationContext类的initializeBeans()方法中，往alert对象中注册新的timeoutAlertHandler；在使用Alert类的时候，需要给check()函数的入参apiStatInfo对象设置timeoutCount的值。</strong></p>
<p>这两处改动都是在方法内部进行的，不管从哪个层面（模块、类、方法）来讲，都不能算是“扩展”，而是地地道道的“修改”。不过，有些修改是在所难免的，是可以被接受的。为什么这么说呢？我来解释一下。</p>
<p>在重构之后的Alert代码中，我们的核心逻辑集中在Alert类及其各个handler中，当我们在添加新的告警逻辑的时候，Alert类完全不需要修改，而只需要扩展一个新handler类。如果我们把Alert类及各个handler类合起来看作一个“模块”，那模块本身在添加新的功能的时候，完全满足开闭原则。</p>
<p>而且，我们要认识到，添加一个新功能，不可能任何模块、类、方法的代码都不“修改”，这个是做不到的。类需要创建、组装、并且做一些初始化操作，才能构建成可运行的的程序，这部分代码的修改是在所难免的。我们要做的是尽量让修改操作更集中、更少、更上层，尽量让最核心、最复杂的那部分逻辑代码满足开闭原则。</p>
<h2 id="里式替换原则lsp">里式替换原则（LSP）</h2>
<p>里式替换原则的英文翻译是：Liskov Substitution Principle，缩写为LSP。这个原则最早是在1986年由Barbara Liskov提出，他是这么描述这条原则的：</p>
<blockquote>
<p>If S is a subtype of T, then objects of type T may be replaced with objects of type S, without breaking the program。</p>
</blockquote>
<p>在1996年，Robert Martin在他的SOLID原则中，重新描述了这个原则，英文原话是这样的：</p>
<blockquote>
<p>Functions that use pointers of references to base classes must be able to use objects of derived classes without knowing it。</p>
</blockquote>
<p>我们综合两者的描述，将这条原则用中文描述出来，是这样的：子类对象（object of subtype/derived class）能够替换程序（program）中父类对象（object of base/parent class）出现的任何地方，并且保证原来程序的逻辑行为（behavior）不变及正确性不被破坏。</p>
<h3 id="如何理解">如何理解？</h3>
<p>如下代码中，父类Transporter使用org.apache.http库中的HttpClient类来传输网络数据。子类SecurityTransporter继承父类Transporter，增加了额外的功能，支持传输appId和appToken安全认证信息。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Transporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> HttpClient httpClient<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Transporter</span><span style="color:#f92672">(</span>HttpClient httpClient<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">httpClient</span> <span style="color:#f92672">=</span> httpClient<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> Response <span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...use httpClient to send request
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityTransporter</span> <span style="color:#66d9ef">extends</span> Transporter <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> String appId<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String appToken<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SecurityTransporter</span><span style="color:#f92672">(</span>HttpClient httpClient<span style="color:#f92672">,</span> String appId<span style="color:#f92672">,</span> String appToken<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>httpClient<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">appId</span> <span style="color:#f92672">=</span> appId<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">appToken</span> <span style="color:#f92672">=</span> appToken<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> Response <span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isNotBlank</span><span style="color:#f92672">(</span>appId<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isNotBlank</span><span style="color:#f92672">(</span>appToken<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      request<span style="color:#f92672">.</span><span style="color:#a6e22e">addPayload</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;app-id&#34;</span><span style="color:#f92672">,</span> appId<span style="color:#f92672">);</span>
      request<span style="color:#f92672">.</span><span style="color:#a6e22e">addPayload</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;app-token&#34;</span><span style="color:#f92672">,</span> appToken<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Demo</span> <span style="color:#f92672">{</span>    
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">demoFunction</span><span style="color:#f92672">(</span>Transporter transporter<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>    
    Reuqest request <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Request<span style="color:#f92672">();</span>
    <span style="color:#75715e">//...省略设置request中数据值的代码...
</span><span style="color:#75715e"></span>    Response response <span style="color:#f92672">=</span> transporter<span style="color:#f92672">.</span><span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
    <span style="color:#75715e">//...省略其他逻辑...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 里式替换原则
</span><span style="color:#75715e"></span>Demo demo <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Demo<span style="color:#f92672">();</span>
demo<span style="color:#f92672">.</span><span style="color:#a6e22e">demofunction</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SecurityTransporter<span style="color:#f92672">(</span><span style="color:#75715e">/*省略参数*/</span><span style="color:#f92672">););</span>
</code></pre></div><p>在上面的代码中，子类SecurityTransporter的设计完全符合里式替换原则，可以替换父类出现的任何位置，并且原来代码的逻辑行为不变且正确性也没有被破坏。</p>
<p>不过，你可能会有这样的疑问，刚刚的代码设计不就是简单利用了面向对象的多态特性吗？多态和里式替换原则说的是不是一回事呢？从刚刚的例子和定义描述来看，里式替换原则跟多态看起来确实有点类似，但实际上它们完全是两回事。为什么这么说呢？</p>
<p>我们还是通过刚才这个例子来解释一下。不过，我们需要对SecurityTransporter类中sendRequest()函数稍加改造一下。改造前，如果appId或者appToken没有设置，我们就不做校验；改造后，如果appId或者appToken没有设置，则直接抛出NoAuthorizationRuntimeException未授权异常。改造前后的代码对比如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 改造前：
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityTransporter</span> <span style="color:#66d9ef">extends</span> Transporter <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略其他代码..
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> Response <span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isNotBlank</span><span style="color:#f92672">(</span>appId<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isNotBlank</span><span style="color:#f92672">(</span>appToken<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      request<span style="color:#f92672">.</span><span style="color:#a6e22e">addPayload</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;app-id&#34;</span><span style="color:#f92672">,</span> appId<span style="color:#f92672">);</span>
      request<span style="color:#f92672">.</span><span style="color:#a6e22e">addPayload</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;app-token&#34;</span><span style="color:#f92672">,</span> appToken<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 改造后：
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityTransporter</span> <span style="color:#66d9ef">extends</span> Transporter <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略其他代码..
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> Response <span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>Request request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>appId<span style="color:#f92672">)</span> <span style="color:#f92672">||</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>appToken<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> NoAuthorizationRuntimeException<span style="color:#f92672">(...);</span>
    <span style="color:#f92672">}</span>
    request<span style="color:#f92672">.</span><span style="color:#a6e22e">addPayload</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;app-id&#34;</span><span style="color:#f92672">,</span> appId<span style="color:#f92672">);</span>
    request<span style="color:#f92672">.</span><span style="color:#a6e22e">addPayload</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;app-token&#34;</span><span style="color:#f92672">,</span> appToken<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">super</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sendRequest</span><span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在改造之后的代码中，如果传递进demoFunction()函数的是父类Transporter对象，那demoFunction()函数并不会有异常抛出，但如果传递给demoFunction()函数的是子类SecurityTransporter对象，那demoFunction()有可能会有异常抛出。尽管代码中抛出的是运行时异常（Runtime Exception），我们可以不在代码中显式地捕获处理，但子类替换父类传递进demoFunction函数之后，整个程序的逻辑行为有了改变。</p>
<p>虽然改造之后的代码仍然可以通过Java的多态语法，动态地用子类SecurityTransporter来替换父类Transporter，也并不会导致程序编译或者运行报错。但是，从设计思路上来讲，SecurityTransporter的设计是不符合里式替换原则的。</p>
<h3 id="那些代码明显违背lsp">那些代码明显违背LSP？</h3>
<p>实际上，里式替换原则还有另外一个更加能落地、更有指导意义的描述，那就是“Design By Contract”，中文翻译就是“按照协议来设计”。</p>
<p>看起来比较抽象，我来进一步解读一下。子类在设计的时候，要遵守父类的行为约定（或者叫协议）。父类定义了函数的行为约定，那子类可以改变函数的内部实现逻辑，但不能改变函数原有的行为约定。这里的行为约定包括：函数声明要实现的功能；对输入、输出、异常的约定；甚至包括注释中所罗列的任何特殊说明。实际上，定义中父类和子类之间的关系，也可以替换成接口和实现类之间的关系。</p>
<p>为了更好地理解这句话，我举几个违反里式替换原则的例子来解释一下。</p>
<ol>
<li>子类违背父类声明要实现的功能</li>
</ol>
<p>父类中提供的sortOrdersByAmount()订单排序函数，是按照金额从小到大来给订单排序的，而子类重写这个sortOrdersByAmount()订单排序函数之后，是按照创建日期来给订单排序的。那子类的设计就违背里式替换原则。</p>
<ol start="2">
<li>子类违背父类对输入、输出、异常的约定</li>
</ol>
<p>在父类中，某个函数约定：运行出错的时候返回null；获取数据为空的时候返回空集合（empty collection）。而子类重载函数之后，实现变了，运行出错返回异常（exception），获取不到数据返回null。那子类的设计就违背里式替换原则。</p>
<p>在父类中，某个函数约定，输入数据可以是任意整数，但子类实现的时候，只允许输入数据是正整数，负数就抛出，也就是说，子类对输入的数据的校验比父类更加严格，那子类的设计就违背了里式替换原则。</p>
<p>在父类中，某个函数约定，只会抛出ArgumentNullException异常，那子类的设计实现中只允许抛出ArgumentNullException异常，任何其他异常的抛出，都会导致子类违背里式替换原则。</p>
<ol start="3">
<li>子类违背父类注释中所罗列的任何特殊说明</li>
</ol>
<p>父类中定义的withdraw()提现函数的注释是这么写的：“用户的提现金额不得超过账户余额……”，而子类重写withdraw()函数之后，针对VIP账号实现了透支提现的功能，也就是提现金额可以大于账户余额，那这个子类的设计也是不符合里式替换原则的。</p>
<p>以上便是三种典型的违背里式替换原则的情况。除此之外，判断子类的设计实现是否违背里式替换原则，还有一个小窍门，那就是拿父类的单元测试去验证子类的代码。如果某些单元测试运行失败，就有可能说明，子类的设计实现没有完全地遵守父类的约定，子类有可能违背了里式替换原则。</p>
<h2 id="接口隔离原则isp"><strong>接口隔离原则（ISP）</strong></h2>
<p>接口隔离原则的英文翻译是“ Interface Segregation Principle”，缩写为ISP。Robert Martin在SOLID原则中是这样定义它的：“Clients should not be forced to depend upon interfaces that they do not use。”直译成中文的话就是：客户端不应该被强迫依赖它不需要的接口。其中的“客户端”，可以理解为接口的调用者或者使用者。</p>
<p>实际上，“接口”这个名词可以用在很多场合中。生活中我们可以用它来指插座接口等。在软件开发中，我们既可以把它看作一组抽象的约定，也可以具体指系统与系统之间的API接口，还可以特指面向对象编程语言中的接口等。</p>
<h3 id="如何理解-1">如何理解？</h3>
<p>在这条原则中，我们可以把“接口”理解为下面三种东西：</p>
<ul>
<li>一组API接口集合</li>
<li>单个API接口或函数</li>
<li>OOP中的接口概念</li>
</ul>
<h4 id="把接口理解为一组api接口集合">把“接口”理解为一组API接口集合</h4>
<p>微服务用户系统提供了一组跟用户相关的API给其他系统使用，比如：注册、登录、获取用户信息等。具体代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserService</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">,</span> String password<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">login</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">,</span> String password<span style="color:#f92672">);</span>
  UserInfo <span style="color:#a6e22e">getUserInfoById</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> id<span style="color:#f92672">);</span>
  UserInfo <span style="color:#a6e22e">getUserInfoByCellphone</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserServiceImpl</span> <span style="color:#66d9ef">implements</span> UserService <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>现在，我们的后台管理系统要实现删除用户的功能，希望用户系统提供一个删除用户的接口。这个时候我们该如何来做呢？你可能会说，这不是很简单吗，我只需要在UserService中新添加一个deleteUserByCellphone()或deleteUserById()接口就可以了。这个方法可以解决问题，但是也隐藏了一些安全隐患。</p>
<p>删除用户是一个非常慎重的操作，我们只希望通过后台管理系统来执行，所以这个接口只限于给后台管理系统使用。如果我们把它放到UserService中，那所有使用到UserService的系统，都可以调用这个接口。不加限制地被其他业务系统调用，就有可能导致误删用户。</p>
<p>当然，最好的解决方案是从架构设计的层面，通过接口鉴权的方式来限制接口的调用。不过，如果暂时没有鉴权框架来支持，我们还可以从代码设计的层面，尽量避免接口被误用。我们参照接口隔离原则，调用者不应该强迫依赖它不需要的接口，将删除接口单独放到另外一个接口RestrictedUserService中，然后将RestrictedUserService只打包提供给后台管理系统来使用。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserService</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">,</span> String password<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">login</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">,</span> String password<span style="color:#f92672">);</span>
  UserInfo <span style="color:#a6e22e">getUserInfoById</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> id<span style="color:#f92672">);</span>
  UserInfo <span style="color:#a6e22e">getUserInfoByCellphone</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">RestrictedUserService</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">deleteUserByCellphone</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">deleteUserById</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> id<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserServiceImpl</span> <span style="color:#66d9ef">implements</span> UserService<span style="color:#f92672">,</span> RestrictedUserService <span style="color:#f92672">{</span>
  <span style="color:#75715e">// ...省略实现代码...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><h4 id="把接口理解为单个api接口或函数">把“接口”理解为单个API接口或函数</h4>
<p>现在我们再换一种理解方式，把接口理解为单个接口或函数。那接口隔离原则就可以理解为：函数的设计要功能单一，不要将多个不同的功能逻辑在一个函数中实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Statistics</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> Long max<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long min<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long average<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long sum<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long percentile99<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long percentile999<span style="color:#f92672">;</span>
  <span style="color:#75715e">//...省略constructor/getter/setter等方法...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> Statistics <span style="color:#a6e22e">count</span><span style="color:#f92672">(</span>Collection<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> dataSet<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  Statistics statistics <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Statistics<span style="color:#f92672">();</span>
  <span style="color:#75715e">//...省略计算逻辑...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> statistics<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在上面的代码中，count()函数的功能不够单一，包含很多不同的统计功能，比如，求最大值、最小值、平均值等等。按照接口隔离原则，我们应该把count()函数拆成几个更小粒度的函数，每个函数负责一个独立的统计功能。拆分之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> Long <span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>Collection<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> dataSet<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> Long <span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>Collection<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> dataSet<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... } 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> Long <span style="color:#a6e22e">average</span><span style="color:#f92672">(</span>Colletion<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> dataSet<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e">// ...省略其他统计函数...
</span></code></pre></div><h4 id="把接口理解为oop中的接口概念">把“接口”理解为OOP中的接口概念</h4>
<p>除了刚讲过的两种理解方式，我们还可以把“接口”理解为OOP中的接口概念，比如Java中的interface。</p>
<p>假设我们的项目中用到了三个外部系统：Redis、MySQL、Kafka。每个系统都对应一系列配置信息，比如地址、端口、访问超时时间等。为了在内存中存储这些配置信息，供项目中的其他模块来使用，我们分别设计实现了三个Configuration类：RedisConfig、MysqlConfig、KafkaConfig。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisConfig</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> ConfigSource configSource<span style="color:#f92672">;</span> <span style="color:#75715e">//配置中心（比如zookeeper）
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> String address<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> timeout<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> maxTotal<span style="color:#f92672">;</span>
    <span style="color:#75715e">//省略其他配置: maxWaitMillis,maxIdle,minIdle...
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">RedisConfig</span><span style="color:#f92672">(</span>ConfigSource configSource<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">configSource</span> <span style="color:#f92672">=</span> configSource<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getAddress</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">address</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//...省略其他get()、init()方法...
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">//从configSource加载配置到address/timeout/maxTotal...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KafkaConfig</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//...省略... }
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MysqlConfig</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//...省略... }
</span></code></pre></div><p>现在，我们有一个新的功能需求，希望支持Redis和Kafka配置信息的热更新。所谓“热更新（hot update）”就是，如果在配置中心中更改了配置信息，我们希望在不用重启系统的情况下，能将最新的配置信息加载到内存中（也就是RedisConfig、KafkaConfig类中）。但是，因为某些原因，我们并不希望对MySQL的配置信息进行热更新。</p>
<p>为了实现这样一个功能需求，我们设计实现了一个ScheduledUpdater类，以固定时间频率（periodInSeconds）来调用RedisConfig、KafkaConfig的update()方法更新配置信息。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Updater</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisConfig</span> <span style="color:#66d9ef">implements</span> Updater <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略其他属性和方法...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KafkaConfig</span> <span style="color:#66d9ef">implements</span> Updater <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略其他属性和方法...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MysqlConfig</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//...省略其他属性和方法... }
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduledUpdater</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ScheduledExecutorService executor <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newSingleThreadScheduledExecutor</span><span style="color:#f92672">();;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> initialDelayInSeconds<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> periodInSeconds<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> Updater updater<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ScheduleUpdater</span><span style="color:#f92672">(</span>Updater updater<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> initialDelayInSeconds<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> periodInSeconds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">updater</span> <span style="color:#f92672">=</span> updater<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initialDelayInSeconds</span> <span style="color:#f92672">=</span> initialDelayInSeconds<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">periodInSeconds</span> <span style="color:#f92672">=</span> periodInSeconds<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        executor<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
            <span style="color:#a6e22e">@Override</span>
            <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
                updater<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">();</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">},</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">initialDelayInSeconds</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">periodInSeconds</span><span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>
  ConfigSource configSource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ZookeeperConfigSource<span style="color:#f92672">(</span><span style="color:#75715e">/*省略参数*/</span><span style="color:#f92672">);</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> RedisConfig redisConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RedisConfig<span style="color:#f92672">(</span>configSource<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> KafkaConfig kafkaConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> KakfaConfig<span style="color:#f92672">(</span>configSource<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> MySqlConfig mysqlConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MysqlConfig<span style="color:#f92672">(</span>configSource<span style="color:#f92672">);</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ScheduledUpdater redisConfigUpdater <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ScheduledUpdater<span style="color:#f92672">(</span>redisConfig<span style="color:#f92672">,</span> 300<span style="color:#f92672">,</span> 300<span style="color:#f92672">);</span>
    redisConfigUpdater<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
    
    ScheduledUpdater kafkaConfigUpdater <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ScheduledUpdater<span style="color:#f92672">(</span>kafkaConfig<span style="color:#f92672">,</span> 60<span style="color:#f92672">,</span> 60<span style="color:#f92672">);</span>
    redisConfigUpdater<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>刚刚的热更新的需求我们已经搞定了。现在，我们又有了一个新的监控功能需求。通过命令行来查看Zookeeper中的配置信息是比较麻烦的。所以，我们希望能有一种更加方便的配置信息查看方式。</p>
<p>我们可以在项目中开发一个内嵌的SimpleHttpServer，输出项目的配置信息到一个固定的HTTP地址，比如：http://127.0.0.1:2389/config。我们只需要在浏览器中输入这个地址，就可以显示出系统的配置信息。不过，出于某些原因，我们只想暴露MySQL和Redis的配置信息，不想暴露Kafka的配置信息。</p>
<p>为了实现这样一个功能，我们还需要对上面的代码做进一步改造。改造之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Updater</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Viewer</span> <span style="color:#f92672">{</span>
  String <span style="color:#a6e22e">outputInPlainText</span><span style="color:#f92672">();</span>
  Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">output</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisConfig</span> implemets Updater<span style="color:#f92672">,</span> Viewer <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略其他属性和方法...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">outputInPlainText</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">output</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//...}
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KafkaConfig</span> <span style="color:#66d9ef">implements</span> Updater <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略其他属性和方法...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MysqlConfig</span> <span style="color:#66d9ef">implements</span> Viewer <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略其他属性和方法...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">outputInPlainText</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">output</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//...}
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleHttpServer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> String host<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Viewer<span style="color:#f92672">&gt;&gt;</span> viewers <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SimpleHttpServer</span><span style="color:#f92672">(</span>String host<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#75715e">//...}
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addViewers</span><span style="color:#f92672">(</span>String urlDirectory<span style="color:#f92672">,</span> Viewer viewer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>viewers<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>urlDirectory<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      viewers<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>urlDirectory<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>Viewer<span style="color:#f92672">&gt;());</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">viewers</span><span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>urlDirectory<span style="color:#f92672">).</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>viewer<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>
    ConfigSource configSource <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ZookeeperConfigSource<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> RedisConfig redisConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RedisConfig<span style="color:#f92672">(</span>configSource<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> KafkaConfig kafkaConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> KakfaConfig<span style="color:#f92672">(</span>configSource<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> MySqlConfig mysqlConfig <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MySqlConfig<span style="color:#f92672">(</span>configSource<span style="color:#f92672">);</span>
    
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        ScheduledUpdater redisConfigUpdater <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> ScheduledUpdater<span style="color:#f92672">(</span>redisConfig<span style="color:#f92672">,</span> 300<span style="color:#f92672">,</span> 300<span style="color:#f92672">);</span>
        redisConfigUpdater<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
        
        ScheduledUpdater kafkaConfigUpdater <span style="color:#f92672">=</span>
            <span style="color:#66d9ef">new</span> ScheduledUpdater<span style="color:#f92672">(</span>kafkaConfig<span style="color:#f92672">,</span> 60<span style="color:#f92672">,</span> 60<span style="color:#f92672">);</span>
        redisConfigUpdater<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
        
        SimpleHttpServer simpleHttpServer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SimpleHttpServer<span style="color:#f92672">(</span><span style="color:#960050;background-color:#1e0010">“</span>127<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">.</span><span style="color:#a6e22e">1</span><span style="color:#960050;background-color:#1e0010">”</span><span style="color:#f92672">,</span> 2389<span style="color:#f92672">);</span>
        simpleHttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">addViewer</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/config&#34;</span><span style="color:#f92672">,</span> redisConfig<span style="color:#f92672">);</span>
        simpleHttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">addViewer</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/config&#34;</span><span style="color:#f92672">,</span> mysqlConfig<span style="color:#f92672">);</span>
        simpleHttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>至此，热更新和监控的需求我们就都实现了。我们来回顾一下这个例子的设计思想。</p>
<p>我们设计了两个功能非常单一的接口：Updater和Viewer。ScheduledUpdater只依赖Updater这个跟热更新相关的接口，不需要被强迫去依赖不需要的Viewer接口，满足接口隔离原则。同理，SimpleHttpServer只依赖跟查看信息相关的Viewer接口，不依赖不需要的Updater接口，也满足接口隔离原则。</p>
<p>你可能会说，如果我们不遵守接口隔离原则，不设计Updater和Viewer两个小接口，而是设计一个大而全的Config接口，让RedisConfig、KafkaConfig、MysqlConfig都实现这个Config接口，并且将原来传递给ScheduledUpdater的Updater和传递给SimpleHttpServer的Viewer，都替换为Config，那会有什么问题呢？我们先来看一下，按照这个思路来实现的代码是什么样的。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Config</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update</span><span style="color:#f92672">();</span>
  String <span style="color:#a6e22e">outputInPlainText</span><span style="color:#f92672">();</span>
  Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">output</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisConfig</span> <span style="color:#66d9ef">implements</span> Config <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...需要实现Config的三个接口update/outputIn.../output
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">KafkaConfig</span> <span style="color:#66d9ef">implements</span> Config <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...需要实现Config的三个接口update/outputIn.../output
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MysqlConfig</span> <span style="color:#66d9ef">implements</span> Config <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...需要实现Config的三个接口update/outputIn.../output
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduledUpdater</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略其他属性和方法..
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> Config config<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ScheduleUpdater</span><span style="color:#f92672">(</span>Config config<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> initialDelayInSeconds<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> periodInSeconds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">config</span> <span style="color:#f92672">=</span> config<span style="color:#f92672">;</span>
      <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SimpleHttpServer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> String host<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Config<span style="color:#f92672">&gt;&gt;</span> viewers <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
 
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SimpleHttpServer</span><span style="color:#f92672">(</span>String host<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> port<span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#75715e">//...}
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addViewer</span><span style="color:#f92672">(</span>String urlDirectory<span style="color:#f92672">,</span> Config config<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>viewers<span style="color:#f92672">.</span><span style="color:#a6e22e">containsKey</span><span style="color:#f92672">(</span>urlDirectory<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      viewers<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>urlDirectory<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;</span>Config<span style="color:#f92672">&gt;());</span>
    <span style="color:#f92672">}</span>
    viewers<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>urlDirectory<span style="color:#f92672">).</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>config<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//... }
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>这样的设计思路也是能工作的，但是对比前后两个设计思路，在同样的代码量、实现复杂度、同等可读性的情况下：**第一种设计思路更加灵活、易扩展、易复用。**因为Updater、Viewer职责更加单一，单一就意味了通用、复用性好。比如，我们现在又有一个新的需求，开发一个Metrics性能统计模块，并且希望将Metrics也通过SimpleHttpServer显示在网页上，以方便查看。这个时候，尽管Metrics跟RedisConfig等没有任何关系，但我们仍然可以让Metrics类实现非常通用的Viewer接口，复用SimpleHttpServer的代码实现。**第二种设计思路在代码实现上做了一些无用功。**因为Config接口中包含两类不相关的接口，一类是update()，一类是output()和outputInPlainText()。理论上，KafkaConfig只需要实现update()接口，并不需要实现output()相关的接口。同理，MysqlConfig只需要实现output()相关接口，并需要实现update()接口。但第二种设计思路要求RedisConfig、KafkaConfig、MySqlConfig必须同时实现Config的所有接口函数（update、output、outputInPlainText）。除此之外，如果我们要往Config中继续添加一个新的接口，那所有的实现类都要改动。相反，如果我们的接口粒度比较小，那涉及改动的类就比较少。</p>
<h2 id="依赖反转原则">依赖反转原则</h2>
<h3 id="控制反转ioc">控制反转（IOC）</h3>
<p>控制反转的英文翻译是Inversion Of Control，缩写为IOC。此处要强调一下，如果你是Java工程师的话，暂时别把这个“IOC”跟Spring框架的IOC联系在一起。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserServiceTest</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">doTest</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ... 
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#75715e">//这部分逻辑可以放到框架中
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>doTest<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Test succeed.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Test failed.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在上面的代码中，所有的流程都由程序员来控制。如果我们抽象出一个下面这样一个框架，我们再来看，如何利用框架来实现同样的功能。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestCase</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>doTest<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Test succeed.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Test failed.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">doTest</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JunitApplication</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>TestCase<span style="color:#f92672">&gt;</span> testCases <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>TestCase testCase<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    testCases<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>testCase<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>TestCase <span style="color:#66d9ef">case</span><span style="color:#f92672">:</span> testCases<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">case</span><span style="color:#f92672">.</span><span style="color:#a6e22e">run</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>把这个简化版本的测试框架引入到工程中之后，我们只需要在框架预留的扩展点，也就是TestCase类中的doTest()抽象函数中，填充具体的测试代码就可以实现之前的功能了，完全不需要写负责执行流程的main()函数了。 具体的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserServiceTest</span> <span style="color:#66d9ef">extends</span> TestCase <span style="color:#f92672">{</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">doTest</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ... 
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 注册操作还可以通过配置的方式来实现，不需要程序员显示调用register()
</span><span style="color:#75715e"></span>JunitApplication<span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> UserServiceTest<span style="color:#f92672">();</span>
</code></pre></div><p>刚刚举的这个例子，就是典型的通过框架来实现“控制反转”的例子。框架提供了一个可扩展的代码骨架，用来组装对象、管理整个执行流程。程序员利用框架进行开发的时候，只需要往预留的扩展点上，添加跟自己业务相关的代码，就可以利用框架来驱动整个程序流程的执行。</p>
<p>这里的“控制”指的是对程序执行流程的控制，而“反转”指的是在没有使用框架之前，程序员自己控制整个程序的执行。在使用框架之后，整个程序的执行流程可以通过框架来控制。流程的控制权从程序员“反转”到了框架。</p>
<h3 id="依赖注入di">依赖注入（DI）</h3>
<p>依赖注入跟控制反转恰恰相反，它是一种具体的编码技巧。依赖注入的英文翻译是Dependency Injection，缩写为DI。对于这个概念，有一个非常形象的说法，那就是：依赖注入是一个标价25美元，实际上只值5美分的概念。也就是说，这个概念听起来很“高大上”，实际上，理解、应用起来非常简单。</p>
<p>那到底什么是依赖注入呢？我们用一句话来概括就是：不通过new()的方式在类内部创建依赖类对象，而是将依赖的类对象在外部创建好之后，通过构造函数、函数参数等方式传递（或注入）给类使用。</p>
<p>我们还是通过一个例子来解释一下。在这个例子中，Notification类负责消息推送，依赖MessageSender类实现推送商品促销、验证码等消息给用户。我们分别用依赖注入和非依赖注入两种方式来实现一下。具体的实现代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 非依赖注入实现方式
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Notification</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> MessageSender messageSender<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Notification</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageSender</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageSender<span style="color:#f92672">();</span> <span style="color:#75715e">//此处有点像hardcode
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendMessage</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">,</span> String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...省略校验逻辑等...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageSender</span><span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>cellphone<span style="color:#f92672">,</span> message<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MessageSender</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">,</span> String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//....
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// 使用Notification
</span><span style="color:#75715e"></span>Notification notification <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Notification<span style="color:#f92672">();</span>

<span style="color:#75715e">// 依赖注入的实现方式
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Notification</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> MessageSender messageSender<span style="color:#f92672">;</span>
  
  <span style="color:#75715e">// 通过构造函数将messageSender传递进来
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Notification</span><span style="color:#f92672">(</span>MessageSender messageSender<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageSender</span> <span style="color:#f92672">=</span> messageSender<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sendMessage</span><span style="color:#f92672">(</span>String cellphone<span style="color:#f92672">,</span> String message<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...省略校验逻辑等...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">messageSender</span><span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>cellphone<span style="color:#f92672">,</span> message<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">//使用Notification
</span><span style="color:#75715e"></span>MessageSender messageSender <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MessageSender<span style="color:#f92672">();</span>
Notification notification <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Notification<span style="color:#f92672">(</span>messageSender<span style="color:#f92672">);</span>
</code></pre></div><p>通过依赖注入的方式来将依赖的类对象传递进来，这样就提高了代码的扩展性，我们可以灵活地替换依赖的类。这一点在我们之前讲“开闭原则”的时候也提到过。当然，上面代码还有继续优化的空间，我们还可以把MessageSender定义成接口，基于接口而非实现编程。</p>
<h3 id="依赖注入框架di-framework">依赖注入框架（DI Framework）</h3>
<p>弄懂了什么是“依赖注入”，我们再来看一下，什么是“依赖注入框架”。我们还是借用刚刚的例子来解释。</p>
<p>在采用依赖注入实现的Notification类中，虽然我们不需要用类似hard code的方式，在类内部通过new来创建MessageSender对象，但是，这个创建对象、组装（或注入）对象的工作仅仅是被移动到了更上层代码而已，还是需要我们程序员自己来实现。具体代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Demo</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String args<span style="color:#f92672">[])</span> <span style="color:#f92672">{</span>
    MessageSender sender <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SmsSender<span style="color:#f92672">();</span> <span style="color:#75715e">//创建对象
</span><span style="color:#75715e"></span>    Notification notification <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Notification<span style="color:#f92672">(</span>sender<span style="color:#f92672">);</span><span style="color:#75715e">//依赖注入
</span><span style="color:#75715e"></span>    notification<span style="color:#f92672">.</span><span style="color:#a6e22e">sendMessage</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;13918942177&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;短信验证码：2346&#34;</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在实际的软件开发中，一些项目可能会涉及几十、上百、甚至几百个类，类对象的创建和依赖注入会变得非常复杂。如果这部分工作都是靠程序员自己写代码来完成，容易出错且开发成本也比较高。而对象创建和依赖注入的工作，本身跟具体的业务无关，我们完全可以抽象成框架来自动完成。</p>
<p>你可能已经猜到，这个框架就是“依赖注入框架”。我们只需要通过依赖注入框架提供的扩展点，简单配置一下所有需要创建的类对象、类与类之间的依赖关系，就可以实现由框架来自动创建对象、管理对象的生命周期、依赖注入等原本需要程序员来做的事情。</p>
<h3 id="依赖反转原则dip">依赖反转原则（DIP）</h3>
<p>依赖反转原则的英文翻译是Dependency Inversion Principle，缩写为DIP。中文翻译有时候也叫依赖倒置原则。为了追本溯源，先给出这条原则最原汁原味的英文描述：</p>
<p>High-level modules shouldn’t depend on low-level modules. Both modules should depend on abstractions. In addition, abstractions shouldn’t depend on details. Details depend on abstractions.</p>
<p>我们将它翻译成中文，大概意思就是：高层模块（high-level modules）不要依赖低层模块（low-level）。高层模块和低层模块应该通过抽象（abstractions）来互相依赖。除此之外，抽象（abstractions）不要依赖具体实现细节（details），具体实现细节（details）依赖抽象（abstractions）。</p>
<p>所谓高层模块和低层模块的划分，简单来说就是，在调用链上，调用者属于高层，被调用者属于低层。在平时的业务代码开发中，高层模块依赖底层模块是没有任何问题的。实际上，这条原则主要还是用来指导框架层面的设计，跟前面讲到的控制反转类似。</p>
<h2 id="kiss原则">KISS原则</h2>
<p>KISS原则的英文描述有好几个版本，比如下面这几个。</p>
<ul>
<li>Keep It Simple and Stupid.</li>
<li>Keep It Short and Simple.</li>
<li>Keep It Simple and Straightforward.</li>
</ul>
<p>不过，仔细看你就会发现，它们要表达的意思其实差不多，翻译成中文就是：尽量保持简单。</p>
<p>写出满足KISS原则代码的方法：</p>
<ul>
<li>不要使用同事可能不懂的技术来实现代码。比如前面例子中的正则表达式，还有一些编程语言中过于高级的语法等。</li>
<li>不要重复造轮子，要善于使用已经有的工具类库。经验证明，自己去实现这些类库，出bug的概率会更高，维护的成本也比较高。</li>
<li>不要过度优化。不要过度使用一些奇技淫巧（比如，位运算代替算术运算、复杂的条件语句代替if-else、使用一些过于底层的函数等）来优化代码，牺牲代码的可读性。</li>
</ul>
<p>YAGNI原则的英文全称是：You Ain’t Gonna Need It。直译就是：你不会需要它。这条原则也算是万金油了。当用在软件开发中的时候，它的意思是：不要去设计当前用不到的功能；不要去编写当前用不到的代码。实际上，这条原则的核心思想就是：不要做过度设计。</p>
<p>YAGNI原则跟KISS原则并非一回事儿。KISS原则讲的是“如何做”的问题（尽量保持简单），而YAGNI原则说的是“要不要做”的问题（当前不需要的就不要做）。</p>
<h2 id="dry原则">DRY原则</h2>
<p>DRY原则的英文描述为：Don’t Repeat Yourself。中文直译为：不要重复自己。将它应用在编程中，可以理解为：不要写重复的代码。</p>
<p>三种典型的代码重复情况分别是：实现逻辑重复、功能语义重复和代码执行重复。这三种代码重复，有的看似违反DRY，实际上并不违反；有的看似不违反，实际上却违反了。</p>
<h3 id="实现逻辑重复">实现逻辑重复</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserAuthenticator</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">,</span> String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isValidUsername<span style="color:#f92672">(</span>username<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ...throw InvalidUsernameException...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isValidPassword<span style="color:#f92672">(</span>password<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ...throw InvalidPasswordException...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//...省略其他代码...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isValidUsername</span><span style="color:#f92672">(</span>String username<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// check not null, not empty
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>username<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// check length: 4~64
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> length <span style="color:#f92672">=</span> username<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>length <span style="color:#f92672">&lt;</span> 4 <span style="color:#f92672">||</span> length <span style="color:#f92672">&gt;</span> 64<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// contains only lowcase characters
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isAllLowerCase</span><span style="color:#f92672">(</span>username<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// contains only a~z,0~9,dot
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> length<span style="color:#f92672">;</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">char</span> c <span style="color:#f92672">=</span> username<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>c <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> c <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isValidPassword</span><span style="color:#f92672">(</span>String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// check not null, not empty
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>password<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// check length: 4~64
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> length <span style="color:#f92672">=</span> password<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>length <span style="color:#f92672">&lt;</span> 4 <span style="color:#f92672">||</span> length <span style="color:#f92672">&gt;</span> 64<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// contains only lowcase characters
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isAllLowerCase</span><span style="color:#f92672">(</span>password<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">// contains only a~z,0~9,dot
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> length<span style="color:#f92672">;</span> <span style="color:#f92672">++</span>i<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">char</span> c <span style="color:#f92672">=</span> password<span style="color:#f92672">.</span><span style="color:#a6e22e">charAt</span><span style="color:#f92672">(</span>i<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>c <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>c <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> c <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在代码中，有两处非常明显的重复的代码片段：isValidUserName()函数和isValidPassword()函数。重复的代码被敲了两遍，或者简单copy-paste了一下，看起来明显违反DRY原则。为了移除重复的代码，我们对上面的代码做下重构，将isValidUserName()函数和isValidPassword()函数，合并为一个更通用的函数isValidUserNameOrPassword()。重构后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserAuthenticatorV2</span> <span style="color:#f92672">{</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">authenticate</span><span style="color:#f92672">(</span>String userName<span style="color:#f92672">,</span> String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isValidUsernameOrPassword<span style="color:#f92672">(</span>userName<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ...throw InvalidUsernameException...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isValidUsernameOrPassword<span style="color:#f92672">(</span>password<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ...throw InvalidPasswordException...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isValidUsernameOrPassword</span><span style="color:#f92672">(</span>String usernameOrPassword<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//省略实现逻辑
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//跟原来的isValidUsername()或isValidPassword()的实现逻辑一样...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>经过重构之后，代码行数减少了，也没有重复的代码了，是不是更好了呢？答案是否定的，这可能跟你预期的不一样，我来解释一下为什么。</p>
<p>单从名字上看，我们就能发现，合并之后的isValidUserNameOrPassword()函数，负责两件事情：验证用户名和验证密码，违反了“单一职责原则”和“接口隔离原则”。实际上，即便将两个函数合并成isValidUserNameOrPassword()，代码仍然存在问题。</p>
<p>因为isValidUserName()和isValidPassword()两个函数，虽然从代码实现逻辑上看起来是重复的，但是从语义上并不重复。所谓“语义不重复”指的是：从功能上来看，这两个函数干的是完全不重复的两件事情，一个是校验用户名，另一个是校验密码。尽管在目前的设计中，两个校验逻辑是完全一样的，但如果按照第二种写法，将两个函数的合并，那就会存在潜在的问题。</p>
<h3 id="功能语义重复">功能语义重复</h3>
<p>在同一个项目代码中有下面两个函数：isValidIp()和checkIfIpValid()。尽管两个函数的命名不同，实现逻辑不同，但功能是相同的，都是用来判定IP地址是否合法的。</p>
<p>之所以在同一个项目中会有两个功能相同的函数，那是因为这两个函数是由两个不同的同事开发的，其中一个同事在不知道已经有了isValidIp()的情况下，自己又定义并实现了同样用来校验IP地址是否合法的checkIfIpValid()函数。</p>
<p>那在同一项目代码中，存在如下两个函数，是否违反DRY原则呢？</p>
<p>上一个例子是代码实现逻辑重复，但语义不重复，我们并不认为它违反了DRY原则。而在这个例子中，尽管两段代码的实现逻辑不重复，但语义重复，也就是功能重复，我们认为它违反了DRY原则。我们应该在项目中，统一一种实现思路，所有用到判断IP地址是否合法的地方，都统一调用同一个函数。</p>
<h3 id="代码执行重复">代码执行重复</h3>
<p>UserService中login()函数用来校验用户登录是否成功。如果失败，就返回异常；如果成功，就返回用户信息。具体代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserService</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> UserRepo userRepo<span style="color:#f92672">;</span><span style="color:#75715e">//通过依赖注入或者IOC框架注入
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">login</span><span style="color:#f92672">(</span>String email<span style="color:#f92672">,</span> String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">boolean</span> existed <span style="color:#f92672">=</span> userRepo<span style="color:#f92672">.</span><span style="color:#a6e22e">checkIfUserExisted</span><span style="color:#f92672">(</span>email<span style="color:#f92672">,</span> password<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>existed<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ... throw AuthenticationFailureException...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    User user <span style="color:#f92672">=</span> userRepo<span style="color:#f92672">.</span><span style="color:#a6e22e">getUserByEmail</span><span style="color:#f92672">(</span>email<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> user<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserRepo</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">checkIfUserExisted</span><span style="color:#f92672">(</span>String email<span style="color:#f92672">,</span> String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>EmailValidation<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>email<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ... throw InvalidEmailException...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>PasswordValidation<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>password<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ... throw InvalidPasswordException...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>

    <span style="color:#75715e">//...query db to check if email&amp;password exists...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUserByEmail</span><span style="color:#f92672">(</span>String email<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>EmailValidation<span style="color:#f92672">.</span><span style="color:#a6e22e">validate</span><span style="color:#f92672">(</span>email<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ... throw InvalidEmailException...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//...query db to get user by email...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在login()函数中，email的校验逻辑被执行了两次。一次是在调用checkIfUserExisted()函数的时候，另一次是调用getUserByEmail()函数的时候。这个问题解决起来比较简单，我们只需要将校验逻辑从UserRepo中移除，统一放到UserService中就可以了。</p>
<p>除此之外，代码中还有一处比较隐蔽的执行重复，实际上，login()函数并不需要调用checkIfUserExisted()函数，只需要调用一次getUserByEmail()函数，从数据库中获取到用户的email、password等信息，然后跟用户输入的email、password信息做对比，依次判断是否登录成功。</p>
<p>实际上，这样的优化是很有必要的。因为checkIfUserExisted()函数和getUserByEmail()函数都需要查询数据库，而数据库这类的I/O操作是比较耗时的。我们在写代码的时候，应当尽量减少这类I/O操作。</p>
<h2 id="代码复用性code-reusability">代码复用性（Code Reusability）</h2>
<p>代码复用（Code Resue）表示一种行为：我们在开发新功能的时候，尽量复用已经存在的代码。代码的可复用性（Code Reusability）表示一段代码可被复用的特性或能力：我们在编写代码的时候，让代码尽量可复用。DRY原则是一条原则：不要写重复的代码。从定义描述上，它们好像有点类似，但深究起来，三者的区别还是蛮大的。</p>
<p>**首先，“不重复”并不代表“可复用”。**在一个项目代码中，可能不存在任何重复的代码，但也并不表示里面有可复用的代码，不重复和可复用完全是两个概念。所以，从这个角度来说，DRY原则跟代码的可复用性讲的是两回事。</p>
<p>**其次，“复用”和“可复用性”关注角度不同。**代码“可复用性”是从代码开发者的角度来讲的，“复用”是从代码使用者的角度来讲的。比如，A同事编写了一个UrlUtils类，代码的“可复用性”很好。B同事在开发新功能的时候，直接“复用”A同事编写的UrlUtils类。</p>
<h3 id="怎么提高代码复用性">怎么提高代码复用性？</h3>
<ul>
<li>减少代码耦合</li>
</ul>
<p>对于高度耦合的代码，当我们希望复用其中的一个功能，想把这个功能的代码抽取出来成为一个独立的模块、类或者函数的时候，往往会发现牵一发而动全身。移动一点代码，就要牵连到很多其他相关的代码。所以，高度耦合的代码会影响到代码的复用性，我们要尽量减少代码耦合。</p>
<ul>
<li>满足单一职责原则</li>
</ul>
<p>我们前面讲过，如果职责不够单一，模块、类设计得大而全，那依赖它的代码或者它依赖的代码就会比较多，进而增加了代码的耦合。根据上一点，也就会影响到代码的复用性。相反，越细粒度的代码，代码的通用性会越好，越容易被复用。</p>
<ul>
<li>模块化</li>
</ul>
<p>这里的“模块”，不单单指一组类构成的模块，还可以理解为单个类、函数。我们要善于将功能独立的代码，封装成模块。独立的模块就像一块一块的积木，更加容易复用，可以直接拿来搭建更加复杂的系统。</p>
<ul>
<li>业务与非业务逻辑分离</li>
</ul>
<p>越是跟业务无关的代码越是容易复用，越是针对特定业务的代码越难复用。所以，为了复用跟业务无关的代码，我们将业务和非业务逻辑代码分离，抽取成一些通用的框架、类库、组件等。</p>
<ul>
<li>通用代码下沉</li>
</ul>
<p>从分层的角度来看，越底层的代码越通用、会被越多的模块调用，越应该设计得足够可复用。一般情况下，在代码分层之后，为了避免交叉调用导致调用关系混乱，我们只允许上层代码调用下层代码及同层代码之间的调用，杜绝下层代码调用上层代码。所以，通用的代码我们尽量下沉到更下层。</p>
<ul>
<li>继承、多态、抽象、封装</li>
</ul>
<p>在讲面向对象特性的时候，我们讲到，利用继承，可以将公共的代码抽取到父类，子类复用父类的属性和方法。利用多态，我们可以动态地替换一段代码的部分逻辑，让这段代码可复用。除此之外，抽象和封装，从更加广义的层面、而非狭义的面向对象特性的层面来理解的话，越抽象、越不依赖具体的实现，越容易复用。代码封装成模块，隐藏可变的细节、暴露不变的接口，就越容易复用。</p>
<ul>
<li>应用模板等设计模式</li>
</ul>
<p>一些设计模式，也能提高代码的复用性。比如，模板模式利用了多态来实现，可以灵活地替换其中的部分代码，整个流程模板代码可复用。</p>
<h2 id="迪米特法则">迪米特法则</h2>
<h3 id="高内聚松耦合">“高内聚、松耦合”</h3>
<p>“高内聚、松耦合”是一个非常重要的设计思想，能够有效地提高代码的可读性和可维护性，缩小功能改动导致的代码改动范围。在这个设计思想中，“高内聚”用来指导类本身的设计，“松耦合”用来指导类与类之间依赖关系的设计。不过，这两者并非完全独立不相干。高内聚有助于松耦合，松耦合又需要高内聚的支持。</p>
<p>所谓高内聚，就是指相近的功能应该放到同一个类中，不相近的功能不要放到同一个类中。相近的功能往往会被同时修改，放到同一个类中，修改会比较集中，代码容易维护。</p>
<p>所谓松耦合是说，在代码中，类与类之间的依赖关系简单清晰。即使两个类有依赖关系，一个类的代码改动不会或者很少导致依赖类的代码改动。</p>
<h3 id="迪米特法则理论描述">迪米特法则理论描述</h3>
<p>迪米特法则的英文翻译是：Law of Demeter，缩写是LOD。它还有另外一个更加达意的名字，叫作最小知识原则，英文翻译为：The Least Knowledge Principle。英文定义：</p>
<blockquote>
<p>Each unit should have only limited knowledge about other units: only units “closely” related to the current unit. Or: Each unit should only talk to its friends; Don’t talk to strangers.</p>
</blockquote>
<p>我们把它直译成中文，就是下面这个样子：</p>
<blockquote>
<p>每个模块（unit）只应该了解那些与它关系密切的模块（units: only units “closely” related to the current unit）的有限知识（knowledge）。或者说，每个模块只和自己的朋友“说话”（talk），不和陌生人“说话”（talk）。</p>
</blockquote>
<h3 id="代码example1">代码example1</h3>
<p><strong>“不该有直接依赖关系的类之间，不要有依赖”</strong></p>
<p>这个例子实现了简化版的搜索引擎爬取网页的功能。代码中包含三个主要的类。其中，NetworkTransporter类负责底层网络通信，根据请求获取数据；HtmlDownloader类用来通过URL获取网页；Document表示网页文档，后续的网页内容抽取、分词、索引都是以此为处理对象。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NetworkTransporter</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 省略属性和其他方法...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> Byte<span style="color:#f92672">[]</span> <span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>HtmlRequest htmlRequest<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HtmlDownloader</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> NetworkTransporter transporter<span style="color:#f92672">;</span><span style="color:#75715e">//通过构造函数或IOC注入
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> Html <span style="color:#a6e22e">downloadHtml</span><span style="color:#f92672">(</span>String url<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Byte<span style="color:#f92672">[]</span> rawHtml <span style="color:#f92672">=</span> transporter<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> HtmlRequest<span style="color:#f92672">(</span>url<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Html<span style="color:#f92672">(</span>rawHtml<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Document</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> Html html<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String url<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Document</span><span style="color:#f92672">(</span>String url<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> url<span style="color:#f92672">;</span>
    HtmlDownloader downloader <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HtmlDownloader<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">html</span> <span style="color:#f92672">=</span> downloader<span style="color:#f92672">.</span><span style="color:#a6e22e">downloadHtml</span><span style="color:#f92672">(</span>url<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>**首先，我们来看NetworkTransporter类。**作为一个底层网络通信类，我们希望它的功能尽可能通用，而不只是服务于下载HTML，所以，我们不应该直接依赖太具体的发送对象HtmlRequest。从这一点上讲，NetworkTransporter类的设计违背迪米特法则，依赖了不该有直接依赖关系的HtmlRequest类。</p>
<p>我们应该如何进行重构，让NetworkTransporter类满足迪米特法则呢？我这里有个形象的比喻。假如你现在要去商店买东西，你肯定不会直接把钱包给收银员，让收银员自己从里面拿钱，而是你从钱包里把钱拿出来交给收银员。这里的HtmlRequest对象就相当于钱包，HtmlRequest里的address和content对象就相当于钱。我们应该把address和content交给NetworkTransporter，而非是直接把HtmlRequest交给NetworkTransporter。</p>
<p>**我们再来看HtmlDownloader类。**这个类的设计没有问题。不过，我们修改了NetworkTransporter的send()函数的定义，而这个类用到了send()函数，所以我们需要对它做相应的修改。</p>
<p>**最后，我们来看下Document类。**这个类的问题比较多，主要有三点。第一，构造函数中的downloader.downloadHtml()逻辑复杂，耗时长，不应该放到构造函数中，会影响代码的可测试性。代码的可测试性我们后面会讲到，这里你先知道有这回事就可以了。第二，HtmlDownloader对象在构造函数中通过new来创建，违反了基于接口而非实现编程的设计思想，也会影响到代码的可测试性。第三，从业务含义上来讲，Document网页文档没必要依赖HtmlDownloader类，违背了迪米特法则。</p>
<p>修改之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NetworkTransporter</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 省略属性和其他方法...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> Byte<span style="color:#f92672">[]</span> <span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>String address<span style="color:#f92672">,</span> Byte<span style="color:#f92672">[]</span> data<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HtmlDownloader</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> NetworkTransporter transporter<span style="color:#f92672">;</span><span style="color:#75715e">//通过构造函数或IOC注入
</span><span style="color:#75715e"></span>  
  <span style="color:#75715e">// HtmlDownloader这里也要有相应的修改
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> Html <span style="color:#a6e22e">downloadHtml</span><span style="color:#f92672">(</span>String url<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    HtmlRequest htmlRequest <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HtmlRequest<span style="color:#f92672">(</span>url<span style="color:#f92672">);</span>
    Byte<span style="color:#f92672">[]</span> rawHtml <span style="color:#f92672">=</span> transporter<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>
      htmlRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getAddress</span><span style="color:#f92672">(),</span> htmlRequest<span style="color:#f92672">.</span><span style="color:#a6e22e">getContent</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Html<span style="color:#f92672">(</span>rawHtml<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Document</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> Html html<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String url<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Document</span><span style="color:#f92672">(</span>String url<span style="color:#f92672">,</span> Html html<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">html</span> <span style="color:#f92672">=</span> html<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">url</span> <span style="color:#f92672">=</span> url<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#75715e">// 通过一个工厂方法来创建Document
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DocumentFactory</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> HtmlDownloader downloader<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">DocumentFactory</span><span style="color:#f92672">(</span>HtmlDownloader downloader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">downloader</span> <span style="color:#f92672">=</span> downloader<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> Document <span style="color:#a6e22e">createDocument</span><span style="color:#f92672">(</span>String url<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Html html <span style="color:#f92672">=</span> downloader<span style="color:#f92672">.</span><span style="color:#a6e22e">downloadHtml</span><span style="color:#f92672">(</span>url<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Document<span style="color:#f92672">(</span>url<span style="color:#f92672">,</span> html<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="代码example2">代码example2</h3>
<p><strong>“有依赖关系的类之间，尽量只依赖必要的接口”</strong></p>
<p>下面这段代码非常简单，Serialization类负责对象的序列化和反序列化。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Serialization</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">serialize</span><span style="color:#f92672">(</span>Object object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String serializedResult <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> serializedResult<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">deserialize</span><span style="color:#f92672">(</span>String str<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object deserializedResult <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> deserializedResult<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>单看这个类的设计，没有一点问题。不过，如果我们把它放到一定的应用场景里，那就还有继续优化的空间。假设在我们的项目中，有些类只用到了序列化操作，而另一些类只用到反序列化操作。那基于迪米特法则后半部分“有依赖关系的类之间，尽量只依赖必要的接口”，只用到序列化操作的那部分类不应该依赖反序列化接口。同理，只用到反序列化操作的那部分类不应该依赖序列化接口。</p>
<p>根据这个思路，我们应该将Serialization类拆分为两个更小粒度的类，一个只负责序列化（Serializer类），一个只负责反序列化（Deserializer类）。拆分之后，使用序列化操作的类只需要依赖Serializer类，使用反序列化操作的类只需要依赖Deserializer类。拆分之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Serializer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">serialize</span><span style="color:#f92672">(</span>Object object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String serializedResult <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> serializedResult<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Deserializer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">deserialize</span><span style="color:#f92672">(</span>String str<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object deserializedResult <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> deserializedResult<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>不知道你有没有看出来，尽管拆分之后的代码更能满足迪米特法则，但却违背了高内聚的设计思想。高内聚要求相近的功能要放到同一个类中，这样可以方便功能修改的时候，修改的地方不至于过于分散。对于刚刚这个例子来说，如果我们修改了序列化的实现方式，比如从JSON换成了XML，那反序列化的实现逻辑也需要一并修改。在未拆分的情况下，我们只需要修改一个类即可。在拆分之后，我们需要修改两个类。显然，这种设计思路的代码改动范围变大了。</p>
<p>如果我们既不想违背高内聚的设计思想，也不想违背迪米特法则，那我们该如何解决这个问题呢？实际上，通过引入两个接口就能轻松解决这个问题，具体的代码如下所示。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Serializable</span> <span style="color:#f92672">{</span>
  String <span style="color:#a6e22e">serialize</span><span style="color:#f92672">(</span>Object object<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Deserializable</span> <span style="color:#f92672">{</span>
  Object <span style="color:#a6e22e">deserialize</span><span style="color:#f92672">(</span>String text<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Serialization</span> <span style="color:#66d9ef">implements</span> Serializable<span style="color:#f92672">,</span> Deserializable <span style="color:#f92672">{</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">serialize</span><span style="color:#f92672">(</span>Object object<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String serializedResult <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> serializedResult<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">deserialize</span><span style="color:#f92672">(</span>String str<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object deserializedResult <span style="color:#f92672">=</span> <span style="color:#f92672">...;</span>
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">return</span> deserializedResult<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DemoClass_1</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> Serializable serializer<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Demo</span><span style="color:#f92672">(</span>Serializable serializer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">serializer</span> <span style="color:#f92672">=</span> serializer<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DemoClass_2</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> Deserializable deserializer<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Demo</span><span style="color:#f92672">(</span>Deserializable deserializer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">deserializer</span> <span style="color:#f92672">=</span> deserializer<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>尽管我们还是要往DemoClass_1的构造函数中，传入包含序列化和反序列化的Serialization实现类，但是，我们依赖的Serializable接口只包含序列化操作，DemoClass_1无法使用Serialization类中的反序列化接口，对反序列化操作无感知，这也就符合了迪米特法则后半部分所说的“依赖有限接口”的要求。</p>
<p>实际上，上面的的代码实现思路，也体现了“基于接口而非实现编程”的设计原则，结合迪米特法则，我们可以总结出一条新的设计原则，那就是“基于最小接口而非最大实现编程”。</p>
<h2 id="业务开发实战积分兑换系统">业务开发实战：积分兑换系统</h2>
<h3 id="需求分析-1">需求分析</h3>
<p>积分是一种常见的营销手段，很多产品都会通过它来促进消费、增加用户粘性，比如淘宝积分、信用卡积分、商场消费积分等等。假设你是一家类似淘宝这样的电商平台的工程师，平台暂时还没有积分系统。Leader希望由你来负责开发这样一个系统，你会如何来做呢？</p>
<p>我们可以找几个类似的产品，比如淘宝，看看它们是如何设计积分系统的，然后借鉴到我们的产品中。你可以自己亲自用用淘宝，看看积分是怎么使用的，也可以直接百度一下“淘宝积分规则”。基于这两个输入，我们基本上就大致能摸清楚积分系统该如何设计了。除此之外，我们还要充分了解自己公司的产品，将借鉴来的东西糅合在我们自己的产品中，并做适当的微创新。</p>
<p>笼统地来讲，积分系统无外乎就两个大的功能点，一个是赚取积分，另一个是消费积分。赚取积分功能包括积分赚取渠道，比如下订单、每日签到、评论等；还包括积分兑换规则，比如订单金额与积分的兑换比例，每日签到赠送多少积分等。消费积分功能包括积分消费渠道，比如抵扣订单金额、兑换优惠券、积分换购、参与活动扣积分等；还包括积分兑换规则，比如多少积分可以换算成抵扣订单的多少金额，一张优惠券需要多少积分来兑换等等。</p>
<p>刚刚给出的只是非常笼统、粗糙的功能需求。在实际情况中，肯定还有一些业务细节需要考虑，比如积分的有效期问题。对于这些业务细节，还是那句话，闷头拍脑袋想是想不全面的。以防遗漏，我们还是要有方法可寻。那除了刚刚讲的“借鉴”的思路之外，我还喜欢通过产品的<strong>线框图</strong>、<strong>用户用例</strong>（user case ）或者叫用户故事（user story）来细化业务流程，挖掘一些比较细节的、不容易想到的功能点。</p>
<p>线框图对你来说应该不陌生，我就不赘述了，我这里重点说一下用户用例。用户用例有点儿类似我们后面要讲的单元测试用例。它侧重情景化，其实就是模拟用户如何使用我们的产品，描述用户在一个特定的应用场景里的一个完整的业务操作流程。所以，它包含更多的细节，且更加容易被人理解。比如，有关积分有效期的用户用例，我们可以进行如下的设计：</p>
<ul>
<li>用户在获取积分的时候，会告知积分的有效期；</li>
<li>用户在使用积分的时候，会优先使用快过期的积分；</li>
<li>用户在查询积分明细的时候，会显示积分的有效期和状态（是否过期）；</li>
<li>用户在查询总可用积分的时候，会排除掉过期的积分。</li>
</ul>
<p>通过上面讲的方法，我们就可以将功能需求大致弄清楚了。积分系统的需求实际上并不复杂，我总结罗列了一下，如下所示。</p>
<ol>
<li>积分赚取和兑换规则</li>
</ol>
<p>积分的赚取渠道包括：下订单、每日签到、评论等。</p>
<p>积分兑换规则可以是比较通用的。比如，签到送10积分。再比如，按照订单总金额的10%兑换成积分，也就是100块钱的订单可以积累10积分。除此之外，积分兑换规则也可以是比较细化的。比如，不同的店铺、不同的商品，可以设置不同的积分兑换比例。</p>
<p>对于积分的有效期，我们可以根据不同渠道，设置不同的有效期。积分到期之后会作废；在消费积分的时候，优先使用快到期的积分。</p>
<ol start="2">
<li>积分消费和兑换规则</li>
</ol>
<p>积分的消费渠道包括：抵扣订单金额、兑换优惠券、积分换购、参与活动扣积分等。</p>
<p>我们可以根据不同的消费渠道，设置不同的积分兑换规则。比如，积分换算成消费抵扣金额的比例是10%，也就是10积分可以抵扣1块钱；100积分可以兑换15块钱的优惠券等。</p>
<ol start="3">
<li>积分及其明细查询</li>
</ol>
<p>查询用户的总积分，以及赚取积分和消费积分的历史记录。</p>
<h3 id="系统设计">系统设计</h3>
<h4 id="1-合理地将功能划分到不同模块">1. 合理地将功能划分到不同模块</h4>
<p>前面讲到面向对象设计的时候，我们提到，面向对象设计的本质就是把合适的代码放到合适的类中。合理地划分代码可以实现代码的高内聚、低耦合，类与类之间的交互简单清晰，代码整体结构一目了然，那代码的质量就不会差到哪里去。类比面向对象设计，系统设计实际上就是将合适的功能放到合适的模块中。合理地划分模块也可以做到模块层面的高内聚、低耦合，架构整洁清晰。</p>
<p>对于前面罗列的所有功能点，我们有下面三种模块划分方法。</p>
<p>第一种划分方式是：积分赚取渠道及兑换规则、消费渠道及兑换规则的管理和维护（增删改查），不划分到积分系统中，而是放到更上层的营销系统中。这样积分系统就会变得非常简单，只需要负责增加积分、减少积分、查询积分、查询积分明细等这几个工作。</p>
<p>我举个例子解释一下。比如，用户通过下订单赚取积分。订单系统通过异步发送消息或者同步调用接口的方式，告知营销系统订单交易成功。营销系统根据拿到的订单信息，查询订单对应的积分兑换规则（兑换比例、有效期等），计算得到订单可兑换的积分数量，然后调用积分系统的接口给用户增加积分。</p>
<p>第二种划分方式是：积分赚取渠道及兑换规则、消费渠道及兑换规则的管理和维护，分散在各个相关业务系统中，比如订单系统、评论系统、签到系统、换购商城、优惠券系统等。还是刚刚那个下订单赚取积分的例子，在这种情况下，用户下订单成功之后，订单系统根据商品对应的积分兑换比例，计算所能兑换的积分数量，然后直接调用积分系统给用户增加积分。</p>
<p>第三种划分方式是：所有的功能都划分到积分系统中，包括积分赚取渠道及兑换规则、消费渠道及兑换规则的管理和维护。还是同样的例子，用户下订单成功之后，订单系统直接告知积分系统订单交易成功，积分系统根据订单信息查询积分兑换规则，给用户增加积分。</p>
<p>怎么判断哪种模块划分合理呢？实际上，我们可以反过来通过看它是否符合高内聚、低耦合特性来判断。如果一个功能的修改或添加，经常要跨团队、跨项目、跨系统才能完成，那说明模块划分的不够合理，职责不够清晰，耦合过于严重。</p>
<p>除此之外，为了避免业务知识的耦合，让下层系统更加通用，一般来讲，我们不希望下层系统（也就是被调用的系统）包含太多上层系统（也就是调用系统）的业务信息，但是，可以接受上层系统包含下层系统的业务信息。比如，订单系统、优惠券系统、换购商城等作为调用积分系统的上层系统，可以包含一些积分相关的业务信息。但是，反过来，积分系统中最好不要包含太多跟订单、优惠券、换购等相关的信息。</p>
<p>所以，综合考虑，我们更倾向于第一种和第二种模块划分方式。但是，不管选择这两种中的哪一种，积分系统所负责的工作是一样的，只包含积分的增、减、查询，以及积分明细的记录和查询。</p>
<h4 id="2-设计模块与模块之间的交互关系">2. 设计模块与模块之间的交互关系</h4>
<p>在面向对象设计中，类设计好之后，我们需要设计类之间的交互关系。类比到系统设计，系统职责划分好之后，接下来就是设计系统之间的交互，也就是确定有哪些系统跟积分系统之间有交互以及如何进行交互。</p>
<p>比较常见的系统之间的交互方式有两种，一种是同步接口调用，另一种是利用消息中间件异步调用。第一种方式简单直接，第二种方式的解耦效果更好。</p>
<p>比如，用户下订单成功之后，订单系统推送一条消息到消息中间件，营销系统订阅订单成功消息，触发执行相应的积分兑换逻辑。这样订单系统就跟营销系统完全解耦，订单系统不需要知道任何跟积分相关的逻辑，而营销系统也不需要直接跟订单系统交互。</p>
<p>除此之外，上下层系统之间的调用倾向于通过同步接口，同层之间的调用倾向于异步消息调用。比如，营销系统和积分系统是上下层关系，它们之间就比较推荐使用同步接口调用。</p>
<h4 id="3-设计模块的接口数据库业务模型">3. 设计模块的接口、数据库、业务模型</h4>
<p>刚刚讲了模块的功能划分，模块之间的交互的设计，现在，我们再来看，模块本身如何来设计。实际上，业务系统本身的设计无外乎有这样三方面的工作要做：接口设计、数据库设计和业务模型设计。</p>
<h5 id="数据库设计">数据库设计</h5>
<p>数据库的设计比较简单。实际上，我们只需要一张记录积分流水明细的表就可以了。</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20220809/20220809151909.png" alt="img"></p>
<h5 id="接口设计">接口设计</h5>
<p>对于积分系统来说，我们需要设计如下这样几个接口。</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20220809/20220809152029.png" alt="img"></p>
<p>接口设计要符合单一职责原则，粒度越小通用性就越好。但是，接口粒度太小也会带来一些问题。比如，一个功能的实现要调用多个小接口，一方面如果接口调用走网络（特别是公网），多次远程接口调用会影响性能；另一方面，本该在一个接口中完成的原子操作，现在分拆成多个小接口来完成，就可能会涉及分布式事务的数据一致性问题（一个接口执行成功了，但另一个接口执行失败了）。所以，为了兼顾易用性和性能，我们可以借鉴facade（外观）设计模式，在职责单一的细粒度接口之上，再封装一层粗粒度的接口给外部使用。</p>
<h5 id="业务模型设计">业务模型设计</h5>
<p>前面我们讲到，从代码实现角度来说，大部分业务系统的开发都可以分为Controller、Service、Repository三层。Controller层负责接口暴露，Repository层负责数据读写，Service层负责核心业务逻辑，也就是这里说的业务模型。</p>
<p>除此之外，前面我们还提到两种开发模式，基于贫血模型的传统开发模式和基于充血模型的DDD开发模式。前者是一种面向过程的编程风格，后者是一种面向对象的编程风格。不管是DDD还是OOP，高级开发模式的存在一般都是为了应对复杂系统，应对系统的复杂性。对于我们要开发的积分系统来说，因为业务相对比较简单，所以，选择简单的基于贫血模型的传统开发模式就足够了。</p>
<p>从开发的角度来说，我们可以把积分系统作为一个独立的项目，来独立开发，也可以跟其他业务代码（比如营销系统）放到同一个项目中进行开发。从运维的角度来说，我们可以将它跟其他业务一块部署，也可以作为一个微服务独立部署。具体选择哪种开发和部署方式，我们可以参考公司当前的技术架构来决定。</p>
<p>实际上，积分系统业务比较简单，代码量也不多，我更倾向于将它跟营销系统放到一个项目中开发部署。只要我们做好代码的模块化和解耦，让积分相关的业务代码跟其他业务代码之间边界清晰，没有太多耦合，后期如果需要将它拆分成独立的项目来开发部署，那也并不困难。</p>
<h2 id="通用框架开发实战接口性能统计">通用框架开发实战：接口性能统计</h2>
<h3 id="项目背景">项目背景</h3>
<p>我们希望设计开发一个小的框架，能够获取接口调用的各种统计信息，比如，响应时间的最大值（max）、最小值（min）、平均值（avg）、百分位值（percentile）、接口调用次数（count）、频率（tps） 等，并且支持将统计结果以各种显示格式（比如：JSON格式、网页格式、自定义显示格式等）输出到各种终端（Console命令行、HTTP网页、Email、日志文件、自定义输出终端等），以方便查看。</p>
<h3 id="需求分析-2">需求分析</h3>
<p>性能计数器作为一个跟业务无关的功能，我们完全可以把它开发成一个独立的框架或者类库，集成到很多业务系统中。而作为可被复用的框架，除了功能性需求之外，非功能性需求也非常重要。</p>
<h4 id="1-功能性需求分析">1. 功能性需求分析</h4>
<p>相对于一大长串的文字描述，人脑更容易理解短的、罗列的比较规整、分门别类的列表信息。显然，刚才那段需求描述不符合这个规律。我们需要把它拆解成一个一个的“干条条”。拆解之后我写在下面了，是不是看起来更加清晰、有条理？</p>
<ul>
<li>接口统计信息：包括接口响应时间的统计信息，以及接口调用次数的统计信息等。</li>
<li>统计信息的类型：max、min、avg、percentile、count、tps等。</li>
<li>统计信息显示格式：Json、Html、自定义显示格式。</li>
<li>统计信息显示终端：Console、Email、HTTP网页、日志、自定义显示终端。</li>
</ul>
<p>除此之外，我们还可以借助设计产品的时候，经常用到的线框图，把最终数据的显示样式画出来，会更加一目了然。具体的线框图如下所示：</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20220809/20220809155447.png" alt="img"></p>
<p>实际上，从线框图中，我们还能挖掘出了下面几个隐藏的需求。</p>
<ul>
<li>统计触发方式：包括主动和被动两种。主动表示以一定的频率定时统计数据，并主动推送到显示终端，比如邮件推送。被动表示用户触发统计，比如用户在网页中选择要统计的时间区间，触发统计，并将结果显示给用户。</li>
<li>统计时间区间：框架需要支持自定义统计时间区间，比如统计最近10分钟的某接口的tps、访问次数，或者统计12月11日00点到12月12日00点之间某接口响应时间的最大值、最小值、平均值等。</li>
<li>统计时间间隔：对于主动触发统计，我们还要支持指定统计时间间隔，也就是多久触发一次统计显示。比如，每间隔10s统计一次接口信息并显示到命令行中，每间隔24小时发送一封统计信息邮件。</li>
</ul>
<h4 id="2非功能性需求分析">2.非功能性需求分析</h4>
<ul>
<li>易用性</li>
</ul>
<p>易用性听起来更像是一个评判产品的标准。没错，我们在开发这样一个技术框架的时候，也要有产品意识。框架是否易集成、易插拔、跟业务代码是否松耦合、提供的接口是否够灵活等等，都是我们应该花心思去思考和设计的。有的时候，文档写得好坏甚至都有可能决定一个框架是否受欢迎。</p>
<ul>
<li>性能</li>
</ul>
<p>对于需要集成到业务系统的框架来说，我们不希望框架本身的代码执行效率，对业务系统有太多性能上的影响。对于性能计数器这个框架来说，一方面，我们希望它是低延迟的，也就是说，统计代码不影响或很少影响接口本身的响应时间；另一方面，我们希望框架本身对内存的消耗不能太大。</p>
<ul>
<li>扩展性</li>
</ul>
<p>这里说的扩展性跟之前讲到的代码的扩展性有点类似，都是指在不修改或尽量少修改代码的情况下添加新的功能。但是这两者也有区别。之前讲到的扩展是从框架代码开发者的角度来说的。这里所说的扩展是从框架使用者的角度来说的，特指使用者可以在不修改框架源码，甚至不拿到框架源码的情况下，为框架扩展新的功能。这就有点类似给框架开发插件。</p>
<ul>
<li>容错性</li>
</ul>
<p>容错性这一点也非常重要。对于性能计数器框架来说，不能因为框架本身的异常导致接口请求出错。所以，我们要对框架可能存在的各种异常情况都考虑全面，对外暴露的接口抛出的所有运行时、非运行时异常都进行捕获处理。</p>
<ul>
<li>通用性</li>
</ul>
<p>为了提高框架的复用性，能够灵活应用到各种场景中。框架在设计的时候，要尽可能通用。我们要多去思考一下，除了接口统计这样一个需求，还可以适用到其他哪些场景中，比如是否还可以处理其他事件的统计信息，比如SQL请求时间的统计信息、业务统计信息（比如支付成功率）等。</p>
<h3 id="框架设计">框架设计</h3>
<p>对于稍微复杂系统的开发，很多人觉得不知从何开始。我个人喜欢借鉴TDD（测试驱动开发）和Prototype（最小原型）的思想，先聚焦于一个简单的应用场景，基于此设计实现一个简单的原型。尽管这个最小原型系统在功能和非功能特性上都不完善，但它能够看得见、摸得着，比较具体、不抽象，能够很有效地帮助我缕清更复杂的设计思路，是迭代设计的基础。</p>
<p>对于性能计数器这个框架的开发来说，我们可以先聚焦于一个非常具体、简单的应用场景，比如统计用户注册、登录这两个接口的响应时间的最大值和平均值、接口调用次数，并且将统计结果以JSON的格式输出到命令行中。现在这个需求简单、具体、明确，设计实现起来难度降低了很多。</p>
<p>我们先给出应用场景的代码。具体如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//应用场景：统计下面两个接口(注册和登录）的响应时间和访问次数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>UserVo user<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> UserVo <span style="color:#a6e22e">login</span><span style="color:#f92672">(</span>String telephone<span style="color:#f92672">,</span> String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>要输出接口的响应时间的最大值、平均值和接口调用次数，我们首先要采集每次接口请求的响应时间，并且存储起来，然后按照某个时间间隔做聚合统计，最后才是将结果输出。在原型系统的代码实现中，我们可以把所有代码都塞到一个类中，暂时不用考虑任何代码质量、线程安全、性能、扩展性等等问题，怎么简单怎么来就行。</p>
<p>最小原型的代码实现如下所示。其中，recordResponseTime()和recordTimestamp()两个函数分别用来记录接口请求的响应时间和访问时间。startRepeatedReport()函数以指定的频率统计数据并输出结果。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Metrics</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// Map的key是接口名称，value对应接口请求的响应时间或时间戳；
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;&gt;</span> responseTimes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
  <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;&gt;</span> timestamps <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
  <span style="color:#66d9ef">private</span> ScheduledExecutorService executor <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newSingleThreadScheduledExecutor</span><span style="color:#f92672">();</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recordResponseTime</span><span style="color:#f92672">(</span>String apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">double</span> responseTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    responseTimes<span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;());</span>
    responseTimes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">).</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>responseTime<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recordTimestamp</span><span style="color:#f92672">(</span>String apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">double</span> timestamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    timestamps<span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;());</span>
    timestamps<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">).</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>timestamp<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> period<span style="color:#f92672">,</span> TimeUnit unit<span style="color:#f92672">){</span>
    executor<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        Gson gson <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Gson<span style="color:#f92672">();</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Double<span style="color:#f92672">&gt;&gt;</span> stats <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;&gt;</span> entry <span style="color:#f92672">:</span> responseTimes<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
          String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
          List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> apiRespTimes <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;());</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">).</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;max&#34;</span><span style="color:#f92672">,</span> max<span style="color:#f92672">(</span>apiRespTimes<span style="color:#f92672">));</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">).</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;avg&#34;</span><span style="color:#f92672">,</span> avg<span style="color:#f92672">(</span>apiRespTimes<span style="color:#f92672">));</span>
        <span style="color:#f92672">}</span>
  
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;&gt;</span> entry <span style="color:#f92672">:</span> timestamps<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
          String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
          List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> apiTimestamps <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;());</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">).</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;count&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">double</span><span style="color:#f92672">)</span>apiTimestamps<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
        <span style="color:#f92672">}</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>gson<span style="color:#f92672">.</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span>stats<span style="color:#f92672">));</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> 0<span style="color:#f92672">,</span> period<span style="color:#f92672">,</span> unit<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> dataset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#75715e">//省略代码实现}
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">avg</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> dataset<span style="color:#f92672">)</span> <span style="color:#f92672">{</span><span style="color:#75715e">//省略代码实现}
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>接下来，我们再来看，如何用它来统计注册、登录接口的响应时间和访问次数。具体的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//应用场景：统计下面两个接口(注册和登录）的响应时间和访问次数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserController</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> Metrics metrics <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Metrics<span style="color:#f92672">();</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">UserController</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span>60<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">register</span><span style="color:#f92672">(</span>UserVo user<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> startTimestamp <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">recordTimestamp</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;regsiter&#34;</span><span style="color:#f92672">,</span> startTimestamp<span style="color:#f92672">);</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">long</span> respTime <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> startTimestamp<span style="color:#f92672">;</span>
    metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">recordResponseTime</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> respTime<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> UserVo <span style="color:#a6e22e">login</span><span style="color:#f92672">(</span>String telephone<span style="color:#f92672">,</span> String password<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> startTimestamp <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">recordTimestamp</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> startTimestamp<span style="color:#f92672">);</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">long</span> respTime <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> startTimestamp<span style="color:#f92672">;</span>
    metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">recordResponseTime</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> respTime<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>最小原型的代码实现虽然简陋，但它却帮我们将思路理顺了很多，我们现在就基于它做最终的框架设计。下面是我针对性能计数器框架画的一个粗略的系统设计图。图可以非常直观地体现设计思想，并且能有效地帮助我们释放更多的脑空间，来思考其他细节问题。</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20220809/20220809161504.png" alt="img"></p>
<p>如图所示，我们把整个框架分为四个模块：数据采集、存储、聚合统计、显示。每个模块负责的工作简单罗列如下。</p>
<ul>
<li>数据采集：负责打点采集原始数据，包括记录每次接口请求的响应时间和请求时间。数据采集过程要高度容错，不能影响到接口本身的可用性。除此之外，因为这部分功能是暴露给框架的使用者的，所以在设计数据采集API的时候，我们也要尽量考虑其易用性。</li>
<li>存储：负责将采集的原始数据保存下来，以便后面做聚合统计。数据的存储方式有多种，比如：Redis、MySQL、HBase、日志、文件、内存等。数据存储比较耗时，为了尽量地减少对接口性能（比如响应时间）的影响，采集和存储的过程异步完成。</li>
<li>聚合统计：负责将原始数据聚合为统计数据，比如：max、min、avg、pencentile、count、tps等。为了支持更多的聚合统计规则，代码希望尽可能灵活、可扩展。</li>
<li>显示：负责将统计数据以某种格式显示到终端，比如：输出到命令行、邮件、网页、自定义显示终端等。</li>
</ul>
<h3 id="面向对象设计与实现">面向对象设计与实现</h3>
<h4 id="1-划分职责进而识别出有哪些类-1">1. 划分职责进而识别出有哪些类</h4>
<p>根据需求描述，我们先大致识别出下面几个接口或类。</p>
<ul>
<li>MetricsCollector类负责提供API，来采集接口请求的原始数据。我们可以为MetricsCollector抽象出一个接口，但这并不是必须的，因为暂时我们只能想到一个MetricsCollector的实现方式。</li>
<li>MetricsStorage接口负责原始数据存储，RedisMetricsStorage类实现MetricsStorage接口。这样做是为了今后灵活地扩展新的存储方法，比如用HBase来存储。</li>
<li>Aggregator类负责根据原始数据计算统计数据。</li>
<li>ConsoleReporter类、EmailReporter类分别负责以一定频率统计并发送统计数据到命令行和邮件。至于ConsoleReporter和EmailReporter是否可以抽象出可复用的抽象类，或者抽象出一个公共的接口，我们暂时还不能确定。</li>
</ul>
<h4 id="2-定义类及类与类之间的关系">2. 定义类及类与类之间的关系</h4>
<p>MetricsCollector类的定义非常简单，具体代码如下所示。对比上一节课中最小原型的代码，MetricsCollector通过引入RequestInfo类来封装原始数据信息，用一个采集函数代替了之前的两个函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MetricsCollector</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span><span style="color:#75715e">//基于接口而非实现编程
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">//依赖注入
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MetricsCollector</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#75715e">//用一个函数代替了最小原型中的两个函数
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span>RequestInfo requestInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestInfo <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>requestInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getApiName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">saveRequestInfo</span><span style="color:#f92672">(</span>requestInfo<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RequestInfo</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> String apiName<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> responseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> timestamp<span style="color:#f92672">;</span>
  <span style="color:#75715e">//...省略constructor/getter/setter方法...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>MetricsStorage类和RedisMetricsStorage类的属性和方法也比较明确。具体的代码实现如下所示。注意，一次性取太长时间区间的数据，可能会导致拉取太多的数据到内存中，有可能会撑爆内存。对于Java来说，就有可能会触发OOM（Out Of Memory）。而且，即便不出现OOM，内存还够用，但也会因为内存吃紧，导致频繁的Full GC，进而导致系统接口请求处理变慢，甚至超时。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">MetricsStorage</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">saveRequestInfo</span><span style="color:#f92672">(</span>RequestInfo requestInfo<span style="color:#f92672">);</span>

  List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>String apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> startTimeInMillis<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimeInMillis<span style="color:#f92672">);</span>

  Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> startTimeInMillis<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimeInMillis<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisMetricsStorage</span> <span style="color:#66d9ef">implements</span> MetricsStorage <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...省略属性和构造函数等...
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">saveRequestInfo</span><span style="color:#f92672">(</span>RequestInfo requestInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>String apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> startTimestamp<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimestamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> startTimestamp<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimestamp<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>MetricsCollector类和MetricsStorage类的设计思路比较简单，不同的人给出的设计结果应该大差不差。但是，统计和显示这两个功能就不一样了，可以有多种设计思路。实际上，如果我们把统计显示所要完成的功能逻辑细分一下的话，主要包含下面4点：</p>
<ol>
<li>根据给定的时间区间，从数据库中拉取数据；</li>
<li>根据原始数据，计算得到统计数据；</li>
<li>将统计数据显示到终端（命令行或邮件）；</li>
<li>定时触发以上3个过程的执行。</li>
</ol>
<p>实际上，如果用一句话总结一下的话，<strong>面向对象设计和实现要做的事情，就是把合适的代码放到合适的类中</strong>。所以，我们现在要做的工作就是，把以上的4个功能逻辑划分到几个类中。划分的方法有很多种，比如，我们可以把前两个逻辑放到一个类中，第3个逻辑放到另外一个类中，第4个逻辑作为上帝类（God Class）组合前面两个类来触发前3个逻辑的执行。当然，我们也可以把第2个逻辑单独放到一个类中，第1、3、4都放到另外一个类中。</p>
<p>至于到底选择哪种排列组合方式，判定的标准是，让代码尽量地满足低耦合、高内聚、单一职责、对扩展开放对修改关闭等之前讲到的各种设计原则和思想，尽量地让设计满足代码易复用、易读、易扩展、易维护。</p>
<p>我们暂时选择把第1、3、4逻辑放到ConsoleReporter或EmailReporter类中，把第2个逻辑放到Aggregator类中。其中，Aggregator类负责的逻辑比较简单，我们把它设计成只包含静态方法的工具类。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Aggregator</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> RequestStat <span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> requestInfos<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">double</span> maxRespTime <span style="color:#f92672">=</span> Double<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> minRespTime <span style="color:#f92672">=</span> Double<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> avgRespTime <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> p999RespTime <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> p99RespTime <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> sumRespTime <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">long</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>RequestInfo requestInfo <span style="color:#f92672">:</span> requestInfos<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#f92672">++</span>count<span style="color:#f92672">;</span>
      <span style="color:#66d9ef">double</span> respTime <span style="color:#f92672">=</span> requestInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>maxRespTime <span style="color:#f92672">&lt;</span> respTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        maxRespTime <span style="color:#f92672">=</span> respTime<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>minRespTime <span style="color:#f92672">&gt;</span> respTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        minRespTime <span style="color:#f92672">=</span> respTime<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      sumRespTime <span style="color:#f92672">+=</span> respTime<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      avgRespTime <span style="color:#f92672">=</span> sumRespTime <span style="color:#f92672">/</span> count<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">long</span> tps <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)(</span>count <span style="color:#f92672">/</span> durationInMillis <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
    Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">(</span>requestInfos<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Comparator<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span><span style="color:#f92672">(</span>RequestInfo o1<span style="color:#f92672">,</span> RequestInfo o2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">double</span> diff <span style="color:#f92672">=</span> o1<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> o2<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>diff <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>diff <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">return</span> 1<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">return</span> 0<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
    <span style="color:#66d9ef">int</span> idx999 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)(</span>count <span style="color:#f92672">*</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">999</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> idx99 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)(</span>count <span style="color:#f92672">*</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">99</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      p999RespTime <span style="color:#f92672">=</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>idx999<span style="color:#f92672">).</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
      p99RespTime <span style="color:#f92672">=</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>idx99<span style="color:#f92672">).</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    RequestStat requestStat <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RequestStat<span style="color:#f92672">();</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxResponseTime</span><span style="color:#f92672">(</span>maxRespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setMinResponseTime</span><span style="color:#f92672">(</span>minRespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setAvgResponseTime</span><span style="color:#f92672">(</span>avgRespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setP999ResponseTime</span><span style="color:#f92672">(</span>p999RespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setP99ResponseTime</span><span style="color:#f92672">(</span>p99RespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setCount</span><span style="color:#f92672">(</span>count<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setTps</span><span style="color:#f92672">(</span>tps<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> requestStat<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RequestStat</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> maxResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> minResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> avgResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> p999ResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> p99ResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> count<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> tps<span style="color:#f92672">;</span>
  <span style="color:#75715e">//...省略getter/setter方法...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>ConsoleReporter类相当于一个上帝类，定时根据给定的时间区间，从数据库中取出数据，借助Aggregator类完成统计工作，并将统计结果输出到命令行。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsoleReporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> ScheduledExecutorService executor<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConsoleReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executor</span> <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newSingleThreadScheduledExecutor</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#75715e">// 第4个代码逻辑：定时触发第1、2、3代码逻辑的执行；
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> periodInSeconds<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationInSeconds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    executor<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 第1个代码逻辑：根据给定的时间区间，从数据库中拉取数据；
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> durationInSeconds <span style="color:#f92672">*</span> 1000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> endTimeInMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> startTimeInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span> durationInMillis<span style="color:#f92672">;</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos <span style="color:#f92672">=</span>
                metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> entry <span style="color:#f92672">:</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
          String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
          List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> requestInfosPerApi <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
          <span style="color:#75715e">// 第2个代码逻辑：根据原始数据，计算得到统计数据；
</span><span style="color:#75715e"></span>          RequestStat requestStat <span style="color:#f92672">=</span> Aggregator<span style="color:#f92672">.</span><span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>requestInfosPerApi<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> requestStat<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// 第3个代码逻辑：将统计数据显示到终端（命令行或邮件）；
</span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Time Span: [&#34;</span> <span style="color:#f92672">+</span> startTimeInMillis <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, &#34;</span> <span style="color:#f92672">+</span> endTimeInMillis <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]&#34;</span><span style="color:#f92672">);</span>
        Gson gson <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Gson<span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>gson<span style="color:#f92672">.</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span>stats<span style="color:#f92672">));</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> 0<span style="color:#f92672">,</span> periodInSeconds<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailReporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Long DAY_HOURS_IN_SECONDS <span style="color:#f92672">=</span> 86400L<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> EmailSender emailSender<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> toAddresses <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>metricsStorage<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> EmailSender<span style="color:#f92672">(</span><span style="color:#75715e">/*省略参数*/</span><span style="color:#f92672">));</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> EmailSender emailSender<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">emailSender</span> <span style="color:#f92672">=</span> emailSender<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addToAddress</span><span style="color:#f92672">(</span>String address<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    toAddresses<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>address<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Calendar calendar <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DATE</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">HOUR_OF_DAY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">SECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    Date firstTime <span style="color:#f92672">=</span> calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getTime</span><span style="color:#f92672">();</span>
    Timer timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timer<span style="color:#f92672">();</span>
    timer<span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TimerTask<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> endTimeInMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> startTimeInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span> durationInMillis<span style="color:#f92672">;</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos <span style="color:#f92672">=</span>
                metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> entry <span style="color:#f92672">:</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
          String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
          List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> requestInfosPerApi <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
          RequestStat requestStat <span style="color:#f92672">=</span> Aggregator<span style="color:#f92672">.</span><span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>requestInfosPerApi<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> requestStat<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// TODO: 格式化为html格式，并且发送邮件
</span><span style="color:#75715e"></span>      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> firstTime<span style="color:#f92672">,</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="3-将类组装起来并提供执行入口">3. 将类组装起来并提供执行入口</h4>
<p>因为这个框架稍微有些特殊，有两个执行入口：一个是MetricsCollector类，提供了一组API来采集原始数据；另一个是ConsoleReporter类和EmailReporter类，用来触发统计显示。框架具体的使用方式如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Demo</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    MetricsStorage storage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RedisMetricsStorage<span style="color:#f92672">();</span>
    ConsoleReporter consoleReporter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsoleReporter<span style="color:#f92672">(</span>storage<span style="color:#f92672">);</span>
    consoleReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span>60<span style="color:#f92672">,</span> 60<span style="color:#f92672">);</span>

    EmailReporter emailReporter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EmailReporter<span style="color:#f92672">(</span>storage<span style="color:#f92672">);</span>
    emailReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">addToAddress</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wangzheng@xzg.com&#34;</span><span style="color:#f92672">);</span>
    emailReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">();</span>

    MetricsCollector collector <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MetricsCollector<span style="color:#f92672">(</span>storage<span style="color:#f92672">);</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 123<span style="color:#f92672">,</span> 10234<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 223<span style="color:#f92672">,</span> 11234<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 323<span style="color:#f92672">,</span> 12334<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> 23<span style="color:#f92672">,</span> 12434<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> 1223<span style="color:#f92672">,</span> 14234<span style="color:#f92672">));</span>

    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>100000<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h1 id="三规范与重构">三、规范与重构</h1>
<h2 id="单元测试">单元测试</h2>
<p>单元测试由研发工程师自己来编写，用来测试自己写的代码的正确性。我们常常将它跟集成测试放到一块来对比。单元测试相对于集成测试（Integration Testing）来说，测试的粒度更小一些。集成测试的测试对象是整个系统或者某个功能模块，比如测试用户注册、登录功能是否正常，是一种端到端（end to end）的测试。而单元测试的测试对象是类或者函数，用来测试一个类和函数是否都按照预期的逻辑执行。这是代码层级的测试。</p>
<h3 id="单元测试实战">单元测试实战</h3>
<p>Transaction是经过抽象简化之后的一个电商系统的交易类，用来记录每笔订单交易的情况。Transaction类中的execute()函数负责执行转账操作，将钱从买家的钱包转到卖家的钱包中。真正的转账操作是通过调用WalletRpcService RPC服务来完成的。除此之外，代码中还涉及一个分布式锁DistributedLock单例类，用来避免Transaction并发执行，导致用户的钱被重复转出。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Transaction</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> String id<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long buyerId<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long sellerId<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long productId<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String orderId<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Long createTimestamp<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Double amount<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> STATUS status<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> String walletTransactionId<span style="color:#f92672">;</span>
  
  <span style="color:#75715e">// ...get() methods...
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Transaction</span><span style="color:#f92672">(</span>String preAssignedId<span style="color:#f92672">,</span> Long buyerId<span style="color:#f92672">,</span> Long sellerId<span style="color:#f92672">,</span> Long productId<span style="color:#f92672">,</span> String orderId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preAssignedId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>preAssignedId<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> preAssignedId<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> IdGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">generateTransactionId</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;t_&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;t_&#34;</span> <span style="color:#f92672">+</span> preAssignedId<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buyerId</span> <span style="color:#f92672">=</span> buyerId<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sellerId</span> <span style="color:#f92672">=</span> sellerId<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">productId</span> <span style="color:#f92672">=</span> productId<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">orderId</span> <span style="color:#f92672">=</span> orderId<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">TO_BE_EXECUTD</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">createTimestamp</span> <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimestamp</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InvalidTransactionException <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>buyerId <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span>sellerId <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> amount <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> InvalidTransactionException<span style="color:#f92672">(...);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>status <span style="color:#f92672">==</span> STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXECUTED</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">boolean</span> isLocked <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      isLocked <span style="color:#f92672">=</span> RedisDistributedLock<span style="color:#f92672">.</span><span style="color:#a6e22e">getSingletonIntance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">lockTransction</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>isLocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span> <span style="color:#75715e">// 锁定未成功，返回false，job兜底执行
</span><span style="color:#75715e"></span>      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>status <span style="color:#f92672">==</span> STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXECUTED</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span> <span style="color:#75715e">// double check
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">long</span> executionInvokedTimestamp <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimestamp</span><span style="color:#f92672">();</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>executionInvokedTimestamp <span style="color:#f92672">-</span> createdTimestap <span style="color:#f92672">&gt;</span> 14days<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXPIRED</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      WalletRpcService walletRpcService <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WalletRpcService<span style="color:#f92672">();</span>
      String walletTransactionId <span style="color:#f92672">=</span> walletRpcService<span style="color:#f92672">.</span><span style="color:#a6e22e">moveMoney</span><span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> buyerId<span style="color:#f92672">,</span> sellerId<span style="color:#f92672">,</span> amount<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>walletTransactionId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">walletTransactionId</span> <span style="color:#f92672">=</span> walletTransactionId<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXECUTED</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">FAILED</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isLocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
       RedisDistributedLock<span style="color:#f92672">.</span><span style="color:#a6e22e">getSingletonIntance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">unlockTransction</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>在Transaction类中，主要逻辑集中在execute()函数中，所以它是我们测试的重点对象。为了尽可能全面覆盖各种正常和异常情况，针对这个函数，我们设计了下面6个测试用例。</p>
<ol>
<li>正常情况下，交易执行成功，回填用于对账（交易与钱包的交易流水）用的walletTransactionId，交易状态设置为EXECUTED，函数返回true。</li>
<li>buyerId、sellerId为null、amount小于0，返回InvalidTransactionException。</li>
<li>交易已过期（createTimestamp超过14天），交易状态设置为EXPIRED，返回false。</li>
<li>交易已经执行了（status==EXECUTED），不再重复执行转钱逻辑，返回true。</li>
<li>钱包（WalletRpcService）转钱失败，交易状态设置为FAILED，函数返回false。</li>
<li>交易正在执行着，不会被重复执行，函数直接返回false。</li>
</ol>
<p>测试用例设计完了。现在看起来似乎一切进展顺利。但是，事实是，当我们将测试用例落实到具体的代码实现时，你就会发现有很多行不通的地方。对于上面的测试用例，第2个实现起来非常简单，我就不做介绍了。我们重点来看其中的1和3。测试用例4、5、6跟3类似。</p>
<p>测试用例1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testExecute</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  Long buyerId <span style="color:#f92672">=</span> 123L<span style="color:#f92672">;</span>
  Long sellerId <span style="color:#f92672">=</span> 234L<span style="color:#f92672">;</span>
  Long productId <span style="color:#f92672">=</span> 345L<span style="color:#f92672">;</span>
  Long orderId <span style="color:#f92672">=</span> 456L<span style="color:#f92672">;</span>
  Transction transaction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Transaction<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> buyerId<span style="color:#f92672">,</span> sellerId<span style="color:#f92672">,</span> productId<span style="color:#f92672">,</span> orderId<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">boolean</span> executedResult <span style="color:#f92672">=</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">();</span>
  assertTrue<span style="color:#f92672">(</span>executedResult<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>execute()函数的执行依赖两个外部的服务，一个是RedisDistributedLock，一个WalletRpcService。这就导致上面的单元测试代码存在下面几个问题。</p>
<ul>
<li>如果要让这个单元测试能够运行，我们需要搭建Redis服务和Wallet RPC服务。搭建和维护的成本比较高。</li>
<li>我们还需要保证将伪造的transaction数据发送给Wallet RPC服务之后，能够正确返回我们期望的结果，然而Wallet RPC服务有可能是第三方（另一个团队开发维护的）的服务，并不是我们可控的。换句话说，并不是我们想让它返回什么数据就返回什么。</li>
<li>Transaction的执行跟Redis、RPC服务通信，需要走网络，耗时可能会比较长，对单元测试本身的执行性能也会有影响。</li>
<li>网络的中断、超时、Redis、RPC服务的不可用，都会影响单元测试的执行。</li>
</ul>
<h4 id="mock">mock</h4>
<p>我们回到单元测试的定义上来看一下。单元测试主要是测试程序员自己编写的代码逻辑的正确性，并非是端到端的集成测试，它不需要测试所依赖的外部系统（分布式锁、Wallet RPC服务）的逻辑正确性。所以，如果代码中依赖了外部系统或者不可控组件，比如，需要依赖数据库、网络通信、文件系统等，那我们就需要将被测代码与外部系统解依赖，而这种解依赖的方法就叫作“mock”。所谓的mock就是用一个“假”的服务替换真正的服务。mock的服务完全在我们的控制之下，模拟输出我们想要的数据。</p>
<p>那如何来mock服务呢？mock的方式主要有两种，手动mock和利用框架mock。利用框架mock仅仅是为了简化代码编写，每个框架的mock方式都不大一样。我们这里只展示手动mock。</p>
<p>我们通过继承WalletRpcService类，并且重写其中的moveMoney()函数的方式来实现mock。具体的代码实现如下所示。通过mock的方式，我们可以让moveMoney()返回任意我们想要的数据，完全在我们的控制范围内，并且不需要真正进行网络通信。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MockWalletRpcServiceOne</span> <span style="color:#66d9ef">extends</span> WalletRpcService <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">moveMoney</span><span style="color:#f92672">(</span>Long id<span style="color:#f92672">,</span> Long fromUserId<span style="color:#f92672">,</span> Long toUserId<span style="color:#f92672">,</span> Double amount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;123bac&#34;</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span> 
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MockWalletRpcServiceTwo</span> <span style="color:#66d9ef">extends</span> WalletRpcService <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">moveMoney</span><span style="color:#f92672">(</span>Long id<span style="color:#f92672">,</span> Long fromUserId<span style="color:#f92672">,</span> Long toUserId<span style="color:#f92672">,</span> Double amount<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span> 
<span style="color:#f92672">}</span>
</code></pre></div><p>现在我们再来看，如何用MockWalletRpcServiceOne、MockWalletRpcServiceTwo来替换代码中的真正的WalletRpcService呢？</p>
<p>因为WalletRpcService是在execute()函数中通过new的方式创建的，我们无法动态地对其进行替换。也就是说，Transaction类中的execute()方法的可测试性很差，需要通过重构来让其变得更容易测试。该如何重构这段代码呢？</p>
<p>在第19节中，我们讲到，依赖注入是实现代码可测试性的最有效的手段。我们可以应用依赖注入，将WalletRpcService对象的创建反转给上层逻辑，在外部创建好之后，再注入到Transaction类中。重构之后的Transaction类的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Transaction</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// 添加一个成员变量及其set方法
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> WalletRpcService walletRpcService<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setWalletRpcService</span><span style="color:#f92672">(</span>WalletRpcService walletRpcService<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">walletRpcService</span> <span style="color:#f92672">=</span> walletRpcService<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 删除下面这一行代码
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// WalletRpcService walletRpcService = new WalletRpcService();
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>现在，我们就可以在单元测试中，非常容易地将WalletRpcService替换成MockWalletRpcServiceOne或WalletRpcServiceTwo了。重构之后的代码对应的单元测试如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testExecute</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  Long buyerId <span style="color:#f92672">=</span> 123L<span style="color:#f92672">;</span>
  Long sellerId <span style="color:#f92672">=</span> 234L<span style="color:#f92672">;</span>
  Long productId <span style="color:#f92672">=</span> 345L<span style="color:#f92672">;</span>
  Long orderId <span style="color:#f92672">=</span> 456L<span style="color:#f92672">;</span>
  Transction transaction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Transaction<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> buyerId<span style="color:#f92672">,</span> sellerId<span style="color:#f92672">,</span> productId<span style="color:#f92672">,</span> orderId<span style="color:#f92672">);</span>
  <span style="color:#75715e">// 使用mock对象来替代真正的RPC服务
</span><span style="color:#75715e"></span>  transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">setWalletRpcService</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> MockWalletRpcServiceOne<span style="color:#f92672">()):</span>
  <span style="color:#66d9ef">boolean</span> executedResult <span style="color:#f92672">=</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">();</span>
  assertTrue<span style="color:#f92672">(</span>executedResult<span style="color:#f92672">);</span>
  assertEquals<span style="color:#f92672">(</span>STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXECUTED</span><span style="color:#f92672">,</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">getStatus</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>WalletRpcService的mock和替换问题解决了，我们再来看RedisDistributedLock。它的mock和替换要复杂一些，主要是因为RedisDistributedLock是一个单例类。单例相当于一个全局变量，我们无法mock（无法继承和重写方法），也无法通过依赖注入的方式来替换。</p>
<p>如果RedisDistributedLock是我们自己维护的，可以自由修改、重构，那我们可以将其改为非单例的模式，或者定义一个接口，比如IDistributedLock，让RedisDistributedLock实现这个接口。这样我们就可以像前面WalletRpcService的替换方式那样，替换RedisDistributedLock为MockRedisDistributedLock了。但如果RedisDistributedLock不是我们维护的，我们无权去修改这部分代码，这个时候该怎么办呢？</p>
<p>我们可以对transaction上锁这部分逻辑重新封装一下。具体代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TransactionLock</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">lock</span><span style="color:#f92672">(</span>String id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> RedisDistributedLock<span style="color:#f92672">.</span><span style="color:#a6e22e">getSingletonIntance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">lockTransction</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    RedisDistributedLock<span style="color:#f92672">.</span><span style="color:#a6e22e">getSingletonIntance</span><span style="color:#f92672">().</span><span style="color:#a6e22e">unlockTransction</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Transaction</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> TransactionLock lock<span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setTransactionLock</span><span style="color:#f92672">(</span>TransactionLock lock<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span> <span style="color:#f92672">=</span> lock<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
 
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      isLocked <span style="color:#f92672">=</span> lock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
      <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isLocked<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        lock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>针对重构过的代码，我们的单元测试代码修改为下面这个样子。这样，我们就能在单元测试代码中隔离真正的RedisDistributedLock分布式锁这部分逻辑了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testExecute</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  Long buyerId <span style="color:#f92672">=</span> 123L<span style="color:#f92672">;</span>
  Long sellerId <span style="color:#f92672">=</span> 234L<span style="color:#f92672">;</span>
  Long productId <span style="color:#f92672">=</span> 345L<span style="color:#f92672">;</span>
  Long orderId <span style="color:#f92672">=</span> 456L<span style="color:#f92672">;</span>
  
  TransactionLock mockLock <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> TransactionLock<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">lock</span><span style="color:#f92672">(</span>String id<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
  
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">()</span> <span style="color:#f92672">{}</span>
  <span style="color:#f92672">};</span>
  
  Transction transaction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Transaction<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> buyerId<span style="color:#f92672">,</span> sellerId<span style="color:#f92672">,</span> productId<span style="color:#f92672">,</span> orderId<span style="color:#f92672">);</span>
  transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">setWalletRpcService</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> MockWalletRpcServiceOne<span style="color:#f92672">());</span>
  transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">setTransactionLock</span><span style="color:#f92672">(</span>mockLock<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">boolean</span> executedResult <span style="color:#f92672">=</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">();</span>
  assertTrue<span style="color:#f92672">(</span>executedResult<span style="color:#f92672">);</span>
  assertEquals<span style="color:#f92672">(</span>STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXECUTED</span><span style="color:#f92672">,</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">getStatus</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>至此，测试用例1就算写好了。我们通过依赖注入和mock，让单元测试代码不依赖任何不可控的外部服务。</p>
<p>现在，我们再来看测试用例3：交易已过期（createTimestamp超过14天），交易状态设置为EXPIRED，返回false。针对这个单元测试用例，我们还是先把代码写出来，然后再来分析。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testExecute_with_TransactionIsExpired</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  Long buyerId <span style="color:#f92672">=</span> 123L<span style="color:#f92672">;</span>
  Long sellerId <span style="color:#f92672">=</span> 234L<span style="color:#f92672">;</span>
  Long productId <span style="color:#f92672">=</span> 345L<span style="color:#f92672">;</span>
  Long orderId <span style="color:#f92672">=</span> 456L<span style="color:#f92672">;</span>
  Transction transaction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Transaction<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> buyerId<span style="color:#f92672">,</span> sellerId<span style="color:#f92672">,</span> productId<span style="color:#f92672">,</span> orderId<span style="color:#f92672">);</span>
  transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">setCreatedTimestamp</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimestamp</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 14days<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">boolean</span> actualResult <span style="color:#f92672">=</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">();</span>
  assertFalse<span style="color:#f92672">(</span>actualResult<span style="color:#f92672">);</span>
  assertEquals<span style="color:#f92672">(</span>STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXPIRED</span><span style="color:#f92672">,</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">getStatus</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上面的代码看似没有任何问题。我们将transaction的创建时间createdTimestamp设置为14天前，也就是说，当单元测试代码运行的时候，transaction一定是处于过期状态。但是，如果在Transaction类中，并没有暴露修改createdTimestamp成员变量的set方法（也就是没有定义setCreatedTimestamp()函数）呢？</p>
<p>你可能会说，如果没有createTimestamp的set方法，我就重新添加一个呗！实际上，这违反了类的封装特性。在Transaction类的设计中，createTimestamp是在交易生成时（也就是构造函数中）自动获取的系统时间，本来就不应该人为地轻易修改，所以，暴露createTimestamp的set方法，虽然带来了灵活性，但也带来了不可控性。因为，我们无法控制使用者是否会调用set方法重设createTimestamp，而重设createTimestamp并非我们的预期行为。</p>
<p>那如果没有针对createTimestamp的set方法，那测试用例3又该如何实现呢？实际上，这是一类比较常见的问题，就是代码中包含跟“时间”有关的“未决行为”逻辑。我们一般的处理方式是将这种未决行为逻辑重新封装。针对Transaction类，我们只需要将交易是否过期的逻辑，封装到isExpired()函数中即可，具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Transaction</span> <span style="color:#f92672">{</span>

  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isExpired</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> executionInvokedTimestamp <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimestamp</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">return</span> executionInvokedTimestamp <span style="color:#f92672">-</span> createdTimestamp <span style="color:#f92672">&gt;</span> 14days<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">execute</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> InvalidTransactionException <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isExpired<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">status</span> <span style="color:#f92672">=</span> STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXPIRED</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>针对重构之后的代码，测试用例3的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testExecute_with_TransactionIsExpired</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  Long buyerId <span style="color:#f92672">=</span> 123L<span style="color:#f92672">;</span>
  Long sellerId <span style="color:#f92672">=</span> 234L<span style="color:#f92672">;</span>
  Long productId <span style="color:#f92672">=</span> 345L<span style="color:#f92672">;</span>
  Long orderId <span style="color:#f92672">=</span> 456L<span style="color:#f92672">;</span>
  Transction transaction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Transaction<span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> buyerId<span style="color:#f92672">,</span> sellerId<span style="color:#f92672">,</span> productId<span style="color:#f92672">,</span> orderId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">isExpired</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">};</span>
  <span style="color:#66d9ef">boolean</span> actualResult <span style="color:#f92672">=</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">();</span>
  assertFalse<span style="color:#f92672">(</span>actualResult<span style="color:#f92672">);</span>
  assertEquals<span style="color:#f92672">(</span>STATUS<span style="color:#f92672">.</span><span style="color:#a6e22e">EXPIRED</span><span style="color:#f92672">,</span> transaction<span style="color:#f92672">.</span><span style="color:#a6e22e">getStatus</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>通过重构，Transaction代码的可测试性提高了。之前罗列的所有测试用例，现在我们都顺利实现了。不过，Transaction类的构造函数的设计还有点不妥。构造函数中并非只包含简单赋值操作。交易id的赋值逻辑稍微复杂。我们最好也要测试一下，以保证这部分逻辑的正确性。为了方便测试，我们可以把id赋值这部分逻辑单独抽象到一个函数中，具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#a6e22e">Transaction</span><span style="color:#f92672">(</span>String preAssignedId<span style="color:#f92672">,</span> Long buyerId<span style="color:#f92672">,</span> Long sellerId<span style="color:#f92672">,</span> Long productId<span style="color:#f92672">,</span> String orderId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>    fillTransactionId<span style="color:#f92672">(</span>preAssignId<span style="color:#f92672">);</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">fillTransactionId</span><span style="color:#f92672">(</span>String preAssignedId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>preAssignedId <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>preAssignedId<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> preAssignedId<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> IdGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">generateTransactionId</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span><span style="color:#f92672">.</span><span style="color:#a6e22e">startWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;t_&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;t_&#34;</span> <span style="color:#f92672">+</span> preAssignedId<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>到此为止，我们一步一步将Transaction从不可测试代码重构成了测试性良好的代码。不过，你可能还会有疑问，Transaction类中isExpired()函数就不用测试了吗？对于isExpired()函数，逻辑非常简单，肉眼就能判定是否有bug，是可以不用写单元测试的。</p>
<p>实际上，可测试性差的代码，本身代码设计得也不够好，很多地方都没有遵守我们之前讲到的设计原则和思想，比如“基于接口而非实现编程”思想、依赖反转原则等。重构之后的代码，不仅可测试性更好，而且从代码设计的角度来说，也遵从了经典的设计原则和思想。这也印证了我们之前说过的，代码的可测试性可以从侧面上反应代码设计是否合理。</p>
<h3 id="有哪些测试性不好anti-patterns的代码">有哪些测试性不好（Anti-Patterns）的代码？</h3>
<h4 id="未决行为">未决行为</h4>
<p>所谓的未决行为逻辑就是，代码的输出是随机或者说不确定的，比如，跟时间、随机数有关的代码。</p>
<h4 id="全局变量">全局变量</h4>
<p>前面我们讲过，全局变量是一种面向过程的编程风格，有种种弊端。实际上，滥用全局变量也让编写单元测试变得困难。我举个例子来解释一下。</p>
<p>RangeLimiter表示一个[-5, 5]的区间，position初始在0位置，move()函数负责移动position。其中，position是一个静态全局变量。RangeLimiterTest类是为其设计的单元测试，不过，这里面存在很大的问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RangeLimiter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> AtomicInteger position <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AtomicInteger<span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> MAX_LIMIT <span style="color:#f92672">=</span> 5<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> MIN_LIMIT <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>5<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">move</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> delta<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">int</span> currentPos <span style="color:#f92672">=</span> position<span style="color:#f92672">.</span><span style="color:#a6e22e">addAndGet</span><span style="color:#f92672">(</span>delta<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">boolean</span> betweenRange <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>currentPos <span style="color:#f92672">&lt;=</span> MAX_LIMIT<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>currentPos <span style="color:#f92672">&gt;=</span> MIN_LIMIT<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> betweenRange<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RangeLimiterTest</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testMove_betweenRange</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    RangeLimiter rangeLimiter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RangeLimiter<span style="color:#f92672">();</span>
    assertTrue<span style="color:#f92672">(</span>rangeLimiter<span style="color:#f92672">.</span><span style="color:#a6e22e">move</span><span style="color:#f92672">(</span>1<span style="color:#f92672">));</span>
    assertTrue<span style="color:#f92672">(</span>rangeLimiter<span style="color:#f92672">.</span><span style="color:#a6e22e">move</span><span style="color:#f92672">(</span>3<span style="color:#f92672">));</span>
    assertTrue<span style="color:#f92672">(</span>rangeLimiter<span style="color:#f92672">.</span><span style="color:#a6e22e">move</span><span style="color:#f92672">(-</span>5<span style="color:#f92672">));</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testMove_exceedRange</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    RangeLimiter rangeLimiter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RangeLimiter<span style="color:#f92672">();</span>
    assertFalse<span style="color:#f92672">(</span>rangeLimiter<span style="color:#f92672">.</span><span style="color:#a6e22e">move</span><span style="color:#f92672">(</span>6<span style="color:#f92672">));</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上面的单元测试有可能会运行失败。假设单元测试框架顺序依次执行testMove_betweenRange()和testMove_exceedRange()两个测试用例。在第一个测试用例执行完成之后，position的值变成了-1；再执行第二个测试用例的时候，position变成了5，move()函数返回true，assertFalse语句判定失败。所以，第二个测试用例运行失败。</p>
<p>当然，如果RangeLimiter类有暴露重设（reset）position值的函数，我们可以在每次执行单元测试用例之前，把position重设为0，这样就能解决刚刚的问题。</p>
<p>不过，每个单元测试框架执行单元测试用例的方式可能是不同的。有的是顺序执行，有的是并发执行。对于并发执行的情况，即便我们每次都把position重设为0，也并不奏效。如果两个测试用例并发执行，第16、17、18、23这四行代码可能会交叉执行，影响到move()函数的执行结果。</p>
<h4 id="静态方法">静态方法</h4>
<p>前面我们也提到，静态方法跟全局变量一样，也是一种面向过程的编程思维。在代码中调用静态方法，有时候会导致代码不易测试。主要原因是静态方法也很难mock。但是，这个要分情况来看。只有在这个静态方法执行耗时太长、依赖外部资源、逻辑复杂、行为未决等情况下，我们才需要在单元测试中mock这个静态方法。除此之外，如果只是类似Math.abs()这样的简单静态方法，并不会影响代码的可测试性，因为本身并不需要mock。</p>
<h4 id="复杂继承">复杂继承</h4>
<p>我们前面提到，相比组合关系，继承关系的代码结构更加耦合、不灵活，更加不易扩展、不易维护。实际上，继承关系也更加难测试。这也印证了代码的可测试性跟代码质量的相关性。</p>
<p>如果父类需要mock某个依赖对象才能进行单元测试，那所有的子类、子类的子类……在编写单元测试的时候，都要mock这个依赖对象。对于层次很深（在继承关系类图中表现为纵向深度）、结构复杂（在继承关系类图中表现为横向广度）的继承关系，越底层的子类要mock的对象可能就会越多，这样就会导致，底层子类在写单元测试的时候，要一个一个mock很多依赖对象，而且还需要查看父类代码，去了解该如何mock这些依赖对象。</p>
<p>如果我们利用组合而非继承来组织类之间的关系，类之间的结构层次比较扁平，在编写单元测试的时候，只需要mock类所组合依赖的对象即可。</p>
<h4 id="高耦合代码">高耦合代码</h4>
<p>如果一个类职责很重，需要依赖十几个外部对象才能完成工作，代码高度耦合，那我们在编写单元测试的时候，可能需要mock这十几个依赖的对象。不管是从代码设计的角度来说，还是从编写单元测试的角度来说，这都是不合理的。</p>
<h2 id="如何解耦代码">如何解耦代码？</h2>
<h3 id="解耦的重要性">解耦的重要性</h3>
<p>软件设计与开发最重要的工作之一就是应对复杂性。人处理复杂性的能力是有限的。过于复杂的代码往往在可读性、可维护性上都不友好。那如何来控制代码的复杂性呢？手段有很多，我个人认为，最关键的就是解耦，保证代码松耦合、高内聚。如果说重构是保证代码质量不至于腐化到无可救药地步的有效手段，那么利用解耦的方法对代码重构，就是保证代码不至于复杂到无法控制的有效手段。</p>
<p>代码“高内聚、松耦合”，也就意味着，代码结构清晰、分层和模块化合理、依赖关系简单、模块或类之间的耦合小，那代码整体的质量就不会差。即便某个具体的类或者模块设计得不怎么合理，代码质量不怎么高，影响的范围是非常有限的。我们可以聚焦于这个模块或者类，做相应的小型重构。而相对于代码结构的调整，这种改动范围比较集中的小型重构的难度就容易多了。</p>
<h3 id="如何解耦">如何解耦？</h3>
<h4 id="封装与抽象">封装与抽象</h4>
<p>封装和抽象作为两个非常通用的设计思想，可以应用在很多设计场景中，比如系统、模块、lib、组件、接口、类等等的设计。封装和抽象可以有效地隐藏实现的复杂性，隔离实现的易变性，给依赖的模块提供稳定且易用的抽象接口。</p>
<p>比如，Unix系统提供的open()文件操作函数，我们用起来非常简单，但是底层实现却非常复杂，涉及权限控制、并发控制、物理存储等等。我们通过将其封装成一个抽象的open()函数，能够有效控制代码复杂性的蔓延，将复杂性封装在局部代码中。除此之外，因为open()函数基于抽象而非具体的实现来定义，所以我们在改动open()函数的底层实现的时候，并不需要改动依赖它的上层代码，也符合我们前面提到的“高内聚、松耦合”代码的评判标准。</p>
<h4 id="中间层">中间层</h4>
<p>引入中间层能简化模块或类之间的依赖关系。下面这张图是引入中间层前后的依赖关系对比图。在引入数据存储中间层之前，A、B、C三个模块都要依赖内存一级缓存、Redis二级缓存、DB持久化存储三个模块。在引入中间层之后，三个模块只需要依赖数据存储一个模块即可。从图上可以看出，中间层的引入明显地简化了依赖关系，让代码结构更加清晰。</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20221222/20221222142814.png" alt="img"></p>
<p>除此之外，我们在进行重构的时候，引入中间层可以起到过渡的作用，能够让开发和重构同步进行，不互相干扰。比如，某个接口设计得有问题，我们需要修改它的定义，同时，所有调用这个接口的代码都要做相应的改动。如果新开发的代码也用到这个接口，那开发就跟重构冲突了。为了让重构能小步快跑，我们可以分下面四个阶段来完成接口的修改。</p>
<ul>
<li>第一阶段：引入一个中间层，包裹老的接口，提供新的接口定义。</li>
<li>第二阶段：新开发的代码依赖中间层提供的新接口。</li>
<li>第三阶段：将依赖老接口的代码改为调用新接口。</li>
<li>第四阶段：确保所有的代码都调用新接口之后，删除掉老的接口。</li>
</ul>
<p>这样，每个阶段的开发工作量都不会很大，都可以在很短的时间内完成。重构跟开发冲突的概率也变小了。</p>
<h4 id="模块化">模块化</h4>
<p>模块化是构建复杂系统常用的手段。不仅在软件行业，在建筑、机械制造等行业，这个手段也非常有用。对于一个大型复杂系统来说，没有人能掌控所有的细节。之所以我们能搭建出如此复杂的系统，并且能维护得了，最主要的原因就是将系统划分成各个独立的模块，让不同的人负责不同的模块，这样即便在不了解全部细节的情况下，管理者也能协调各个模块，让整个系统有效运转。</p>
<h2 id="实战id生成器">实战：ID生成器</h2>
<h3 id="需求背景">需求背景</h3>
<p>假设你正在参与一个后端业务系统的开发，为了方便在请求出错时排查问题，我们在编写代码的时候会在关键路径上打印日志。某个请求出错之后，我们希望能搜索出这个请求对应的所有日志，以此来查找问题的原因。而实际情况是，在日志文件中，不同请求的日志会交织在一起。如果没有东西来标识哪些日志属于同一个请求，我们就无法关联同一个请求的所有日志。</p>
<p>这听起来有点像微服务中的调用链追踪。不过，微服务中的调用链追踪是服务间的追踪，我们现在要实现的是服务内的追踪。</p>
<p>借鉴微服务调用链追踪的实现思路，我们可以给每个请求分配一个唯一ID，并且保存在请求的上下文（Context）中，比如，处理请求的工作线程的局部变量中。在Java语言中，我们可以将ID存储在Servlet线程的ThreadLocal中，或者利用Slf4j日志框架的MDC（Mapped Diagnostic Contexts）来实现（实际上底层原理也是基于线程的ThreadLocal）。每次打印日志的时候，我们从请求上下文中取出请求ID，跟日志一块输出。这样，同一个请求的所有日志都包含同样的请求ID信息，我们就可以通过请求ID来搜索同一个请求的所有日志了。</p>
<h3 id="初版实现">初版实现</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">IdGenerator</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>IdGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      String hostName <span style="color:#f92672">=</span> InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocalHost</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostName</span><span style="color:#f92672">();</span>
      String<span style="color:#f92672">[]</span> tokens <span style="color:#f92672">=</span> hostName<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\.&#34;</span><span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>tokens<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        hostName <span style="color:#f92672">=</span> tokens<span style="color:#f92672">[</span>tokens<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">];</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">char</span><span style="color:#f92672">[]</span> randomChars <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">[</span>8<span style="color:#f92672">];</span>
      <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
      Random random <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
      <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;</span> 8<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">int</span> randomAscii <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>122<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>randomAscii <span style="color:#f92672">&gt;=</span> 48 <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> 57<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          randomChars<span style="color:#f92672">[</span>count<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">char</span><span style="color:#f92672">)(</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>randomAscii <span style="color:#f92672">-</span> 48<span style="color:#f92672">));</span>
          count<span style="color:#f92672">++;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>randomAscii <span style="color:#f92672">&gt;=</span> 65 <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> 90<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          randomChars<span style="color:#f92672">[</span>count<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">char</span><span style="color:#f92672">)(</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>randomAscii <span style="color:#f92672">-</span> 65<span style="color:#f92672">));</span>
          count<span style="color:#f92672">++;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>randomAscii <span style="color:#f92672">&gt;=</span> 97 <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> 122<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          randomChars<span style="color:#f92672">[</span>count<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">char</span><span style="color:#f92672">)(</span><span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>randomAscii <span style="color:#f92672">-</span> 97<span style="color:#f92672">));</span>
          count<span style="color:#f92672">++;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
      id <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s-%d-%s&#34;</span><span style="color:#f92672">,</span> hostName<span style="color:#f92672">,</span>
              System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>randomChars<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>UnknownHostException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      logger<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to get the host name.&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>上面的代码生成的ID示例如下所示。整个ID由三部分组成。第一部分是本机名的最后一个字段。第二部分是当前时间戳，精确到毫秒。第三部分是8位的随机字符串，包含大小写字母和数字。尽管这样生成的ID并不是绝对唯一的，有重复的可能，但事实上重复的概率非常低。对于我们的日志追踪来说，极小概率的ID重复是完全可以接受的。</p>
<pre tabindex="0"><code>103-1577456311467-3nR3Do45
103-1577456311468-0wnuV5yw
103-1577456311468-sdrnkFxN
103-1577456311468-8lwk0BP0
</code></pre><h3 id="如何发现代码质量问题">如何发现代码质量问题</h3>
<p>从大处着眼的话，我们可以参考之前讲过的代码质量评判标准，看这段代码是否可读、可扩展、可维护、灵活、简洁、可复用、可测试等等。落实到具体细节，我们可以从以下几个方面来审视代码。</p>
<ul>
<li>目录设置是否合理、模块划分是否清晰、代码结构是否满足“高内聚、松耦合”？</li>
<li>是否遵循经典的设计原则和设计思想（SOLID、DRY、KISS、YAGNI、LOD等）？</li>
<li>设计模式是否应用得当？是否有过度设计？</li>
<li>代码是否容易扩展？如果要添加新功能，是否容易实现？</li>
<li>代码是否可以复用？是否可以复用已有的项目代码或类库？是否有重复造轮子？</li>
<li>代码是否容易测试？单元测试是否全面覆盖了各种正常和异常的情况？</li>
<li>代码是否易读？是否符合编码规范（比如命名和注释是否恰当、代码风格是否一致等）？</li>
</ul>
<p>以上是一些通用的关注点，可以作为常规检查项，套用在任何代码的重构上。除此之外，我们还要关注代码实现是否满足业务本身特有的功能和非功能需求。我罗列了一些比较有共性的问题，如下所示。这份列表可能还不够全面，剩下的需要你针对具体的业务、具体的代码去具体分析。</p>
<ul>
<li>代码是否实现了预期的业务需求？</li>
<li>逻辑是否正确？是否处理了各种异常情况？</li>
<li>日志打印是否得当？是否方便debug排查问题？</li>
<li>接口是否易用？是否支持幂等、事务等？</li>
<li>代码是否存在并发问题？是否线程安全？</li>
<li>性能是否有优化空间，比如，SQL、算法是否可以优化？</li>
<li>是否有安全漏洞？比如输入输出校验是否全面？</li>
</ul>
<p><strong>现在，对照上面的检查项，我们来看一下，小王编写的代码有哪些问题。</strong></p>
<p>首先，IdGenerator的代码比较简单，只有一个类，所以，不涉及目录设置、模块划分、代码结构问题，也不违反基本的SOLID、DRY、KISS、YAGNI、LOD等设计原则。它没有应用设计模式，所以也不存在不合理使用和过度设计的问题。</p>
<p>其次，IdGenerator设计成了实现类而非接口，调用者直接依赖实现而非接口，违反基于接口而非实现编程的设计思想。实际上，将IdGenerator设计成实现类，而不定义接口，问题也不大。如果哪天ID生成算法改变了，我们只需要直接修改实现类的代码就可以。但是，如果项目中需要同时存在两种ID生成算法，也就是要同时存在两个IdGenerator实现类。比如，我们需要将这个框架给更多的系统来使用。系统在使用的时候，可以灵活地选择它需要的生成算法。这个时候，我们就需要将IdGenerator定义为接口，并且为不同的生成算法定义不同的实现类。</p>
<p>再次，把IdGenerator的generate()函数定义为静态函数，会影响使用该函数的代码的可测试性。同时，generate()函数的代码实现依赖运行环境（本机名）、时间函数、随机函数，所以generate()函数本身的可测试性也不好，需要做比较大的重构。除此之外，小王也没有编写单元测试代码，我们需要在重构时对其进行补充。</p>
<p>最后，虽然IdGenerator只包含一个函数，并且代码行数也不多，但代码的可读性并不好。特别是随机字符串生成的那部分代码，一方面，代码完全没有注释，生成算法比较难读懂，另一方面，代码里有很多魔法数，严重影响代码的可读性。在重构的时候，我们需要重点提高这部分代码的可读性。</p>
<p><strong>刚刚我们参照跟业务本身无关的、通用的代码质量关注点，对小王的代码进行了评价。现在，我们再对照业务本身的功能和非功能需求，重新审视一下小王的代码。</strong></p>
<p>前面我们提到，虽然小王的代码生成的ID并非绝对的唯一，但是对于追踪打印日志来说，是可以接受小概率ID冲突的，满足我们预期的业务需求。不过，获取hostName这部分代码逻辑貌似有点问题，并未处理“hostName为空”的情况。除此之外，尽管代码中针对获取不到本机名的情况做了异常处理，但是小王对异常的处理是在IdGenerator内部将其吐掉，然后打印一条报警日志，并没有继续往上抛出。这样的异常处理是否得当呢？你可以先自己思考一下，我们把这部分内容放到后面的课程中具体讲解。</p>
<p>小王代码的日志打印得当，日志描述能够准确反应问题，方便debug，并且没有过多的冗余日志。IdGenerator只暴露一个generate()接口供使用者使用，接口的定义简单明了，不存在不易用问题。generate()函数代码中没有涉及共享变量，所以代码线程安全，多线程环境下调用generate()函数不存在并发问题。</p>
<p>性能方面，ID的生成不依赖外部存储，在内存中生成，并且日志的打印频率也不会很高，所以小王的代码在性能方面足以应对目前的应用场景。不过，每次生成ID都需要获取本机名，获取主机名会比较耗时，所以，这部分可以考虑优化一下。还有，randomAscii的范围是0～122，但可用数字仅包含三段子区间（0~9，a~z，A~Z），极端情况下会随机生成很多三段区间之外的无效数字，需要循环很多次才能生成随机字符串，所以随机字符串的生成算法也可以优化一下。</p>
<p><strong>刚刚我们还讲到，有一些代码质量问题不具有共性，我们没法一一罗列，需要你针对具体的业务、具体的代码去具体分析。那像小王的这份代码，你还能发现有哪些具体问题吗？</strong></p>
<p>在generate()函数的while循环里面，三个if语句内部的代码非常相似，而且实现稍微有点过于复杂了，实际上可以进一步简化，将这三个if合并在一起。</p>
<h3 id="第一轮重构提高代码的可读性">第一轮重构：提高代码的可读性</h3>
<p>首先，我们要解决最明显、最急需改进的代码可读性问题。具体有下面几点：</p>
<ul>
<li>hostName变量不应该被重复使用，尤其当这两次使用时的含义还不同的时候；</li>
<li>将获取hostName的代码抽离出来，定义为getLastfieldOfHostName()函数；</li>
<li>删除代码中的魔法数，比如，57、90、97、122；</li>
<li>将随机数生成的代码抽离出来，定义为generateRandomAlphameric()函数；</li>
<li>generate()函数中的三个if逻辑重复了，且实现过于复杂，我们要对其进行简化；</li>
<li>对IdGenerator类重命名，并且抽象出对应的接口。</li>
</ul>
<p>这里我们重点讨论下最后一个修改。实际上，对于ID生成器的代码，有下面三种类的命名方式。你觉得哪种更合适呢？</p>
<p><img src="https://raw.githubusercontent.com/TezaLeMon/PicGoRepo/main/img/20221221/20221221193307.png" alt="img"></p>
<p>我们来逐一分析一下三种命名方式。</p>
<p>第一种命名方式，将接口命名为IdGenerator，实现类命名为LogTraceIdGenerator，这可能是很多人最先想到的命名方式了。在命名的时候，我们要考虑到，以后两个类会如何使用、会如何扩展。从使用和扩展的角度来分析，这样的命名就不合理了。</p>
<p>首先，如果我们扩展新的日志ID生成算法，也就是要创建另一个新的实现类，因为原来的实现类已经叫LogTraceIdGenerator了，命名过于通用，那新的实现类就不好取名了，无法取一个跟LogTraceIdGenerator平行的名字了。</p>
<p>其次，你可能会说，假设我们没有日志ID的扩展需求，但要扩展其他业务的ID生成算法，比如针对用户的（UserldGenerator）、订单的（OrderIdGenerator），第一种命名方式是不是就是合理的呢？答案也是否定的。基于接口而非实现编程，主要的目的是为了方便后续灵活地替换实现类。而LogTraceIdGenerator、UserIdGenerator、OrderIdGenerator三个类从命名上来看，涉及的是完全不同的业务，不存在互相替换的场景。</p>
<p>第二种命名方式是不是就合理了呢？答案也是否定的。其中，LogTraceIdGenerator接口的命名是合理的，但是HostNameMillisIdGenerator实现类暴露了太多实现细节，只要代码稍微有所改动，就可能需要改动命名，才能匹配实现。</p>
<p>第三种命名方式是我比较推荐的。在目前的ID生成器代码实现中，我们生成的ID是一个随机ID，不是递增有序的，所以，命名成RandomIdGenerator是比较合理的，即便内部生成算法有所改动，只要生成的还是随机的ID，就不需要改动命名。如果我们需要扩展新的ID生成算法，比如要实现一个递增有序的ID生成算法，那我们可以命名为SequenceIdGenerator。</p>
<p>实际上，更好的一种命名方式是，我们抽象出两个接口，一个是IdGenerator，一个是LogTraceIdGenerator，LogTraceIdGenerator继承IdGenerator。实现类实现接口IdGenerator，命名为RandomIdGenerator、SequenceIdGenerator等。这样，实现类可以复用到多个业务模块中，比如前面提到的用户、订单。</p>
<p>根据上面的优化策略，我们对代码进行第一轮的重构，重构之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">IdGenerator</span> <span style="color:#f92672">{</span>
  String <span style="color:#a6e22e">generate</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">LogTraceIdGenerator</span> <span style="color:#66d9ef">extends</span> IdGenerator <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RandomIdGenerator</span> <span style="color:#66d9ef">implements</span> LogTraceIdGenerator <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>RandomIdGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> getLastfieldOfHostName<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">long</span> currentTimeMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    String randomString <span style="color:#f92672">=</span> generateRandomAlphameric<span style="color:#f92672">(</span>8<span style="color:#f92672">);</span>
    String id <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s-%d-%s&#34;</span><span style="color:#f92672">,</span>
            substrOfHostName<span style="color:#f92672">,</span> currentTimeMillis<span style="color:#f92672">,</span> randomString<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getLastfieldOfHostName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      String hostName <span style="color:#f92672">=</span> InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocalHost</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostName</span><span style="color:#f92672">();</span>
      String<span style="color:#f92672">[]</span> tokens <span style="color:#f92672">=</span> hostName<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\.&#34;</span><span style="color:#f92672">);</span>
      substrOfHostName <span style="color:#f92672">=</span> tokens<span style="color:#f92672">[</span>tokens<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">];</span>
      <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>UnknownHostException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      logger<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to get the host name.&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">char</span><span style="color:#f92672">[]</span> randomChars <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">[</span>length<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    Random random <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">int</span> maxAscii <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">int</span> randomAscii <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>maxAscii<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">boolean</span> isDigit<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">boolean</span> isUppercase<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;Z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">boolean</span> isLowercase<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isDigit<span style="color:#f92672">||</span> isUppercase <span style="color:#f92672">||</span> isLowercase<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        randomChars<span style="color:#f92672">[</span>count<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">char</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>randomAscii<span style="color:#f92672">);</span>
        <span style="color:#f92672">++</span>count<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>randomChars<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">//代码使用举例
</span><span style="color:#75715e"></span>LogTraceIdGenerator logTraceIdGenerator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RandomIdGenerator<span style="color:#f92672">();</span>
</code></pre></div><h3 id="第二轮重构提高代码的可测试性">第二轮重构：提高代码的可测试性</h3>
<p>关于代码可测试性的问题，主要包含下面两个方面：</p>
<ul>
<li>generate()函数定义为静态函数，会影响使用该函数的代码的可测试性；</li>
<li>generate()函数的代码实现依赖运行环境（本机名）、时间函数、随机函数，所以generate()函数本身的可测试性也不好。</li>
</ul>
<p>对于第一点，我们已经在第一轮重构中解决了。我们将RandomIdGenerator类中的generate()静态函数重新定义成了普通函数。调用者可以通过依赖注入的方式，在外部创建好RandomIdGenerator对象后注入到自己的代码中，从而解决静态函数调用影响代码可测试性的问题。</p>
<p>对于第二点，我们需要在第一轮重构的基础之上再进行重构。重构之后的代码如下所示，主要包括以下几个代码改动。</p>
<ul>
<li>从getLastfieldOfHostName()函数中，将逻辑比较复杂的那部分代码剥离出来，定义为getLastSubstrSplittedByDot()函数。因为getLastfieldOfHostName()函数依赖本地主机名，所以，剥离出主要代码之后这个函数变得非常简单，可以不用测试。我们重点测试getLastSubstrSplittedByDot()函数即可。</li>
<li>将generateRandomAlphameric()和getLastSubstrSplittedByDot()这两个函数的访问权限设置为protected。这样做的目的是，可以直接在单元测试中通过对象来调用两个函数进行测试。</li>
<li>给generateRandomAlphameric()和getLastSubstrSplittedByDot()两个函数添加Google Guava的annotation @VisibleForTesting。这个annotation没有任何实际的作用，只起到标识的作用，告诉其他人说，这两个函数本该是private访问权限的，之所以提升访问权限到protected，只是为了测试，只能用于单元测试中。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RandomIdGenerator</span> <span style="color:#66d9ef">implements</span> LogTraceIdGenerator <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>RandomIdGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> getLastfieldOfHostName<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">long</span> currentTimeMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    String randomString <span style="color:#f92672">=</span> generateRandomAlphameric<span style="color:#f92672">(</span>8<span style="color:#f92672">);</span>
    String id <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s-%d-%s&#34;</span><span style="color:#f92672">,</span>
            substrOfHostName<span style="color:#f92672">,</span> currentTimeMillis<span style="color:#f92672">,</span> randomString<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getLastfieldOfHostName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      String hostName <span style="color:#f92672">=</span> InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocalHost</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostName</span><span style="color:#f92672">();</span>
      substrOfHostName <span style="color:#f92672">=</span> getLastSubstrSplittedByDot<span style="color:#f92672">(</span>hostName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>UnknownHostException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      logger<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to get the host name.&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span>String hostName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String<span style="color:#f92672">[]</span> tokens <span style="color:#f92672">=</span> hostName<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\.&#34;</span><span style="color:#f92672">);</span>
    String substrOfHostName <span style="color:#f92672">=</span> tokens<span style="color:#f92672">[</span>tokens<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">char</span><span style="color:#f92672">[]</span> randomChars <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">[</span>length<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    Random random <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">int</span> maxAscii <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">int</span> randomAscii <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>maxAscii<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">boolean</span> isDigit<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">boolean</span> isUppercase<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;Z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">boolean</span> isLowercase<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isDigit<span style="color:#f92672">||</span> isUppercase <span style="color:#f92672">||</span> isLowercase<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        randomChars<span style="color:#f92672">[</span>count<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">char</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>randomAscii<span style="color:#f92672">);</span>
        <span style="color:#f92672">++</span>count<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>randomChars<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="第三轮重构编写完善的单元测试">第三轮重构：编写完善的单元测试</h3>
<p>经过上面的重构之后，代码存在的比较明显的问题，基本上都已经解决了。我们现在为代码补全单元测试。RandomIdGenerator类中有4个函数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">();</span>
<span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getLastfieldOfHostName</span><span style="color:#f92672">();</span>
<span style="color:#a6e22e">@VisibleForTesting</span>
<span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span>String hostName<span style="color:#f92672">);</span>
<span style="color:#a6e22e">@VisibleForTesting</span>
<span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> length<span style="color:#f92672">);</span>
</code></pre></div><p>我们先来看后两个函数。这两个函数包含的逻辑比较复杂，是我们测试的重点。而且，在上一步重构中，为了提高代码的可测试性，我们已经将这两个部分代码跟不可控的组件（本机名、随机函数、时间函数）进行了隔离。所以，我们只需要设计完备的单元测试用例即可。具体的代码实现如下所示（注意，我们使用了JUnit测试框架）：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RandomIdGeneratorTest</span> <span style="color:#f92672">{</span>
  <span style="color:#a6e22e">@Test</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testGetLastSubstrSplittedByDot</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    RandomIdGenerator idGenerator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RandomIdGenerator<span style="color:#f92672">();</span>
    String actualSubstr <span style="color:#f92672">=</span> idGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;field1.field2.field3&#34;</span><span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertEquals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;field3&#34;</span><span style="color:#f92672">,</span> actualSubstr<span style="color:#f92672">);</span>

    actualSubstr <span style="color:#f92672">=</span> idGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;field1&#34;</span><span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertEquals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;field1&#34;</span><span style="color:#f92672">,</span> actualSubstr<span style="color:#f92672">);</span>

    actualSubstr <span style="color:#f92672">=</span> idGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;field1#field2$field3&#34;</span><span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertEquals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;field1#field2#field3&#34;</span><span style="color:#f92672">,</span> actualSubstr<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#75715e">// 此单元测试会失败，因为我们在代码中没有处理hostName为null或空字符串的情况
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// 这部分优化留在第36、37节课中讲解
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Test</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testGetLastSubstrSplittedByDot_nullOrEmpty</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    RandomIdGenerator idGenerator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RandomIdGenerator<span style="color:#f92672">();</span>
    String actualSubstr <span style="color:#f92672">=</span> idGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertNull</span><span style="color:#f92672">(</span>actualSubstr<span style="color:#f92672">);</span>

    actualSubstr <span style="color:#f92672">=</span> idGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertEquals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> actualSubstr<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Test</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testGenerateRandomAlphameric</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    RandomIdGenerator idGenerator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RandomIdGenerator<span style="color:#f92672">();</span>
    String actualRandomString <span style="color:#f92672">=</span> idGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(</span>6<span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertNotNull</span><span style="color:#f92672">(</span>actualRandomString<span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertEquals</span><span style="color:#f92672">(</span>6<span style="color:#f92672">,</span> actualRandomString<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">());</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">char</span> c <span style="color:#f92672">:</span> actualRandomString<span style="color:#f92672">.</span><span style="color:#a6e22e">toCharArray</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertTrue</span><span style="color:#f92672">((</span><span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">&lt;</span> c <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&lt;</span> c <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">&lt;</span> c <span style="color:#f92672">&amp;&amp;</span> c <span style="color:#f92672">&lt;</span> <span style="color:#e6db74">&#39;Z&#39;</span><span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>

  <span style="color:#75715e">// 此单元测试会失败，因为我们在代码中没有处理length&lt;=0的情况
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// 这部分优化留在第36、37节课中讲解
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@Test</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testGenerateRandomAlphameric_lengthEqualsOrLessThanZero</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    RandomIdGenerator idGenerator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RandomIdGenerator<span style="color:#f92672">();</span>
    String actualRandomString <span style="color:#f92672">=</span> idGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(</span>0<span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertEquals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">,</span> actualRandomString<span style="color:#f92672">);</span>

    actualRandomString <span style="color:#f92672">=</span> idGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(-</span>1<span style="color:#f92672">);</span>
    Assert<span style="color:#f92672">.</span><span style="color:#a6e22e">assertNull</span><span style="color:#f92672">(</span>actualRandomString<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>我们再来看generate()函数。这个函数也是我们唯一一个暴露给外部使用的public函数。虽然逻辑比较简单，最好还是测试一下。但是，它依赖主机名、随机函数、时间函数，我们该如何测试呢？需要mock这些函数的实现吗？</p>
<p>实际上，这要分情况来看。我们前面讲过，写单元测试的时候，测试对象是函数定义的功能，而非具体的实现逻辑。这样我们才能做到，函数的实现逻辑改变了之后，单元测试用例仍然可以工作。那generate()函数实现的功能是什么呢？这完全是由代码编写者自己来定义的。</p>
<p>比如，针对同一份generate()函数的代码实现，我们可以有3种不同的功能定义，对应3种不同的单元测试。</p>
<ol>
<li>如果我们把generate()函数的功能定义为：“生成一个随机唯一ID”，那我们只要测试多次调用generate()函数生成的ID是否唯一即可。</li>
<li>如果我们把generate()函数的功能定义为：“生成一个只包含数字、大小写字母和中划线的唯一ID”，那我们不仅要测试ID的唯一性，还要测试生成的ID是否只包含数字、大小写字母和中划线。</li>
<li>如果我们把generate()函数的功能定义为：“生成唯一ID，格式为：{主机名substr}-{时间戳}-{8位随机数}。在主机名获取失败时，返回：null-{时间戳}-{8位随机数}”，那我们不仅要测试ID的唯一性，还要测试生成的ID是否完全符合格式要求。</li>
</ol>
<p>**总结一下，单元测试用例如何写，关键看你如何定义函数。**针对generate()函数的前两种定义，我们不需要mock获取主机名函数、随机函数、时间函数等，但对于第3种定义，我们需要mock获取主机名函数，让其返回null，测试代码运行是否符合预期。</p>
<p>最后，我们来看下getLastfieldOfHostName()函数。实际上，这个函数不容易测试，因为它调用了一个静态函数（InetAddress.getLocalHost().getHostName();），并且这个静态函数依赖运行环境。但是，这个函数的实现非常简单，肉眼基本上可以排除明显的bug，所以我们可以不为其编写单元测试代码。毕竟，我们写单元测试的目的是为了减少代码bug，而不是为了写单元测试而写单元测试。</p>
<p>当然，如果你真的想要对它进行测试，我们也是有办法的。一种办法是使用更加高级的测试框架。比如PowerMock，它可以mock静态函数。另一种方式是将获取本机名的逻辑再封装为一个新的函数。不过，后一种方法会造成代码过度零碎，也会稍微影响到代码的可读性，这个需要你自己去权衡利弊来做选择。</p>
<h3 id="第四轮重构添加注释">第四轮重构：添加注释</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * Id Generator that is used to generate random IDs.
</span><span style="color:#75715e"> *
</span><span style="color:#75715e"> * &lt;p&gt;
</span><span style="color:#75715e"> * The IDs generated by this class are not absolutely unique,
</span><span style="color:#75715e"> * but the probability of duplication is very low.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RandomIdGenerator</span> <span style="color:#66d9ef">implements</span> LogTraceIdGenerator <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>RandomIdGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

  <span style="color:#75715e">/**
</span><span style="color:#75715e">   * Generate the random ID. The IDs may be duplicated only in extreme situation.
</span><span style="color:#75715e">   *
</span><span style="color:#75715e">   * @return an random ID
</span><span style="color:#75715e">   */</span>
  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#75715e">/**
</span><span style="color:#75715e">   * Get the local hostname and
</span><span style="color:#75715e">   * extract the last field of the name string splitted by delimiter &#39;.&#39;.
</span><span style="color:#75715e">   *
</span><span style="color:#75715e">   * @return the last field of hostname. Returns null if hostname is not obtained.
</span><span style="color:#75715e">   */</span>
  <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getLastfieldOfHostName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#75715e">/**
</span><span style="color:#75715e">   * Get the last field of {@hostName} splitted by delemiter &#39;.&#39;.
</span><span style="color:#75715e">   *
</span><span style="color:#75715e">   * @param hostName should not be null
</span><span style="color:#75715e">   * @return the last field of {@hostName}. Returns empty string if {@hostName} is empty string.
</span><span style="color:#75715e">   */</span>
  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span>String hostName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>

  <span style="color:#75715e">/**
</span><span style="color:#75715e">   * Generate random string which
</span><span style="color:#75715e">   * only contains digits, uppercase letters and lowercase letters.
</span><span style="color:#75715e">   *
</span><span style="color:#75715e">   * @param length should not be less than 0
</span><span style="color:#75715e">   * @return the random string. Returns empty string if {@length} is 0
</span><span style="color:#75715e">   */</span>
  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h2 id="实战异常处理">实战：异常处理</h2>
<p>我们可以把函数的运行结果分为两类。一类是预期的结果，也就是函数在正常情况下输出的结果。一类是非预期的结果，也就是函数在异常（或叫出错）情况下输出的结果。比如，在上一节课中，获取本机名的函数，在正常情况下，函数返回字符串格式的本机名；在异常情况下，获取本机名失败，函数返回UnknownHostException异常对象。</p>
<p>在正常情况下，函数返回数据的类型非常明确，但是，在异常情况下，函数返回的数据类型却非常灵活，有多种选择。除了刚刚提到的类似UnknownHostException这样的异常对象之外，函数在异常情况下还可以返回错误码、NULL值、特殊值（比如-1）、空对象（比如空字符串、空集合）等。</p>
<p>每一种异常返回数据类型，都有各自的特点和适用场景。但有的时候，在异常情况下，函数到底该返回什么样的数据类型，并不那么容易判断。比如，上节课中，在本机名获取失败的时候，ID生成器的generate()函数应该返回什么呢？是异常？空字符？还是NULL值？又或者是其他特殊值（比如null-15293834874-fd3A9KBn，null表示本机名未获取到）呢？</p>
<p>对于上一节的代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RandomIdGenerator</span> <span style="color:#66d9ef">implements</span> IdGenerator <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>RandomIdGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> getLastFiledOfHostName<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">long</span> currentTimeMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    String randomString <span style="color:#f92672">=</span> generateRandomAlphameric<span style="color:#f92672">(</span>8<span style="color:#f92672">);</span>
    String id <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s-%d-%s&#34;</span><span style="color:#f92672">,</span>
            substrOfHostName<span style="color:#f92672">,</span> currentTimeMillis<span style="color:#f92672">,</span> randomString<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getLastFiledOfHostName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      String hostName <span style="color:#f92672">=</span> InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocalHost</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostName</span><span style="color:#f92672">();</span>
      substrOfHostName <span style="color:#f92672">=</span> getLastSubstrSplittedByDot<span style="color:#f92672">(</span>hostName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>UnknownHostException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      logger<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to get the host name.&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span>String hostName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String<span style="color:#f92672">[]</span> tokens <span style="color:#f92672">=</span> hostName<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\.&#34;</span><span style="color:#f92672">);</span>
    String substrOfHostName <span style="color:#f92672">=</span> tokens<span style="color:#f92672">[</span>tokens<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">char</span><span style="color:#f92672">[]</span> randomChars <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">[</span>length<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    Random random <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">int</span> maxAscii <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">int</span> randomAscii <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>maxAscii<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">boolean</span> isDigit<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">boolean</span> isUppercase<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;Z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">boolean</span> isLowercase<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isDigit<span style="color:#f92672">||</span> isUppercase <span style="color:#f92672">||</span> isLowercase<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        randomChars<span style="color:#f92672">[</span>count<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">char</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>randomAscii<span style="color:#f92672">);</span>
        <span style="color:#f92672">++</span>count<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>randomChars<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>这段代码中有四个函数。针对这四个函数的出错处理方式，我总结出下面这样几个问题。</p>
<ul>
<li>对于generate()函数，如果本机名获取失败，函数返回什么？这样的返回值是否合理？</li>
<li>对于getLastFiledOfHostName()函数，是否应该将UnknownHostException异常在函数内部吞掉（try-catch并打印日志）？还是应该将异常继续往上抛出？如果往上抛出的话，是直接把UnknownHostException异常原封不动地抛出，还是封装成新的异常抛出？</li>
<li>对于getLastSubstrSplittedByDot(String hostName)函数，如果hostName为NULL或者是空字符串，这个函数应该返回什么？</li>
<li>对于generateRandomAlphameric(int length)函数，如果length小于0或者等于0，这个函数应该返回什么？</li>
</ul>
<h3 id="函数出错的返回">函数出错的返回</h3>
<p>关于函数出错返回数据类型，我总结了4种情况，它们分别是：错误码、NULL值、空对象、异常对象。接下来，我们就一一来看它们的用法以及适用场景。</p>
<h5 id="返回错误码">返回错误码</h5>
<p>C语言中没有异常这样的语法机制，因此，返回错误码便是最常用的出错处理方式。而在Java、Python等比较新的编程语言中，大部分情况下，我们都用异常来处理函数出错的情况，极少会用到错误码。</p>
<p>在C语言中，错误码的返回方式有两种：一种是直接占用函数的返回值，函数正常执行的返回值放到出参中；另一种是将错误码定义为全局变量，在函数执行出错时，函数调用者通过这个全局变量来获取错误码。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#75715e">// 错误码的返回方式一：pathname/flags/mode为入参；fd为出参，存储打开的文件句柄。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">open</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, <span style="color:#66d9ef">int</span> flags, mode_t mode, <span style="color:#66d9ef">int</span><span style="color:#f92672">*</span> fd) {
  <span style="color:#66d9ef">if</span> (<span style="color:#75715e">/*文件不存在*/</span>) {
    <span style="color:#66d9ef">return</span> EEXIST;
  }
  
  <span style="color:#66d9ef">if</span> (<span style="color:#75715e">/*没有访问权限*/</span>) {
    <span style="color:#66d9ef">return</span> EACCESS;
  }
  
  <span style="color:#66d9ef">if</span> (<span style="color:#75715e">/*打开文件成功*/</span>) {
    <span style="color:#66d9ef">return</span> SUCCESS; <span style="color:#75715e">// C语言中的宏定义：#define SUCCESS 0
</span><span style="color:#75715e"></span>  }
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">//使用举例
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> fd;
<span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> open(<span style="color:#960050;background-color:#1e0010">“</span>c:<span style="color:#960050;background-color:#1e0010">\</span>test.txt<span style="color:#960050;background-color:#1e0010">”</span>, O_RDWR, S_IRWXU<span style="color:#f92672">|</span>S_IRWXG<span style="color:#f92672">|</span>S_IRWXO, <span style="color:#f92672">&amp;</span>fd);
<span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> SUCCESS) {
  <span style="color:#75715e">// 取出fd使用
</span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> EEXIST) {
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> EACESS) {
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// 错误码的返回方式二：函数返回打开的文件句柄，错误码放到errno中。
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> errno; <span style="color:#75715e">// 线程安全的全局变量
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">open</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, <span style="color:#66d9ef">int</span> flags, mode_t mode<span style="color:#960050;background-color:#1e0010">）</span>{
  <span style="color:#66d9ef">if</span> (<span style="color:#75715e">/*文件不存在*/</span>) {
    errno <span style="color:#f92672">=</span> EEXIST;
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }
  
  <span style="color:#66d9ef">if</span> (<span style="color:#75715e">/*没有访问权限*/</span>) {
    errno <span style="color:#f92672">=</span> EACCESS;
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
  }
  
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">// 使用举例
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> hFile <span style="color:#f92672">=</span> open(<span style="color:#960050;background-color:#1e0010">“</span>c:<span style="color:#960050;background-color:#1e0010">\</span>test.txt<span style="color:#960050;background-color:#1e0010">”</span>, O_RDWR, S_IRWXU<span style="color:#f92672">|</span>S_IRWXG<span style="color:#f92672">|</span>S_IRWXO);
<span style="color:#66d9ef">if</span> (<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">==</span> hFile) {
  printf(<span style="color:#e6db74">&#34;Failed to open file, error no: %d.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, errno);
  <span style="color:#66d9ef">if</span> (errno <span style="color:#f92672">==</span> EEXIST ) {
    <span style="color:#75715e">// ...        
</span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span>(errno <span style="color:#f92672">==</span> EACCESS) {
    <span style="color:#75715e">// ...    
</span><span style="color:#75715e"></span>  }
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>实际上，如果你熟悉的编程语言中有异常这种语法机制，那就尽量不要使用错误码。异常相对于错误码，有诸多方面的优势，比如可以携带更多的错误信息（exception中可以有message、stack trace等信息）等。</p>
<h5 id="返回null值">返回NULL值</h5>
<p>在多数编程语言中，我们用NULL来表示“不存在”这种语义。不过，网上很多人不建议函数返回NULL值，认为这是一种不好的设计思路，主要的理由有以下两个。</p>
<ul>
<li>如果某个函数有可能返回NULL值，我们在使用它的时候，忘记了做NULL值判断，就有可能会抛出<strong>空指针异常</strong>（Null Pointer Exception，缩写为NPE）。</li>
<li>如果我们定义了很多返回值可能为NULL的函数，那代码中就会充斥着大量的NULL值判断逻辑，一方面写起来比较繁琐，另一方面它们跟正常的业务逻辑耦合在一起，会影响代码的可读性。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserService</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> UserRepo userRepo<span style="color:#f92672">;</span> <span style="color:#75715e">// 依赖注入
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> User <span style="color:#a6e22e">getUser</span><span style="color:#f92672">(</span>String telephone<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// 如果用户不存在，则返回null
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#75715e">// 使用函数getUser()
</span><span style="color:#75715e"></span>User user <span style="color:#f92672">=</span> userService<span style="color:#f92672">.</span><span style="color:#a6e22e">getUser</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;18917718965&#34;</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>user <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// 做NULL值判断，否则有可能会报NPE
</span><span style="color:#75715e"></span>  String email <span style="color:#f92672">=</span> user<span style="color:#f92672">.</span><span style="color:#a6e22e">getEmail</span><span style="color:#f92672">();</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>email <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// 做NULL值判断，否则有可能会报NPE
</span><span style="color:#75715e"></span>    String escapedEmail <span style="color:#f92672">=</span> email<span style="color:#f92672">.</span><span style="color:#a6e22e">replaceAll</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;#&#34;</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>那我们是否可以用异常来替代NULL值，在查找用户不存在的时候，让函数抛出UserNotFoundException异常呢？</p>
<p>我个人觉得，尽管返回NULL值有诸多弊端，但对于以get、find、select、search、query等单词开头的查找函数来说，数据不存在，并非一种异常情况，这是一种正常行为。所以，返回代表不存在语义的NULL值比返回异常更加合理。</p>
<p>不过，话说回来，刚刚讲的这个理由，也并不是特别有说服力。对于查找数据不存在的情况，函数到底是该用NULL值还是异常，有一个比较重要的参考标准是，看项目中的其他类似查找函数都是如何定义的，只要整个项目遵从统一的约定即可。如果项目从零开始开发，并没有统一约定和可以参考的代码，那你选择两者中的任何一种都可以。你只需要在函数定义的地方注释清楚，让调用者清晰地知道数据不存在的时候会返回什么就可以了。</p>
<p>再补充说明一点，对于查找函数来说，除了返回数据对象之外，有的还会返回下标位置，比如Java中的indexOf()函数，用来实现在某个字符串中查找另一个子串第一次出现的位置。函数的返回值类型为基本类型int。这个时候，我们就无法用NULL值来表示不存在的情况了。对于这种情况，我们有两种处理思路，一种是返回NotFoundException，一种是返回一个特殊值，比如-1。不过，显然-1更加合理，理由也是同样的，也就是说“没有查找到”是一种正常而非异常的行为。</p>
<h5 id="返回空对象">返回空对象</h5>
<p>刚刚我们讲到，返回NULL值有各种弊端。应对这个问题有一个比较经典的策略，那就是应用空对象设计模式（Null Object Design Pattern）。关于这个设计模式，我们在后面章节会详细讲，现在就不展开来讲解了。不过，我们今天来讲两种比较简单、比较特殊的空对象，那就是<strong>空字符串</strong>和<strong>空集合</strong>。</p>
<p>当函数返回的数据是字符串类型或者集合类型的时候，我们可以用空字符串或空集合替代NULL值，来表示不存在的情况。这样，我们在使用函数的时候，就可以不用做NULL值判断。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// 使用空集合替代NULL
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserService</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> UserRepo userRepo<span style="color:#f92672">;</span> <span style="color:#75715e">// 依赖注入
</span><span style="color:#75715e"></span>  
  <span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>User<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getUsers</span><span style="color:#f92672">(</span>String telephonePrefix<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
   <span style="color:#75715e">// 没有查找到数据
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">emptyList</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// getUsers使用示例
</span><span style="color:#75715e"></span>List<span style="color:#f92672">&lt;</span>User<span style="color:#f92672">&gt;</span> users <span style="color:#f92672">=</span> userService<span style="color:#f92672">.</span><span style="color:#a6e22e">getUsers</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;189&#34;</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>User user <span style="color:#f92672">:</span> users<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//这里不需要做NULL值判断
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#75715e">// 使用空字符串替代NULL
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">retrieveUppercaseLetters</span><span style="color:#f92672">(</span>String text<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// 如果text中没有大写字母，返回空字符串，而非NULL值
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// retrieveUppercaseLetters()使用举例
</span><span style="color:#75715e"></span>String uppercaseLetters <span style="color:#f92672">=</span> retrieveUppercaseLetters<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wangzheng&#34;</span><span style="color:#f92672">);</span>
<span style="color:#66d9ef">int</span> length <span style="color:#f92672">=</span> uppercaseLetters<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">();</span><span style="color:#75715e">// 不需要做NULL值判断 
</span><span style="color:#75715e"></span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Contains &#34;</span> <span style="color:#f92672">+</span> length <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; upper case letters.&#34;</span><span style="color:#f92672">);</span>
</code></pre></div><h4 id="抛出异常对象">抛出异常对象</h4>
<p>尽管前面讲了很多函数出错的返回数据类型，但是，最常用的函数出错处理方式就是抛出异常。异常可以携带更多的错误信息，比如函数调用栈信息。除此之外，异常可以将正常逻辑和异常逻辑的处理分离开来，这样代码的可读性就会更好。</p>
<p>不同的编程语言的异常语法稍有不同。像C++和大部分的动态语言（Python、Ruby、JavaScript等）都只定义了一种异常类型：运行时异常（Runtime Exception）。而像Java，除了运行时异常外，还定义了另外一种异常类型：编译时异常（Compile Exception）。</p>
<p>对于运行时异常，我们在编写代码的时候，可以不用主动去try-catch，编译器在编译代码的时候，并不会检查代码是否有对运行时异常做了处理。相反，对于编译时异常，我们在编写代码的时候，需要主动去try-catch或者在函数定义中声明，否则编译就会报错。所以，运行时异常也叫作非受检异常（Unchecked Exception），编译时异常也叫作受检异常（Checked Exception）。</p>
<p>如果你熟悉的编程语言中，只定义了一种异常类型，那用起来反倒比较简单。如果你熟悉的编程语言中（比如Java），定义了两种异常类型，那在异常出现的时候，我们应该选择抛出哪种异常类型呢？是受检异常还是非受检异常？</p>
<p>对于代码bug（比如数组越界）以及不可恢复异常（比如数据库连接失败），即便我们捕获了，也做不了太多事情，所以，我们倾向于使用非受检异常。对于可恢复异常、业务异常，比如提现金额大于余额的异常，我们更倾向于使用受检异常，明确告知调用者需要捕获处理。</p>
<p>我举一个例子解释一下，代码如下所示。当Redis的地址（参数address）没有设置的时候，我们直接使用默认的地址（比如本地地址和默认端口）；当Redis的地址格式不正确的时候，我们希望程序能fail-fast，也就是说，把这种情况当成不可恢复的异常，直接抛出运行时异常，将程序终止掉。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// address格式：&#34;192.131.2.33:7896&#34;
</span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parseRedisAddress</span><span style="color:#f92672">(</span>String address<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">host</span> <span style="color:#f92672">=</span> RedisConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_HOST</span><span style="color:#f92672">;</span>
  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> RedisConfig<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT_PORT</span><span style="color:#f92672">;</span>
  
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>address<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  String<span style="color:#f92672">[]</span> ipAndPort <span style="color:#f92672">=</span> address<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;:&#34;</span><span style="color:#f92672">);</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ipAndPort<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">!=</span> 2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">host</span> <span style="color:#f92672">=</span> ipAndPort<span style="color:#f92672">[</span>0<span style="color:#f92672">];</span>
  <span style="color:#75715e">// parseInt()解析失败会抛出NumberFormatException运行时异常
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">port</span> <span style="color:#f92672">=</span> Integer<span style="color:#f92672">.</span><span style="color:#a6e22e">parseInt</span><span style="color:#f92672">(</span>ipAndPort<span style="color:#f92672">[</span>1<span style="color:#f92672">]);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>实际上，Java支持的受检异常一直被人诟病，很多人主张所有的异常情况都应该使用非受检异常。支持这种观点的理由主要有以下三个。</p>
<ul>
<li>受检异常需要显式地在函数定义中声明。如果函数会抛出很多受检异常，那函数的定义就会非常冗长，这就会影响代码的可读性，使用起来也不方便。</li>
<li>编译器强制我们必须显示地捕获所有的受检异常，代码实现会比较繁琐。而非受检异常正好相反，我们不需要在定义中显示声明，并且是否需要捕获处理，也可以自由决定。</li>
<li>受检异常的使用违反开闭原则。如果我们给某个函数新增一个受检异常，这个函数所在的函数调用链上的所有位于其之上的函数都需要做相应的代码修改，直到调用链中的某个函数将这个新增的异常try-catch处理掉为止。而新增非受检异常可以不改动调用链上的代码。我们可以灵活地选择在某个函数中集中处理，比如在Spring中的AOP切面中集中处理异常。</li>
</ul>
<p>不过，非受检异常也有弊端，它的优点其实也正是它的缺点。从刚刚的表述中，我们可以看出，非受检异常使用起来更加灵活，怎么处理的主动权这里就交给了程序员。我们前面也讲到，过于灵活会带来不可控，非受检异常不需要显式地在函数定义中声明，那我们在使用函数的时候，就需要查看代码才能知道具体会抛出哪些异常。非受检异常不需要强制捕获处理，那程序员就有可能漏掉一些本应该捕获处理的异常。</p>
<p>**刚刚我们讲了两种异常类型，现在我们再来讲下，如何处理函数抛出的异常？**总结一下，一般有下面三种处理方法。</p>
<ul>
<li>直接吞掉。具体的代码示例如下所示：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func1</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception1 <span style="color:#f92672">{</span>
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func2</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    func1<span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception1 e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    log<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span> <span style="color:#75715e">//吐掉：try-catch打印日志
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>原封不动地re-throw。具体的代码示例如下所示：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func1</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception1 <span style="color:#f92672">{</span>
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>


<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func2</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception1 <span style="color:#f92672">{</span><span style="color:#75715e">//原封不动的re-throw Exception1
</span><span style="color:#75715e"></span>  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  func1<span style="color:#f92672">();</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>包装成新的异常re-throw。具体的代码示例如下所示：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func1</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception1 <span style="color:#f92672">{</span>
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>


<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func2</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> Exception2 <span style="color:#f92672">{</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    func1<span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span><span style="color:#f92672">(</span>Exception1 e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
   <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Exception2<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span> <span style="color:#75715e">// wrap成新的Exception2然后re-throw
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
  <span style="color:#75715e">//...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>当我们面对函数抛出异常的时候，应该选择上面的哪种处理方式呢？我总结了下面三个参考原则：</p>
<ul>
<li>如果func1()抛出的异常是可以恢复，且func2()的调用方并不关心此异常，我们完全可以在func2()内将func1()抛出的异常吞掉；</li>
<li>如果func1()抛出的异常对func2()的调用方来说，也是可以理解的、关心的 ，并且在业务概念上有一定的相关性，我们可以选择直接将func1抛出的异常re-throw；</li>
<li>如果func1()抛出的异常太底层，对func2()的调用方来说，缺乏背景去理解、且业务概念上无关，我们可以将它重新包装成调用方可以理解的新异常，然后re-throw。</li>
</ul>
<p>总之，是否往上继续抛出，要看上层代码是否关心这个异常。关心就将它抛出，否则就直接吞掉。是否需要包装成新的异常抛出，看上层代码是否能理解这个异常、是否业务相关。如果能理解、业务相关就可以直接抛出，否则就封装成新的异常抛出。</p>
<h3 id="重构id生成器项目中各函数的异常处理代码">重构ID生成器项目中各函数的异常处理代码</h3>
<h4 id="重构generate函数">重构generate()函数</h4>
<p>首先，我们来看，对于generate()函数，如果本机名获取失败，函数返回什么？这样的返回值是否合理？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> getLastFieldOfHostName<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">long</span> currentTimeMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    String randomString <span style="color:#f92672">=</span> generateRandomAlphameric<span style="color:#f92672">(</span>8<span style="color:#f92672">);</span>
    String id <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s-%d-%s&#34;</span><span style="color:#f92672">,</span>
            substrOfHostName<span style="color:#f92672">,</span> currentTimeMillis<span style="color:#f92672">,</span> randomString<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>ID由三部分构成：本机名、时间戳和随机数。时间戳和随机数的生成函数不会出错，唯独主机名有可能获取失败。在目前的代码实现中，如果主机名获取失败，substrOfHostName为NULL，那generate()函数会返回类似“null-16723733647-83Ab3uK6”这样的数据。如果主机名获取失败，substrOfHostName为空字符串，那generate()函数会返回类似“-16723733647-83Ab3uK6”这样的数据。</p>
<p>在异常情况下，返回上面两种特殊的ID数据格式，这样的做法是否合理呢？这个其实很难讲，我们要看具体的业务是怎么设计的。不过，我更倾向于明确地将异常告知调用者。所以，这里最好是抛出受检异常，而非特殊值。</p>
<p>按照这个设计思路，我们对generate()函数进行重构。重构之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IdGenerationFailureException <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> getLastFieldOfHostName<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>substrOfHostName <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> substrOfHostName<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IdGenerationFailureException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;host name is empty.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">long</span> currentTimeMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    String randomString <span style="color:#f92672">=</span> generateRandomAlphameric<span style="color:#f92672">(</span>8<span style="color:#f92672">);</span>
    String id <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s-%d-%s&#34;</span><span style="color:#f92672">,</span>
            substrOfHostName<span style="color:#f92672">,</span> currentTimeMillis<span style="color:#f92672">,</span> randomString<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
</code></pre></div><h4 id="重构getlastfieldofhostname函数">重构getLastFieldOfHostName()函数</h4>
<p>对于getLastFieldOfHostName()函数，是否应该将UnknownHostException异常在函数内部吞掉（try-catch并打印日志），还是应该将异常继续往上抛出？如果往上抛出的话，是直接把UnknownHostException异常原封不动地抛出，还是封装成新的异常抛出？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getLastFieldOfHostName</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      String hostName <span style="color:#f92672">=</span> InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocalHost</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostName</span><span style="color:#f92672">();</span>
      substrOfHostName <span style="color:#f92672">=</span> getLastSubstrSplittedByDot<span style="color:#f92672">(</span>hostName<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>UnknownHostException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      logger<span style="color:#f92672">.</span><span style="color:#a6e22e">warn</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Failed to get the host name.&#34;</span><span style="color:#f92672">,</span> e<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
 <span style="color:#f92672">}</span>
</code></pre></div><p>现在的处理方式是当主机名获取失败的时候，getLastFieldOfHostName()函数返回NULL值。我们前面讲过，是返回NULL值还是异常对象，要看获取不到数据是正常行为，还是异常行为。获取主机名失败会影响后续逻辑的处理，并不是我们期望的，所以，它是一种异常行为。这里最好是抛出异常，而非返回NULL值。</p>
<p>至于是直接将UnknownHostException抛出，还是重新封装成新的异常抛出，要看函数跟异常是否有业务相关性。getLastFieldOfHostName()函数用来获取主机名的最后一个字段，UnknownHostException异常表示主机名获取失败，两者算是业务相关，所以可以直接将UnknownHostException抛出，不需要重新包裹成新的异常。</p>
<p>按照上面的设计思路，我们对getLastFieldOfHostName()函数进行重构。重构后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getLastFieldOfHostName</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> UnknownHostException<span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    String hostName <span style="color:#f92672">=</span> InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocalHost</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostName</span><span style="color:#f92672">();</span>
    substrOfHostName <span style="color:#f92672">=</span> getLastSubstrSplittedByDot<span style="color:#f92672">(</span>hostName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
 <span style="color:#f92672">}</span>
</code></pre></div><p>getLastFieldOfHostName()函数修改之后，generate()函数也要做相应的修改。我们需要在generate()函数中，捕获getLastFieldOfHostName()抛出的UnknownHostException异常。当我们捕获到这个异常之后，应该怎么处理呢？</p>
<p>按照之前的分析，ID生成失败的时候，我们需要明确地告知调用者。所以，我们不能在generate()函数中，将UnknownHostException这个异常吞掉。那我们应该原封不动地抛出，还是封装成新的异常抛出呢？</p>
<p>我们选择后者。在generate()函数中，我们需要捕获UnknownHostException异常，并重新包裹成新的异常IdGenerationFailureException往上抛出。之所以这么做，有下面三个原因。</p>
<ul>
<li>调用者在使用generate()函数的时候，只需要知道它生成的是随机唯一ID，并不关心ID是如何生成的。也就说是，这是依赖抽象而非实现编程。如果generate()函数直接抛出UnknownHostException异常，实际上是暴露了实现细节。</li>
<li>从代码封装的角度来讲，我们不希望将UnknownHostException这个比较底层的异常，暴露给更上层的代码，也就是调用generate()函数的代码。而且，调用者拿到这个异常的时候，并不能理解这个异常到底代表了什么，也不知道该如何处理。</li>
<li>UnknownHostException异常跟generate()函数，在业务概念上没有相关性。</li>
</ul>
<p>按照上面的设计思路，我们对generate()的函数再次进行重构。重构后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">generate</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IdGenerationFailureException <span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      substrOfHostName <span style="color:#f92672">=</span> getLastFieldOfHostName<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>UnknownHostException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IdGenerationFailureException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;host name is empty.&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">long</span> currentTimeMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
    String randomString <span style="color:#f92672">=</span> generateRandomAlphameric<span style="color:#f92672">(</span>8<span style="color:#f92672">);</span>
    String id <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;%s-%d-%s&#34;</span><span style="color:#f92672">,</span>
            substrOfHostName<span style="color:#f92672">,</span> currentTimeMillis<span style="color:#f92672">,</span> randomString<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> id<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
</code></pre></div><h4 id="重构getlastsubstrsplittedbydot函数">重构getLastSubstrSplittedByDot()函数</h4>
<p>对于getLastSubstrSplittedByDot(String hostName)函数，如果hostName为NULL或者空字符串，这个函数应该返回什么？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span>String hostName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String<span style="color:#f92672">[]</span> tokens <span style="color:#f92672">=</span> hostName<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\.&#34;</span><span style="color:#f92672">);</span>
    String substrOfHostName <span style="color:#f92672">=</span> tokens<span style="color:#f92672">[</span>tokens<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>理论上讲，参数传递的正确性应该有程序员来保证，我们无需做NULL值或者空字符串的判断和特殊处理。调用者本不应该把NULL值或者空字符串传递给getLastSubstrSplittedByDot()函数。如果传递了，那就是code bug，需要修复。但是，话说回来，谁也保证不了程序员就一定不会传递NULL值或者空字符串。那我们到底该不该做NULL值或空字符串的判断呢？</p>
<p>如果函数是private类私有的，只在类内部被调用，完全在你自己的掌控之下，自己保证在调用这个private函数的时候，不要传递NULL值或空字符串就可以了。所以，我们可以不在private函数中做NULL值或空字符串的判断。如果函数是public的，你无法掌控会被谁调用以及如何调用（有可能某个同事一时疏忽，传递进了NULL值，这种情况也是存在的），为了尽可能提高代码的健壮性，我们最好是在public函数中做NULL值或空字符串的判断。</p>
<p>那你可能会说，getLastSubstrSplittedByDot()是protected的，既不是private函数，也不是public函数，那要不要做NULL值或空字符串的判断呢？</p>
<p>之所以将它设置为protected，是为了方便写单元测试。不过，单元测试可能要测试一些corner case，比如输入是NULL值或者空字符串的情况。所以，这里我们最好也加上NULL值或空字符串的判断逻辑。虽然加上有些冗余，但多加些检验总归不会错的。</p>
<p>按照这个设计思路，我们对getLastSubstrSplittedByDot()函数进行重构。重构之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">getLastSubstrSplittedByDot</span><span style="color:#f92672">(</span>String hostName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hostName <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> hostName<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">throw</span> IllegalArgumentException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span> <span style="color:#75715e">//运行时异常
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
    String<span style="color:#f92672">[]</span> tokens <span style="color:#f92672">=</span> hostName<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\\.&#34;</span><span style="color:#f92672">);</span>
    String substrOfHostName <span style="color:#f92672">=</span> tokens<span style="color:#f92672">[</span>tokens<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
</code></pre></div><p>按照上面讲的，我们在使用这个函数的时候，自己也要保证不传递NULL值或者空字符串进去。所以，getLastFieldOfHostName()函数的代码也要作相应的修改。修改之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#66d9ef">private</span> String <span style="color:#a6e22e">getLastFieldOfHostName</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> UnknownHostException<span style="color:#f92672">{</span>
    String substrOfHostName <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    String hostName <span style="color:#f92672">=</span> InetAddress<span style="color:#f92672">.</span><span style="color:#a6e22e">getLocalHost</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getHostName</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hostName <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> hostName<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span> <span style="color:#75715e">// 此处做判断
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UnknownHostException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    substrOfHostName <span style="color:#f92672">=</span> getLastSubstrSplittedByDot<span style="color:#f92672">(</span>hostName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> substrOfHostName<span style="color:#f92672">;</span>
 <span style="color:#f92672">}</span>
</code></pre></div><h4 id="重构generaterandomalphameric函数">重构generateRandomAlphameric()函数</h4>
<p>对于generateRandomAlphameric(int length)函数，如果length &lt; 0或length = 0，这个函数应该返回什么？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> String <span style="color:#a6e22e">generateRandomAlphameric</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">char</span><span style="color:#f92672">[]</span> randomChars <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">[</span>length<span style="color:#f92672">];</span>
    <span style="color:#66d9ef">int</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    Random random <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Random<span style="color:#f92672">();</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">&lt;</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">int</span> maxAscii <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">int</span> randomAscii <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span><span style="color:#a6e22e">nextInt</span><span style="color:#f92672">(</span>maxAscii<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">boolean</span> isDigit<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;0&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;9&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">boolean</span> isUppercase<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;A&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;Z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">boolean</span> isLowercase<span style="color:#f92672">=</span> randomAscii <span style="color:#f92672">&gt;=</span> <span style="color:#e6db74">&#39;a&#39;</span> <span style="color:#f92672">&amp;&amp;</span> randomAscii <span style="color:#f92672">&lt;=</span> <span style="color:#e6db74">&#39;z&#39;</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isDigit<span style="color:#f92672">||</span> isUppercase <span style="color:#f92672">||</span> isLowercase<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        randomChars<span style="color:#f92672">[</span>count<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">char</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>randomAscii<span style="color:#f92672">);</span>
        <span style="color:#f92672">++</span>count<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> String<span style="color:#f92672">(</span>randomChars<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>我们先来看length &lt; 0的情况。生成一个长度为负值的随机字符串是不符合常规逻辑的，是一种异常行为。所以，当传入的参数length &lt; 0的时候，我们抛出IllegalArgumentException异常。</p>
<p>我们再来看length = 0的情况。length = 0是否是异常行为呢？这就看你自己怎么定义了。我们既可以把它定义为一种异常行为，抛出IllegalArgumentException异常，也可以把它定义为一种正常行为，让函数在入参length = 0的情况下，直接返回空字符串。不管选择哪种处理方式，最关键的一点是，要在函数注释中，明确告知length = 0的情况下，会返回什么样的数据。</p>
<h2 id="实战优化接口性能统计项目">实战：优化接口性能统计项目</h2>
<h3 id="回顾">回顾</h3>
<p>在之前的项目中，整个框架的代码被划分为下面这几个类。</p>
<ul>
<li>MetricsCollector：负责打点采集原始数据，包括记录每次接口请求的响应时间和请求时间戳，并调用MetricsStorage提供的接口来存储这些原始数据。</li>
<li>MetricsStorage和RedisMetricsStorage：负责原始数据的存储和读取。</li>
<li>Aggregator：是一个工具类，负责各种统计数据的计算，比如响应时间的最大值、最小值、平均值、百分位值、接口访问次数、tps。</li>
<li>ConsoleReporter和EmailReporter：相当于一个上帝类（God Class），定时根据给定的时间区间，从数据库中取出数据，借助Aggregator类完成统计工作，并将统计结果输出到相应的终端，比如命令行、邮件。</li>
</ul>
<p>Aggregator类里面只有一个静态函数，有50行左右的代码量，负责各种统计数据的计算。当要添加新的统计功能的时候，我们需要修改aggregate()函数代码。一旦越来越多的统计功能添加进来之后，这个函数的代码量会持续增加，可读性、可维护性就变差了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Aggregator</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> RequestStat <span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> requestInfos<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">double</span> maxRespTime <span style="color:#f92672">=</span> Double<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> minRespTime <span style="color:#f92672">=</span> Double<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> avgRespTime <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> p999RespTime <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> p99RespTime <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">double</span> sumRespTime <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">long</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>RequestInfo requestInfo <span style="color:#f92672">:</span> requestInfos<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#f92672">++</span>count<span style="color:#f92672">;</span>
      <span style="color:#66d9ef">double</span> respTime <span style="color:#f92672">=</span> requestInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>maxRespTime <span style="color:#f92672">&lt;</span> respTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        maxRespTime <span style="color:#f92672">=</span> respTime<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>minRespTime <span style="color:#f92672">&gt;</span> respTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        minRespTime <span style="color:#f92672">=</span> respTime<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      sumRespTime <span style="color:#f92672">+=</span> respTime<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      avgRespTime <span style="color:#f92672">=</span> sumRespTime <span style="color:#f92672">/</span> count<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">long</span> tps <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)(</span>count <span style="color:#f92672">/</span> durationInMillis <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
    Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">sort</span><span style="color:#f92672">(</span>requestInfos<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> Comparator<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">compare</span><span style="color:#f92672">(</span>RequestInfo o1<span style="color:#f92672">,</span> RequestInfo o2<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">double</span> diff <span style="color:#f92672">=</span> o1<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> o2<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>diff <span style="color:#f92672">&lt;</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>1<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>diff <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">return</span> 1<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
          <span style="color:#66d9ef">return</span> 0<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">});</span>
 
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">!=</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">int</span> idx999 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)(</span>count <span style="color:#f92672">*</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">999</span><span style="color:#f92672">);</span>
      <span style="color:#66d9ef">int</span> idx99 <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span><span style="color:#f92672">)(</span>count <span style="color:#f92672">*</span> 0<span style="color:#f92672">.</span><span style="color:#a6e22e">99</span><span style="color:#f92672">);</span>
      p999RespTime <span style="color:#f92672">=</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>idx999<span style="color:#f92672">).</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
      p99RespTime <span style="color:#f92672">=</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>idx99<span style="color:#f92672">).</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    RequestStat requestStat <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RequestStat<span style="color:#f92672">();</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxResponseTime</span><span style="color:#f92672">(</span>maxRespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setMinResponseTime</span><span style="color:#f92672">(</span>minRespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setAvgResponseTime</span><span style="color:#f92672">(</span>avgRespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setP999ResponseTime</span><span style="color:#f92672">(</span>p999RespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setP99ResponseTime</span><span style="color:#f92672">(</span>p99RespTime<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setCount</span><span style="color:#f92672">(</span>count<span style="color:#f92672">);</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setTps</span><span style="color:#f92672">(</span>tps<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> requestStat<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RequestStat</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> maxResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> minResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> avgResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> p999ResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> p99ResponseTime<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> count<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> tps<span style="color:#f92672">;</span>
  <span style="color:#75715e">//...省略getter/setter方法...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p><strong>我们再来看一下ConsoleReporter和EmailReporter这两个类存在的问题。</strong></p>
<p>ConsoleReporter和EmailReporter两个类中存在代码重复问题。在这两个类中，从数据库中取数据、做统计的逻辑都是相同的，可以抽取出来复用，否则就违反了DRY原则。</p>
<p>整个类负责的事情比较多，不相干的逻辑糅合在里面，职责不够单一。特别是显示部分的代码可能会比较复杂（比如Email的显示方式），最好能将这部分显示逻辑剥离出来，设计成一个独立的类。</p>
<p>除此之外，因为代码中涉及线程操作，并且调用了Aggregator的静态函数，所以代码的可测试性也有待提高。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsoleReporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> ScheduledExecutorService executor<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConsoleReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executor</span> <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newSingleThreadScheduledExecutor</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> periodInSeconds<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationInSeconds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    executor<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> durationInSeconds <span style="color:#f92672">*</span> 1000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> endTimeInMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> startTimeInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span> durationInMillis<span style="color:#f92672">;</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos <span style="color:#f92672">=</span>
                metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> entry <span style="color:#f92672">:</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
          String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
          List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> requestInfosPerApi <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
          RequestStat requestStat <span style="color:#f92672">=</span> Aggregator<span style="color:#f92672">.</span><span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>requestInfosPerApi<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> requestStat<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Time Span: [&#34;</span> <span style="color:#f92672">+</span> startTimeInMillis <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, &#34;</span> <span style="color:#f92672">+</span> endTimeInMillis <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]&#34;</span><span style="color:#f92672">);</span>
        Gson gson <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Gson<span style="color:#f92672">();</span>
        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>gson<span style="color:#f92672">.</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span>stats<span style="color:#f92672">));</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> 0<span style="color:#f92672">,</span> periodInSeconds<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailReporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Long DAY_HOURS_IN_SECONDS <span style="color:#f92672">=</span> 86400L<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> EmailSender emailSender<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> toAddresses <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>metricsStorage<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> EmailSender<span style="color:#f92672">(</span><span style="color:#75715e">/*省略参数*/</span><span style="color:#f92672">));</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> EmailSender emailSender<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">emailSender</span> <span style="color:#f92672">=</span> emailSender<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addToAddress</span><span style="color:#f92672">(</span>String address<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    toAddresses<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>address<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Calendar calendar <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DATE</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">HOUR_OF_DAY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">SECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    Date firstTime <span style="color:#f92672">=</span> calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getTime</span><span style="color:#f92672">();</span> 
    Timer timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timer<span style="color:#f92672">();</span>
    timer<span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TimerTask<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> endTimeInMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> startTimeInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span> durationInMillis<span style="color:#f92672">;</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos <span style="color:#f92672">=</span>
                metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> entry <span style="color:#f92672">:</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
          String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
          List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> requestInfosPerApi <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
          RequestStat requestStat <span style="color:#f92672">=</span> Aggregator<span style="color:#f92672">.</span><span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>requestInfosPerApi<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
          stats<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> requestStat<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        <span style="color:#75715e">// TODO: 格式化为html格式，并且发送邮件
</span><span style="color:#75715e"></span>      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> firstTime<span style="color:#f92672">,</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="重构一">重构一</h3>
<p>Aggregator类和ConsoleReporter、EmailReporter类主要负责统计显示的工作。在第26节中，我们提到，如果我们把统计显示所要完成的功能逻辑细分一下，主要包含下面4点：</p>
<ol>
<li>根据给定的时间区间，从数据库中拉取数据；</li>
<li>根据原始数据，计算得到统计数据；</li>
<li>将统计数据显示到终端（命令行或邮件）；</li>
<li>定时触发以上三个过程的执行。</li>
</ol>
<p>之前的划分方法是将所有的逻辑都放到ConsoleReporter和EmailReporter这两个上帝类中，而Aggregator只是一个包含静态方法的工具类。这样的划分方法存在前面提到的一些问题，我们需要对其进行重新划分。</p>
<p>面向对象设计中的最后一步是组装类并提供执行入口，所以，组装前三部分逻辑的上帝类是必须要有的。我们可以将上帝类做的很轻量级，把核心逻辑都剥离出去，形成独立的类，上帝类只负责组装类和串联执行流程。这样做的好处是，代码结构更加清晰，底层核心逻辑更容易被复用。按照这个设计思路，具体的重构工作包含以下4个方面。</p>
<ul>
<li>第1个逻辑：根据给定时间区间，从数据库中拉取数据。这部分逻辑已经被封装在MetricsStorage类中了，所以这部分不需要处理。</li>
<li>第2个逻辑：根据原始数据，计算得到统计数据。我们可以将这部分逻辑移动到Aggregator类中。这样Aggregator类就不仅仅是只包含统计方法的工具类了。按照这个思路，重构之后的代码如下所示：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Aggregator</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>
          Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> requestStats <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> entry <span style="color:#f92672">:</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
      List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> requestInfosPerApi <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
      RequestStat requestStat <span style="color:#f92672">=</span> doAggregate<span style="color:#f92672">(</span>requestInfosPerApi<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
      requestStats<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> requestStat<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> requestStats<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> RequestStat <span style="color:#a6e22e">doAggregate</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;</span> requestInfos<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> respTimes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>RequestInfo requestInfo <span style="color:#f92672">:</span> requestInfos<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">double</span> respTime <span style="color:#f92672">=</span> requestInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getResponseTime</span><span style="color:#f92672">();</span>
      respTimes<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>respTime<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    RequestStat requestStat <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RequestStat<span style="color:#f92672">();</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxResponseTime</span><span style="color:#f92672">(</span>max<span style="color:#f92672">(</span>respTimes<span style="color:#f92672">));</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setMinResponseTime</span><span style="color:#f92672">(</span>min<span style="color:#f92672">(</span>respTimes<span style="color:#f92672">));</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setAvgResponseTime</span><span style="color:#f92672">(</span>avg<span style="color:#f92672">(</span>respTimes<span style="color:#f92672">));</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setP999ResponseTime</span><span style="color:#f92672">(</span>percentile999<span style="color:#f92672">(</span>respTimes<span style="color:#f92672">));</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setP99ResponseTime</span><span style="color:#f92672">(</span>percentile99<span style="color:#f92672">(</span>respTimes<span style="color:#f92672">));</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setCount</span><span style="color:#f92672">(</span>respTimes<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
    requestStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setTps</span><span style="color:#f92672">((</span><span style="color:#66d9ef">long</span><span style="color:#f92672">)</span> tps<span style="color:#f92672">(</span>respTimes<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(),</span> durationInMillis<span style="color:#f92672">/</span>1000<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">return</span> requestStat<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#75715e">// 以下的函数的代码实现均省略...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">max</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> dataset<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">min</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> dataset<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">avg</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> dataset<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">tps</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> count<span style="color:#f92672">,</span> <span style="color:#66d9ef">double</span> duration<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">percentile999</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> dataset<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">percentile99</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> dataset<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">percentile</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>Double<span style="color:#f92672">&gt;</span> dataset<span style="color:#f92672">,</span> <span style="color:#66d9ef">double</span> ratio<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>第3个逻辑：将统计数据显示到终端。我们将这部分逻辑剥离出来，设计成两个类：ConsoleViewer类和EmailViewer类，分别负责将统计结果显示到命令行和邮件中。具体的代码实现如下所示：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">StatViewer</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">output</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> requestStats<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> startTimeInMillis<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimeInMills<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsoleViewer</span> <span style="color:#66d9ef">implements</span> StatViewer <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">output</span><span style="color:#f92672">(</span>
          Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> requestStats<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> startTimeInMillis<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimeInMills<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Time Span: [&#34;</span> <span style="color:#f92672">+</span> startTimeInMillis <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, &#34;</span> <span style="color:#f92672">+</span> endTimeInMills <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;]&#34;</span><span style="color:#f92672">);</span>
    Gson gson <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Gson<span style="color:#f92672">();</span>
    System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>gson<span style="color:#f92672">.</span><span style="color:#a6e22e">toJson</span><span style="color:#f92672">(</span>requestStats<span style="color:#f92672">));</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailViewer</span> <span style="color:#66d9ef">implements</span> StatViewer <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> EmailSender emailSender<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> toAddresses <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailViewer</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">emailSender</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EmailSender<span style="color:#f92672">(</span><span style="color:#75715e">/*省略参数*/</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailViewer</span><span style="color:#f92672">(</span>EmailSender emailSender<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">emailSender</span> <span style="color:#f92672">=</span> emailSender<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addToAddress</span><span style="color:#f92672">(</span>String address<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    toAddresses<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>address<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">output</span><span style="color:#f92672">(</span>
          Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> requestStats<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> startTimeInMillis<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimeInMills<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// format the requestStats to HTML style.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// send it to email toAddresses.
</span><span style="color:#75715e"></span>  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li>第4个逻辑：组装类并定时触发执行统计显示。在将核心逻辑剥离出来之后，这个类的代码变得更加简洁、清晰，只负责组装各个类（MetricsStorage、Aggegrator、StatViewer）来完成整个工作流程。重构之后的代码如下所示：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsoleReporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Aggregator aggregator<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> StatViewer viewer<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> ScheduledExecutorService executor<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConsoleReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> Aggregator aggregator<span style="color:#f92672">,</span> StatViewer viewer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aggregator</span> <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">viewer</span> <span style="color:#f92672">=</span> viewer<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executor</span> <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newSingleThreadScheduledExecutor</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> periodInSeconds<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> durationInSeconds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    executor<span style="color:#f92672">.</span><span style="color:#a6e22e">scheduleAtFixedRate</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Runnable<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> durationInSeconds <span style="color:#f92672">*</span> 1000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> endTimeInMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> startTimeInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span> durationInMillis<span style="color:#f92672">;</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos <span style="color:#f92672">=</span>
                metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> requestStats <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">.</span><span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>requestInfos<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
        viewer<span style="color:#f92672">.</span><span style="color:#a6e22e">output</span><span style="color:#f92672">(</span>requestStats<span style="color:#f92672">,</span> startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> 0L<span style="color:#f92672">,</span> periodInSeconds<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailReporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Long DAY_HOURS_IN_SECONDS <span style="color:#f92672">=</span> 86400L<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Aggregator aggregator<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> StatViewer viewer<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> Aggregator aggregator<span style="color:#f92672">,</span> StatViewer viewer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aggregator</span> <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">viewer</span> <span style="color:#f92672">=</span> viewer<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Calendar calendar <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DATE</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">HOUR_OF_DAY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">SECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    Date firstTime <span style="color:#f92672">=</span> calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getTime</span><span style="color:#f92672">();</span>
    Timer timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timer<span style="color:#f92672">();</span>
    timer<span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TimerTask<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> endTimeInMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> startTimeInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span> durationInMillis<span style="color:#f92672">;</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos <span style="color:#f92672">=</span>
                metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">.</span><span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>requestInfos<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
        viewer<span style="color:#f92672">.</span><span style="color:#a6e22e">output</span><span style="color:#f92672">(</span>stats<span style="color:#f92672">,</span> startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> firstTime<span style="color:#f92672">,</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span> 
</code></pre></div><p>经过上面的重构之后，我们现在再来看一下，现在框架该如何来使用。</p>
<p>我们需要在应用启动的时候，创建好ConsoleReporter对象，并且调用它的startRepeatedReport()函数，来启动定时统计并输出数据到终端。同理，我们还需要创建好EmailReporter对象，并且调用它的startDailyReport()函数，来启动每日统计并输出数据到制定邮件地址。我们通过MetricsCollector类来收集接口的访问情况，这部分收集代码会跟业务逻辑代码耦合在一起，或者统一放到类似Spring AOP的切面中完成。具体的使用代码示例如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PerfCounterTest</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    MetricsStorage storage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RedisMetricsStorage<span style="color:#f92672">();</span>
    Aggregator aggregator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Aggregator<span style="color:#f92672">();</span>

    <span style="color:#75715e">// 定时触发统计并将结果显示到终端
</span><span style="color:#75715e"></span>    ConsoleViewer consoleViewer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsoleViewer<span style="color:#f92672">();</span>
    ConsoleReporter consoleReporter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsoleReporter<span style="color:#f92672">(</span>storage<span style="color:#f92672">,</span> aggregator<span style="color:#f92672">,</span> consoleViewer<span style="color:#f92672">);</span>
    consoleReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span>60<span style="color:#f92672">,</span> 60<span style="color:#f92672">);</span>

    <span style="color:#75715e">// 定时触发统计并将结果输出到邮件
</span><span style="color:#75715e"></span>    EmailViewer emailViewer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EmailViewer<span style="color:#f92672">();</span>
    emailViewer<span style="color:#f92672">.</span><span style="color:#a6e22e">addToAddress</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wangzheng@xzg.com&#34;</span><span style="color:#f92672">);</span>
    EmailReporter emailReporter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EmailReporter<span style="color:#f92672">(</span>storage<span style="color:#f92672">,</span> aggregator<span style="color:#f92672">,</span> emailViewer<span style="color:#f92672">);</span>
    emailReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">();</span>

    <span style="color:#75715e">// 收集接口访问数据
</span><span style="color:#75715e"></span>    MetricsCollector collector <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MetricsCollector<span style="color:#f92672">(</span>storage<span style="color:#f92672">);</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 123<span style="color:#f92672">,</span> 10234<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 223<span style="color:#f92672">,</span> 11234<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 323<span style="color:#f92672">,</span> 12334<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> 23<span style="color:#f92672">,</span> 12434<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> 1223<span style="color:#f92672">,</span> 14234<span style="color:#f92672">));</span>

    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>100000<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="重构二">重构二</h3>
<p>我们知道，继承能解决代码重复的问题。我们可以将ConsoleReporter和EmailReporter中的相同代码逻辑，提取到父类ScheduledReporter中，以解决代码重复问题。按照这个思路，重构之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduledReporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">protected</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">protected</span> Aggregator aggregator<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">protected</span> StatViewer viewer<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ScheduledReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> Aggregator aggregator<span style="color:#f92672">,</span> StatViewer viewer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aggregator</span> <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">viewer</span> <span style="color:#f92672">=</span> viewer<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doStatAndReport</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> startTimeInMillis<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimeInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span>  startTimeInMillis<span style="color:#f92672">;</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos <span style="color:#f92672">=</span>
            metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> requestStats <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">.</span><span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>requestInfos<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
    viewer<span style="color:#f92672">.</span><span style="color:#a6e22e">output</span><span style="color:#f92672">(</span>requestStats<span style="color:#f92672">,</span> startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ConsoleReporter和EmailReporter代码重复的问题解决了，那我们再来看一下代码的可测试性问题。因为ConsoleReporter和EmailReporter的代码比较相似，且EmailReporter的代码更复杂些，所以，关于如何重构来提高其可测试性，我们拿EmailReporter来举例说明。将重复代码提取到父类ScheduledReporter之后，EmailReporter代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailReporter</span> <span style="color:#66d9ef">extends</span> ScheduledReporter <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Long DAY_HOURS_IN_SECONDS <span style="color:#f92672">=</span> 86400L<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> Aggregator aggregator<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> StatViewer viewer<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> Aggregator aggregator<span style="color:#f92672">,</span> StatViewer viewer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aggregator</span> <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">viewer</span> <span style="color:#f92672">=</span> viewer<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Calendar calendar <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DATE</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">HOUR_OF_DAY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">SECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    Date firstTime <span style="color:#f92672">=</span> calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getTime</span><span style="color:#f92672">();</span>

    Timer timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timer<span style="color:#f92672">();</span>
    timer<span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TimerTask<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">long</span> endTimeInMillis <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">long</span> startTimeInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span> durationInMillis<span style="color:#f92672">;</span>
        doStatAndReport<span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> firstTime<span style="color:#f92672">,</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>前面提到，之所以EmailReporter可测试性不好，一方面是因为用到了线程（定时器也相当于多线程），另一方面是因为涉及时间的计算逻辑。</p>
<p>实际上，在经过上一步的重构之后，EmailReporter中的startDailyReport()函数的核心逻辑已经被抽离出去了，较复杂的、容易出bug的就只剩下计算firstTime的那部分代码了。我们可以将这部分代码继续抽离出来，封装成一个函数，然后，单独针对这个函数写单元测试。重构之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailReporter</span> <span style="color:#66d9ef">extends</span> ScheduledReporter <span style="color:#f92672">{</span>
  <span style="color:#75715e">// 省略其他代码...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Date firstTime <span style="color:#f92672">=</span> trimTimeFieldsToZeroOfNextDay<span style="color:#f92672">();</span>
    Timer timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timer<span style="color:#f92672">();</span>
    timer<span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TimerTask<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 省略其他代码...
</span><span style="color:#75715e"></span>      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> firstTime<span style="color:#f92672">,</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#75715e">// 设置成protected而非private是为了方便写单元测试
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">@VisibleForTesting</span>
  <span style="color:#66d9ef">protected</span> Date <span style="color:#a6e22e">trimTimeFieldsToZeroOfNextDay</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    Calendar calendar <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span> <span style="color:#75715e">// 这里可以获取当前时间
</span><span style="color:#75715e"></span>    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DATE</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">HOUR_OF_DAY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">SECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getTime</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>简单的代码抽离成trimTimeFieldsToZeroOfNextDay()函数之后，虽然代码更加清晰了，一眼就能从名字上知道这段代码的意图（获取当前时间的下一天的0点时间），但我们发现这个函数的可测试性仍然不好，因为它强依赖当前的系统时间。实际上，这个问题挺普遍的。一般的解决方法是，将强依赖的部分通过参数传递进来，这有点类似我们之前讲的依赖注入。按照这个思路，我们再对trimTimeFieldsToZeroOfNextDay()函数进行重构。重构之后的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailReporter</span> <span style="color:#66d9ef">extends</span> ScheduledReporter <span style="color:#f92672">{</span>
  <span style="color:#75715e">// 省略其他代码...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// new Date()可以获取当前时间
</span><span style="color:#75715e"></span>    Date firstTime <span style="color:#f92672">=</span> trimTimeFieldsToZeroOfNextDay<span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> Date<span style="color:#f92672">());</span>
    Timer timer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Timer<span style="color:#f92672">();</span>
    timer<span style="color:#f92672">.</span><span style="color:#a6e22e">schedule</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> TimerTask<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
      <span style="color:#a6e22e">@Override</span>
      <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">// 省略其他代码...
</span><span style="color:#75715e"></span>      <span style="color:#f92672">}</span>
    <span style="color:#f92672">},</span> firstTime<span style="color:#f92672">,</span> DAY_HOURS_IN_SECONDS <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">protected</span> Date <span style="color:#a6e22e">trimTimeFieldsToZeroOfNextDay</span><span style="color:#f92672">(</span>Date date<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Calendar calendar <span style="color:#f92672">=</span> Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">();</span> <span style="color:#75715e">// 这里可以获取当前时间
</span><span style="color:#75715e"></span>    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">setTime</span><span style="color:#f92672">(</span>date<span style="color:#f92672">);</span> <span style="color:#75715e">// 重新设置时间
</span><span style="color:#75715e"></span>    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">DATE</span><span style="color:#f92672">,</span> 1<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">HOUR_OF_DAY</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MINUTE</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">SECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>Calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">MILLISECOND</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> calendar<span style="color:#f92672">.</span><span style="color:#a6e22e">getTime</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="非功能需求完善">非功能需求完善</h3>
<h4 id="易用性">易用性</h4>
<p>所谓的易用性，顾名思义，就是框架是否好用。框架的使用者将框架集成到自己的系统中时，主要用到MetricsCollector和EmailReporter、ConsoleReporter这几个类。通过MetricsCollector类来采集数据，通过EmailReporter、ConsoleReporter类来触发主动统计数据、显示统计结果。示例代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PerfCounterTest</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    MetricsStorage storage <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RedisMetricsStorage<span style="color:#f92672">();</span>
    Aggregator aggregator <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Aggregator<span style="color:#f92672">();</span>

    <span style="color:#75715e">// 定时触发统计并将结果显示到终端
</span><span style="color:#75715e"></span>    ConsoleViewer consoleViewer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsoleViewer<span style="color:#f92672">();</span>
    ConsoleReporter consoleReporter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsoleReporter<span style="color:#f92672">(</span>storage<span style="color:#f92672">,</span> aggregator<span style="color:#f92672">,</span> consoleViewer<span style="color:#f92672">);</span>
    consoleReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span>60<span style="color:#f92672">,</span> 60<span style="color:#f92672">);</span>
    
    <span style="color:#75715e">// 定时触发统计并将结果输出到邮件
</span><span style="color:#75715e"></span>    EmailViewer emailViewer <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EmailViewer<span style="color:#f92672">();</span>
    emailViewer<span style="color:#f92672">.</span><span style="color:#a6e22e">addToAddress</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wangzheng@xzg.com&#34;</span><span style="color:#f92672">);</span>
    EmailReporter emailReporter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EmailReporter<span style="color:#f92672">(</span>storage<span style="color:#f92672">,</span> aggregator<span style="color:#f92672">,</span> emailViewer<span style="color:#f92672">);</span>
    emailReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">();</span>

    <span style="color:#75715e">// 收集接口访问数据
</span><span style="color:#75715e"></span>    MetricsCollector collector <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MetricsCollector<span style="color:#f92672">(</span>storage<span style="color:#f92672">);</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 123<span style="color:#f92672">,</span> 10234<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 223<span style="color:#f92672">,</span> 11234<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 323<span style="color:#f92672">,</span> 12334<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> 23<span style="color:#f92672">,</span> 12434<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> 1223<span style="color:#f92672">,</span> 14234<span style="color:#f92672">));</span>

    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>100000<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>从上面的使用示例中，我们可以看出，框架用起来还是稍微有些复杂的，需要组装各种类，比如需要创建MetricsStorage对象、Aggregator对象、ConsoleViewer对象，然后注入到ConsoleReporter中，才能使用ConsoleReporter。除此之外，还有可能存在误用的情况，比如把EmailViewer传递进了ConsoleReporter中。总体上来讲，框架的使用方式暴露了太多细节给用户，过于灵活也带来了易用性的降低。</p>
<p>为了让框架用起来更加简单（能将组装的细节封装在框架中，不暴露给框架使用者），又不失灵活性（可以自由组装不同的MetricsStorage实现类、StatViewer实现类到ConsoleReporter或EmailReporter），也不降低代码的可测试性（通过依赖注入来组装类，方便在单元测试中mock），我们可以额外地提供一些封装了默认依赖的构造函数，让使用者自主选择使用哪种构造函数来构造对象。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MetricsCollector</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>

  <span style="color:#75715e">// 兼顾代码的易用性，新增一个封装了默认依赖的构造函数
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MetricsCollectorB</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RedisMetricsStorage<span style="color:#f92672">());</span>
  <span style="color:#f92672">}</span>

  <span style="color:#75715e">// 兼顾灵活性和代码的可测试性，这个构造函数继续保留
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MetricsCollectorB</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">// 省略其他代码...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConsoleReporter</span> <span style="color:#66d9ef">extends</span> ScheduledReporter <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> ScheduledExecutorService executor<span style="color:#f92672">;</span>
  
  <span style="color:#75715e">// 兼顾代码的易用性，新增一个封装了默认依赖的构造函数
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConsoleReporter</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RedisMetricsStorage<span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> Aggregator<span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> ConsoleViewer<span style="color:#f92672">());</span>
  <span style="color:#f92672">}</span>

  <span style="color:#75715e">// 兼顾灵活性和代码的可测试性，这个构造函数继续保留
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ConsoleReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> Aggregator aggregator<span style="color:#f92672">,</span> StatViewer viewer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>metricsStorage<span style="color:#f92672">,</span> aggregator<span style="color:#f92672">,</span> viewer<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">executor</span> <span style="color:#f92672">=</span> Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newSingleThreadScheduledExecutor</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">// 省略其他代码...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EmailReporter</span> <span style="color:#66d9ef">extends</span> ScheduledReporter <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Long DAY_HOURS_IN_SECONDS <span style="color:#f92672">=</span> 86400L<span style="color:#f92672">;</span>

  <span style="color:#75715e">// 兼顾代码的易用性，新增一个封装了默认依赖的构造函数
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailReporter</span><span style="color:#f92672">(</span>List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> emailToAddresses<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RedisMetricsStorage<span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> Aggregator<span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> EmailViewer<span style="color:#f92672">(</span>emailToAddresses<span style="color:#f92672">));</span>
  <span style="color:#f92672">}</span>
  
  <span style="color:#75715e">// 兼顾灵活性和代码的可测试性，这个构造函数继续保留
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">EmailReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> Aggregator aggregator<span style="color:#f92672">,</span> StatViewer viewer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span>metricsStorage<span style="color:#f92672">,</span> aggregator<span style="color:#f92672">,</span> viewer<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
  <span style="color:#75715e">// 省略其他代码...
</span><span style="color:#75715e"></span><span style="color:#f92672">}</span>
</code></pre></div><p>现在，我们再来看下框架如何来使用。具体使用示例如下所示。看起来是不是简单多了呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PerfCounterTest</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    ConsoleReporter consoleReporter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsoleReporter<span style="color:#f92672">();</span>
    consoleReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">startRepeatedReport</span><span style="color:#f92672">(</span>60<span style="color:#f92672">,</span> 60<span style="color:#f92672">);</span>

    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> emailToAddresses <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
    emailToAddresses<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;wangzheng@xzg.com&#34;</span><span style="color:#f92672">);</span>
    EmailReporter emailReporter <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> EmailReporter<span style="color:#f92672">(</span>emailToAddresses<span style="color:#f92672">);</span>
    emailReporter<span style="color:#f92672">.</span><span style="color:#a6e22e">startDailyReport</span><span style="color:#f92672">();</span>

    MetricsCollector collector <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MetricsCollector<span style="color:#f92672">();</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 123<span style="color:#f92672">,</span> 10234<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 223<span style="color:#f92672">,</span> 11234<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;register&#34;</span><span style="color:#f92672">,</span> 323<span style="color:#f92672">,</span> 12334<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> 23<span style="color:#f92672">,</span> 12434<span style="color:#f92672">));</span>
    collector<span style="color:#f92672">.</span><span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> RequestInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;login&#34;</span><span style="color:#f92672">,</span> 1223<span style="color:#f92672">,</span> 14234<span style="color:#f92672">));</span>

    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>100000<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="性能">性能</h4>
<p>对于需要集成到业务系统的框架来说，我们不希望框架本身代码的执行效率，对业务系统有太多性能上的影响。对于性能计数器这个框架来说，一方面，我们希望它是低延迟的，也就是说，统计代码不影响或很少影响接口本身的响应时间；另一方面，我们希望框架本身对内存的消耗不能太大。</p>
<p>对于性能这一点，落实到具体的代码层面，需要解决两个问题，也是我们之前提到过的，一个是采集和存储要异步来执行，因为存储基于外部存储（比如Redis），会比较慢，异步存储可以降低对接口响应时间的影响。另一个是当需要聚合统计的数据量比较大的时候，一次性加载太多的数据到内存，有可能会导致内存吃紧，甚至内存溢出，这样整个系统都会瘫痪掉。</p>
<p>针对第一个问题，我们通过在MetricsCollector中引入Google Guava EventBus来解决。实际上，我们可以把EventBus看作一个“生产者-消费者”模型或者“发布-订阅”模型，采集的数据先放入内存共享队列中，另一个线程读取共享队列中的数据，写入到外部存储（比如Redis）中。具体的代码实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MetricsCollector</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_STORAGE_THREAD_POOL_SIZE <span style="color:#f92672">=</span> 20<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">private</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">private</span> EventBus eventBus<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MetricsCollector</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">(</span>metricsStorage<span style="color:#f92672">,</span> DEFAULT_STORAGE_THREAD_POOL_SIZE<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MetricsCollector</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> threadNumToSaveData<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">eventBus</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> AsyncEventBus<span style="color:#f92672">(</span>Executors<span style="color:#f92672">.</span><span style="color:#a6e22e">newFixedThreadPool</span><span style="color:#f92672">(</span>threadNumToSaveData<span style="color:#f92672">));</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">eventBus</span><span style="color:#f92672">.</span><span style="color:#a6e22e">register</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> EventListener<span style="color:#f92672">());</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">recordRequest</span><span style="color:#f92672">(</span>RequestInfo requestInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestInfo <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> StringUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">isBlank</span><span style="color:#f92672">(</span>requestInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getApiName</span><span style="color:#f92672">()))</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
    eventBus<span style="color:#f92672">.</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span>requestInfo<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">EventListener</span> <span style="color:#f92672">{</span>
    <span style="color:#a6e22e">@Subscribe</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">saveRequestInfo</span><span style="color:#f92672">(</span>RequestInfo requestInfo<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">saveRequestInfo</span><span style="color:#f92672">(</span>requestInfo<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>针对第二个问题，解决的思路比较简单，但代码实现稍微有点复杂。当统计的时间间隔较大的时候，需要统计的数据量就会比较大。我们可以将其划分为一些小的时间区间（比如10分钟作为一个统计单元），针对每个小的时间区间分别进行统计，然后将统计得到的结果再进行聚合，得到最终整个时间区间的统计结果。不过，这个思路只适合响应时间的max、min、avg，及其接口请求count、tps的统计，对于响应时间的percentile的统计并不适用。</p>
<p>对于percentile的统计要稍微复杂一些，具体的解决思路是这样子的：我们分批从Redis中读取数据，然后存储到文件中，再根据响应时间从小到大利用外部排序算法来进行排序（具体的实现方式可以看一下《数据结构与算法之美》专栏）。排序完成之后，再从文件中读取第count*percentile（count表示总的数据个数，percentile就是百分比，99百分位就是0.99）个数据，就是对应的percentile响应时间。</p>
<p>这里给出了除了percentile之外的统计信息的计算代码，如下所示。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ScheduleReporter</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> MAX_STAT_DURATION_IN_MILLIS <span style="color:#f92672">=</span> 10 <span style="color:#f92672">*</span> 60 <span style="color:#f92672">*</span> 1000<span style="color:#f92672">;</span> <span style="color:#75715e">// 10minutes
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">protected</span> MetricsStorage metricsStorage<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">protected</span> Aggregator aggregator<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">protected</span> StatViewer viewer<span style="color:#f92672">;</span>

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ScheduleReporter</span><span style="color:#f92672">(</span>MetricsStorage metricsStorage<span style="color:#f92672">,</span> Aggregator aggregator<span style="color:#f92672">,</span> StatViewer viewer<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">metricsStorage</span> <span style="color:#f92672">=</span> metricsStorage<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">aggregator</span> <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">viewer</span> <span style="color:#f92672">=</span> viewer<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doStatAndReport</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> startTimeInMillis<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimeInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> stats <span style="color:#f92672">=</span> doStat<span style="color:#f92672">(</span>startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
    viewer<span style="color:#f92672">.</span><span style="color:#a6e22e">output</span><span style="color:#f92672">(</span>stats<span style="color:#f92672">,</span> startTimeInMillis<span style="color:#f92672">,</span> endTimeInMillis<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">doStat</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> startTimeInMillis<span style="color:#f92672">,</span> <span style="color:#66d9ef">long</span> endTimeInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestStat<span style="color:#f92672">&gt;&gt;</span> segmentStats <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
    <span style="color:#66d9ef">long</span> segmentStartTimeMillis <span style="color:#f92672">=</span> startTimeInMillis<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>segmentStartTimeMillis <span style="color:#f92672">&lt;</span> endTimeInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">long</span> segmentEndTimeMillis <span style="color:#f92672">=</span> segmentStartTimeMillis <span style="color:#f92672">+</span> MAX_STAT_DURATION_IN_MILLIS<span style="color:#f92672">;</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>segmentEndTimeMillis <span style="color:#f92672">&gt;</span> endTimeInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        segmentEndTimeMillis <span style="color:#f92672">=</span> endTimeInMillis<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestInfo<span style="color:#f92672">&gt;&gt;</span> requestInfos <span style="color:#f92672">=</span>
              metricsStorage<span style="color:#f92672">.</span><span style="color:#a6e22e">getRequestInfos</span><span style="color:#f92672">(</span>segmentStartTimeMillis<span style="color:#f92672">,</span> segmentEndTimeMillis<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>requestInfos <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> requestInfos<span style="color:#f92672">.</span><span style="color:#a6e22e">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> segmentStat <span style="color:#f92672">=</span> aggregator<span style="color:#f92672">.</span><span style="color:#a6e22e">aggregate</span><span style="color:#f92672">(</span>
              requestInfos<span style="color:#f92672">,</span> segmentEndTimeMillis <span style="color:#f92672">-</span> segmentStartTimeMillis<span style="color:#f92672">);</span>
      addStat<span style="color:#f92672">(</span>segmentStats<span style="color:#f92672">,</span> segmentStat<span style="color:#f92672">);</span>
      segmentStartTimeMillis <span style="color:#f92672">+=</span> MAX_STAT_DURATION_IN_MILLIS<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">long</span> durationInMillis <span style="color:#f92672">=</span> endTimeInMillis <span style="color:#f92672">-</span> startTimeInMillis<span style="color:#f92672">;</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> aggregatedStats <span style="color:#f92672">=</span> aggregateStats<span style="color:#f92672">(</span>segmentStats<span style="color:#f92672">,</span> durationInMillis<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> aggregatedStats<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addStat</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestStat<span style="color:#f92672">&gt;&gt;</span> segmentStats<span style="color:#f92672">,</span>
                       Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> segmentStat<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> entry <span style="color:#f92672">:</span> segmentStat<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
      RequestStat stat <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
      List<span style="color:#f92672">&lt;</span>RequestStat<span style="color:#f92672">&gt;</span> statList <span style="color:#f92672">=</span> segmentStats<span style="color:#f92672">.</span><span style="color:#a6e22e">putIfAbsent</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;());</span>
      statList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>stat<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">private</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">aggregateStats</span><span style="color:#f92672">(</span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestStat<span style="color:#f92672">&gt;&gt;</span> segmentStats<span style="color:#f92672">,</span>
                                                  <span style="color:#66d9ef">long</span> durationInMillis<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> RequestStat<span style="color:#f92672">&gt;</span> aggregatedStats <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>RequestStat<span style="color:#f92672">&gt;&gt;</span> entry <span style="color:#f92672">:</span> segmentStats<span style="color:#f92672">.</span><span style="color:#a6e22e">entrySet</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      String apiName <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getKey</span><span style="color:#f92672">();</span>
      List<span style="color:#f92672">&lt;</span>RequestStat<span style="color:#f92672">&gt;</span> apiStats <span style="color:#f92672">=</span> entry<span style="color:#f92672">.</span><span style="color:#a6e22e">getValue</span><span style="color:#f92672">();</span>
      <span style="color:#66d9ef">double</span> maxRespTime <span style="color:#f92672">=</span> Double<span style="color:#f92672">.</span><span style="color:#a6e22e">MIN_VALUE</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">double</span> minRespTime <span style="color:#f92672">=</span> Double<span style="color:#f92672">.</span><span style="color:#a6e22e">MAX_VALUE</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">long</span> count <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
      <span style="color:#66d9ef">double</span> sumRespTime <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
      <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>RequestStat stat <span style="color:#f92672">:</span> apiStats<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stat<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxResponseTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> maxRespTime<span style="color:#f92672">)</span> maxRespTime <span style="color:#f92672">=</span> stat<span style="color:#f92672">.</span><span style="color:#a6e22e">getMaxResponseTime</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>stat<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinResponseTime</span><span style="color:#f92672">()</span> <span style="color:#f92672">&lt;</span> minRespTime<span style="color:#f92672">)</span> minRespTime <span style="color:#f92672">=</span> stat<span style="color:#f92672">.</span><span style="color:#a6e22e">getMinResponseTime</span><span style="color:#f92672">();</span>
        count <span style="color:#f92672">+=</span> stat<span style="color:#f92672">.</span><span style="color:#a6e22e">getCount</span><span style="color:#f92672">();</span>
        sumRespTime <span style="color:#f92672">+=</span> <span style="color:#f92672">(</span>stat<span style="color:#f92672">.</span><span style="color:#a6e22e">getCount</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> stat<span style="color:#f92672">.</span><span style="color:#a6e22e">getAvgResponseTime</span><span style="color:#f92672">());</span>
      <span style="color:#f92672">}</span>
      RequestStat aggregatedStat <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> RequestStat<span style="color:#f92672">();</span>
      aggregatedStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxResponseTime</span><span style="color:#f92672">(</span>maxRespTime<span style="color:#f92672">);</span>
      aggregatedStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setMinResponseTime</span><span style="color:#f92672">(</span>minRespTime<span style="color:#f92672">);</span>
      aggregatedStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setAvgResponseTime</span><span style="color:#f92672">(</span>sumRespTime <span style="color:#f92672">/</span> count<span style="color:#f92672">);</span>
      aggregatedStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setCount</span><span style="color:#f92672">(</span>count<span style="color:#f92672">);</span>
      aggregatedStat<span style="color:#f92672">.</span><span style="color:#a6e22e">setTps</span><span style="color:#f92672">(</span>count <span style="color:#f92672">/</span> durationInMillis <span style="color:#f92672">*</span> 1000<span style="color:#f92672">);</span>
      aggregatedStats<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>apiName<span style="color:#f92672">,</span> aggregatedStat<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> aggregatedStats<span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="扩展性">扩展性</h4>
<p>前面我们提到，框架的扩展性有别于代码的扩展性，是从使用者的角度来讲的，特指使用者可以在不修改框架源码，甚至不拿到框架源码的情况下，为框架扩展新的功能。</p>
<p>在刚刚讲到框架的易用性的时候，我们给出了框架如何使用的代码示例。从示例中，我们可以发现，框架在兼顾易用性的同时，也可以灵活地替换各种类对象，比如MetricsStorage、StatViewer。举个例子来说，如果我们要让框架基于HBase来存储原始数据而非Redis，那我们只需要设计一个实现MetricsStorage接口的HBaseMetricsStorage类，传递给MetricsCollector和ConsoleReporter、EmailReporter类即可。</p>
<h4 id="容错性">容错性</h4>
<p>容错性这一点也非常重要。对于这个框架来说，不能因为框架本身的异常导致接口请求出错。所以，对框架可能存在的各种异常情况，我们都要考虑全面。</p>
<p>在现在的框架设计与实现中，采集和存储是异步执行，即便Redis挂掉或者写入超时，也不会影响到接口的正常响应。除此之外，Redis异常，可能会影响到数据统计显示（也就是ConsoleReporter、EmailReporter负责的工作），但并不会影响到接口的正常响应。</p>
<h4 id="通用性">通用性</h4>
<p>为了提高框架的复用性，能够灵活应用到各种场景中，框架在设计的时候，要尽可能通用。我们要多去思考一下，除了接口统计这样一个需求，这个框架还可以适用到其他哪些场景中。比如是否还可以处理其他事件的统计信息，比如SQL请求时间的统计、业务统计（比如支付成功率）等。</p>

</div>


  </main>

  
  
  
  
<script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.14.0/mermaid.min.js"></script>
<script>
    
    Array.from(document.getElementsByClassName("language-mermaid")).forEach(
        (el) => {
            el.parentElement.outerHTML = `<div class="mermaid">${el.innerText}</div>`;
        }
    );
    mermaid.initialize({ startOnLoad: true });
</script>
</body>

</html>